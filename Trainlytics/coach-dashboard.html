<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trainlytics - Coach Dashboard</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .coach-dashboard {
      display: flex;
      height: 100vh;
      background: #ffffff;
    }

    .coach-sidebar {
      width: 250px;
      background: white;
      border-right: 1px solid #000;
      display: flex;
      flex-direction: column;
      padding: 24px 20px;
      overflow-y: auto;
    }

    .coach-profile {
      text-align: center;
      padding-bottom: 20px;
      border-bottom: 1px solid #ddd;
      margin-bottom: 20px;
    }

    .coach-avatar {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: #dcc4f8;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 10px;
      font-size: 36px;
    }

    .coach-name {
      font-weight: bold;
      font-size: 13px;
      margin-bottom: 4px;
      text-transform: uppercase;
      font-family: Arial, sans-serif;
      letter-spacing: 0.5px;
    }

    .coach-sport {
      font-size: 11px;
      color: #666;
      margin-bottom: 12px;
      text-transform: uppercase;
      font-family: Arial, sans-serif;
    }

    .manage-account-btn {
      background: #b8bcc4;
      border: none;
      padding: 10px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 11px;
      font-weight: bold;
      text-transform: uppercase;
      font-family: Arial, sans-serif;
      letter-spacing: 0.5px;
    }

    .manage-account-btn:hover {
      background: #a9adb5;
    }

    .coach-nav {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .nav-section {
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    .nav-item {
      padding: 8px 0;
      cursor: pointer;
      border-radius: 0;
      font-size: 16px;
      text-align: left;
      transition: color 0.2s;
      font-family: Arial, sans-serif;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #000;
    }

    .nav-item:hover {
      background: none;
      color: #9333ea;
    }

    .nav-item.active {
      background: none;
      color: #000;
      font-weight: bold;
    }

    .sign-out-btn {
      background: #b8bcc4;
      border: none;
      padding: 10px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-weight: bold;
      text-transform: uppercase;
      font-size: 11px;
      margin-top: auto;
      font-family: Arial, sans-serif;
      letter-spacing: 0.5px;
    }

    .sign-out-btn:hover {
      background: #a9adb5;
    }

    /* Session Members Section */
    .session-members-section {
      display: none;
      width: 100%;
      margin-bottom: 20px;
    }

    .session-members-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
    }

    .session-members-title {
      font-size: 42px;
      font-weight: 700;
      color: #000;
      margin: 0;
      letter-spacing: 3px;
      font-family: Arial, sans-serif;
      text-transform: uppercase;
    }

    .back-to-sessions-btn {
      background: #6C63FF;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
    }

    .back-to-sessions-btn:hover {
      background: #5a52d5;
    }

    .member-card {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 0;
      cursor: pointer;
      transition: background 0.2s;
      border-bottom: 1px solid #eee;
    }

    .member-card:hover {
      background: #f9f9f9;
      border-radius: 4px;
      padding: 12px;
    }

    .member-card:last-child {
      border-bottom: none;
    }

    .member-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #6C63FF;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }

    .member-info {
      flex: 1;
    }

    .member-name {
      font-weight: bold;
      margin-bottom: 4px;
    }

    .member-email {
      font-size: 12px;
      color: #666;
    }

    /* Athlete Session Data Modal */
    .athlete-data-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 3000;
      align-items: center;
      justify-content: center;
    }

    .athlete-data-content {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .athlete-data-header {
      padding: 20px;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #f8f9fa;
    }

    .athlete-data-body {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-bottom: 20px;
    }

    .stats-group {
      background: #f8f9fa;
      padding: 16px;
      border-radius: 8px;
      border-left: 4px solid #6C63FF;
    }

    .stats-group h4 {
      margin: 0 0 12px 0;
      color: #333;
      font-size: 14px;
      text-transform: uppercase;
      font-weight: bold;
    }

    .stat-field {
      margin-bottom: 12px;
    }

    .stat-field:last-child {
      margin-bottom: 0;
    }

    .stat-field label {
      display: block;
      margin-bottom: 4px;
      font-weight: 500;
      font-size: 13px;
      color: #555;
    }

    .stat-field input, .stat-field select, .stat-field textarea {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }

    .stat-field input[type="number"] {
      text-align: center;
    }

    .stat-field textarea {
      min-height: 60px;
      resize: vertical;
      font-family: inherit;
    }

    .rpe-scale {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
      font-size: 12px;
      color: #666;
    }

    .modal-actions {
      padding: 20px;
      border-top: 1px solid #ddd;
      display: flex;
      gap: 12px;
      background: #f8f9fa;
    }

    .modal-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      font-size: 14px;
    }

    .modal-btn.primary {
      background: #6C63FF;
      color: white;
    }

    .modal-btn.primary:hover {
      background: #5a52d5;
    }

    .modal-btn.secondary {
      background: #e9ecef;
      color: #333;
    }

    .modal-btn.secondary:hover {
      background: #dee2e6;
    }

    .coach-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      padding: 40px;
      background: #ffffff;
    }

    .content-section {
      display: none;
      flex: 1;
      overflow-y: auto;
      padding: 0;
      width: 100%;
      max-width: none;
    }

    .content-section.active {
      display: flex;
      flex-direction: column;
    }

    .teams-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
    }

    .teams-title {
      font-size: 42px;
      font-weight: 700;
      color: #000;
      margin: 0;
      letter-spacing: 3px;
      font-family: Arial, sans-serif;
      text-transform: uppercase;
    }

    .add-circle-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: #fff;
      border: 2px solid #000;
      font-size: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      line-height: 1;
      padding: 0;
      font-weight: 300;
    }

    .add-circle-btn:hover {
      background: #000;
      color: #fff;
      transform: rotate(90deg);
    }

    .teams-search-container {
      margin-bottom: 32px;
      display: flex;
      justify-content: flex-start;
    }

    .teams-search-input {
      width: auto;
      min-width: 600px;
      padding: 12px 16px;
      border: 1px solid #ccc;
      border-radius: 20px;
      font-size: 13px;
      outline: none;
      transition: border-color 0.2s;
      background: #e8e8f0;
    }

    .teams-search-input:focus {
      border-color: #999;
      background: #fff;
    }

    .teams-search-input::placeholder {
      color: #999;
    }

    .teams-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .team-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      background: #fff;
      border: 2px solid #000;
      border-radius: 16px;
      transition: all 0.2s;
      cursor: pointer;
    }

    .team-item:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transform: translateY(-2px);
    }

    .team-item-image {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      object-fit: cover;
      background: #f5f5f5;
      flex-shrink: 0;
    }

    .team-item-content {
      flex: 1;
    }

    .team-item-name {
      font-size: 18px;
      font-weight: 700;
      color: #000;
      margin-bottom: 4px;
      letter-spacing: 1px;
      font-family: Arial, sans-serif;
      text-transform: uppercase;
    }

    .team-item-participants {
      font-size: 13px;
      color: #666;
      font-weight: 400;
      font-family: Arial, sans-serif;
      text-transform: uppercase;
    }

    .team-item-actions {
      display: flex;
      gap: 12px;
    }

    .team-action-btn {
      width: 40px;
      height: 40px;
      border: 2px solid #000;
      background: #fff;
      border-radius: 8px;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      padding: 0;
    }

    .team-action-btn:hover {
      background: #f5f5f5;
      transform: scale(1.08);
    }

    .training-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .training-title {
      font-size: 18px;
      font-weight: bold;
      text-transform: uppercase;
      margin: 0;
      font-family: Arial, sans-serif;
    }

    .training-controls {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .training-search-input {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    .training-toggle-btn {
      padding: 8px 16px;
      background: #6C63FF;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      font-size: 12px;
      text-transform: uppercase;
    }

    .training-toggle-btn:hover {
      background: #5a52d5;
    }

    .training-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 16px;
      margin-bottom: 30px;
    }

    .training-card {
      background: white;
      border: 2px solid #f0f0f0;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }
    
    .training-card:hover {
      border-color: #FF6B35;
      box-shadow: 0 8px 24px rgba(255, 107, 53, 0.15);
      transform: translateY(-2px);
    }
    
    .training-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #FF6B35, #F7931E);
    }

    .training-card-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 12px;
      color: #333;
    }

    .training-card-info {
      font-size: 14px;
      color: #666;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .training-card-info strong {
      color: #333;
      min-width: 60px;
      font-weight: 500;
    }

    .training-card-actions {
      display: flex;
      gap: 10px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #f0f0f0;
    }

    .training-card-btn {
      flex: 1;
      padding: 10px 16px;
      border: 2px solid #e0e0e0;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }

    .training-card-btn:hover {
      background: #f8f9fa;
      border-color: #FF6B35;
      color: #FF6B35;
    }
    
    .training-card-btn.view {
      background: #FF6B35;
      border-color: #FF6B35;
      color: white;
    }
    
    .training-card-btn.view:hover {
      background: #e55a2b;
      border-color: #e55a2b;
      color: white;
    }

    .training-card-btn.delete {
      background: #dc3545;
      color: white;
      border-color: #dc3545;
    }

    .training-card-btn.delete:hover {
      background: #c82333;
      border-color: #c82333;
    }

    .training-form {
      background: white;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 4px;
      max-width: 600px;
      display: none;
    }

    .training-form.active {
      display: block;
    }

    .training-form-title {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 20px;
      text-transform: uppercase;
      font-family: Arial, sans-serif;
    }

    .form-group {
      margin-bottom: 20px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .form-label {
      font-size: 12px;
      font-weight: bold;
      text-transform: uppercase;
      font-family: Arial, sans-serif;
      color: #333;
      text-align: left;
    }

    .form-input {
      padding: 10px;
      border: 1px solid #333;
      border-radius: 4px;
      font-size: 14px;
      font-family: inherit;
    }

    .form-input:focus {
      outline: none;
      border-color: #6C63FF;
    }

    .form-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .competition-filter {
      background: none;
      border: none;
      padding: 8px 16px;
      font-family: Arial, sans-serif;
      font-size: 14px;
      cursor: pointer;
      color: #666;
      border-bottom: 2px solid transparent;
    }

    .competition-filter.active {
      color: #000;
      border-bottom: 2px solid #000;
      font-weight: bold;
    }

    .competition-card {
      border: 1px solid #333;
      border-radius: 12px;
      padding: 24px;
      display: flex;
      align-items: center;
      gap: 32px;
      position: relative;
    }

    .competition-team {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    .competition-team-avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 20px;
    }

    .competition-team-name {
      font-family: Arial, sans-serif;
      font-weight: bold;
      font-size: 16px;
    }

    .competition-details {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
      text-align: center;
    }

    .competition-name {
      font-family: Arial, sans-serif;
      font-weight: bold;
      font-size: 20px;
      text-transform: uppercase;
    }

    .competition-info {
      font-family: Arial, sans-serif;
      font-size: 14px;
      color: #666;
    }

    .competition-actions {
      position: absolute;
      top: 16px;
      right: 16px;
      display: flex;
      gap: 8px;
    }

    .competition-action-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 18px;
      padding: 4px 8px;
      color: #666;
    }

    .competition-action-btn:hover {
      color: #000;
    }

    .form-button {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      text-transform: uppercase;
      font-size: 12px;
    }

    .form-button.save {
      background: #6C63FF;
      color: white;
      border-color: #6C63FF;
    }

    .form-button.save:hover {
      background: #5a52d5;
    }

    .form-button.cancel {
      background: #f0f0f0;
    }

    .form-button.cancel:hover {
      background: #e0e0e0;
    }

    .member-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      margin: 10px 0;
    }

    .member-option {
      padding: 10px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 4px;
      text-align: center;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }

    .member-option:hover {
      border-color: #6C63FF;
      background: #f0f0ff;
    }

    .member-option.selected {
      background: #6C63FF;
      color: white;
      border-color: #6C63FF;
    }

    .team-card {
      background: white;
      border: 1px solid #ddd;
      padding: 16px;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .team-card:hover {
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .team-card-title {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 8px;
    }

    .team-card-count {
      font-size: 13px;
      color: #666;
    }

    .modal-backdrop {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-backdrop.active {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 4px;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
    }

    .modal-close-btn {
      float: right;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
    }

    .modal-close-btn:hover {
      color: #000;
    }

    .modal-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 20px;
      text-transform: uppercase;
      font-family: Arial, sans-serif;
      clear: both;
    }

    .schedule-title {
      font-size: 42px;
      font-weight: 700;
      color: #000;
      margin: 0 0 20px 0;
      letter-spacing: 3px;
      text-transform: uppercase;
      font-family: Arial, sans-serif;
    }

    .schedule-container {
      flex: 1;
      overflow-y: visible;
    }

    .calendar {
      width: 100%;
      border-collapse: collapse;
    }

    .calendar th,
    .calendar td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
    }

    .calendar td.today {
      background: #6C63FF;
      color: white;
      font-weight: bold;
    }

    /* Enhanced Statistics Styles */
    #statistics.content-section {
      background: transparent;
      padding: 0;
    }
    
    /* Force full width for athlete stats view */
    #member-stats-detail-view {
      width: 100% !important;
      max-width: none !important;
    }
    
    /* Ensure chart containers use full available space */
    #member-stats-detail-view > div:not(.detail-header) {
      width: 100% !important;
      max-width: none !important;
    }

    #statistics .schedule-container {
      background: transparent;
      padding: 0;
      margin: 0;
      border: none;
      box-shadow: none;
      width: 100%;
      max-width: none;
    }
    
    .stats-date-filter {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 30px;
    }

    .date-range-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      padding: 12px 20px;
      border-radius: 25px;
      font-family: Arial, sans-serif;
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      cursor: pointer;
      color: white;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .date-range-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    /* Teams Overview Styles */
    .stats-overview-header {
      text-align: center;
      margin-bottom: 40px;
    }

    .stats-overview-header h3 {
      font-size: 24px;
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
      font-family: Arial, sans-serif;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .stats-overview-header p {
      font-size: 16px;
      color: #666;
      margin: 0;
      font-family: Arial, sans-serif;
    }

    .clean-teams-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 24px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .clean-team-card {
      background: linear-gradient(135deg, #fff 0%, #f8f9ff 100%);
      border-radius: 16px;
      padding: 24px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      border: 2px solid transparent;
      position: relative;
      z-index: 10;
      pointer-events: auto;
    }

    .clean-team-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
      border-color: #667eea;
    }

    .team-card-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 16px;
    }

    .team-card-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      overflow: hidden;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: white;
      font-weight: bold;
    }

    .team-card-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .team-card-info h4 {
      font-size: 18px;
      font-weight: bold;
      color: #333;
      margin: 0;
      font-family: Arial, sans-serif;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .team-card-info p {
      font-size: 14px;
      color: #666;
      margin: 4px 0 0 0;
      font-family: Arial, sans-serif;
    }

    /* Team Detail View Styles */
    .team-detail-header {
      margin-bottom: 30px;
    }

    .team-header-info {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 20px;
      margin-top: 20px;
    }

    .team-header-info h2 {
      margin: 0;
      font-size: 32px;
      font-weight: bold;
      color: #333;
      font-family: Arial, sans-serif;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .team-quick-stats {
      display: flex;
      gap: 30px;
    }

    .quick-stat-item {
      text-align: center;
      min-width: 100px;
    }

    .stat-label {
      display: block;
      font-size: 12px;
      color: #666;
      text-transform: uppercase;
      font-weight: 600;
      margin-bottom: 4px;
      font-family: Arial, sans-serif;
      letter-spacing: 0.5px;
    }

    .stat-value {
      display: block;
      font-size: 24px;
      color: #667eea;
      font-weight: bold;
      font-family: Arial, sans-serif;
    }

    .stats-back-btn {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      border: none;
      font-size: 14px;
      color: white;
      cursor: pointer;
      padding: 10px 16px;
      border-radius: 20px;
      font-family: Arial, sans-serif;
      font-weight: 600;
      text-transform: uppercase;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(240, 147, 251, 0.3);
    }

    .stats-back-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(240, 147, 251, 0.4);
    }

    /* Team Overview Statistics */
    .team-overview-stats {
      margin: 40px 0;
    }

    .team-overview-stats h3 {
      font-size: 20px;
      font-weight: bold;
      color: #333;
      margin-bottom: 24px;
      font-family: Arial, sans-serif;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .team-stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }

    /* New single column layout for wider charts */
    .team-stats-single-column {
      display: flex;
      flex-direction: column;
      gap: 32px;
    }

    .team-stat-card {
      background: linear-gradient(135deg, #fff 0%, #f8f9ff 100%);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }

    .team-stat-card-wide {
      background: linear-gradient(135deg, #fff 0%, #f8f9ff 100%);
      border-radius: 16px;
      padding: 32px;
      box-shadow: 0 6px 25px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
    }

    .team-stat-card h4, .team-stat-card-wide h4 {
      font-size: 18px;
      font-weight: bold;
      color: #333;
      margin-bottom: 24px;
      font-family: Arial, sans-serif;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Team Members Section */
    .team-members-section {
      margin: 40px 0;
    }

    .team-members-section h3 {
      font-size: 20px;
      font-weight: bold;
      color: #333;
      margin-bottom: 24px;
      font-family: Arial, sans-serif;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .members-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .member-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: white;
      border-radius: 12px;
      padding: 16px 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.06);
    }

    .member-row:hover {
      transform: translateX(5px);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.12);
      background: linear-gradient(135deg, #fff 0%, #f8f9ff 100%);
    }

    .member-info {
      display: flex;
      align-items: center;
      gap: 16px;
      flex: 1;
    }

    .member-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: white;
      font-weight: bold;
    }

    .member-details {
      flex: 1;
    }

    .member-name {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      margin-bottom: 2px;
      font-family: Arial, sans-serif;
    }

    .member-student-id {
      font-size: 12px;
      color: #666;
      font-family: Arial, sans-serif;
      text-transform: uppercase;
    }

    .view-stats-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      cursor: pointer;
      font-family: Arial, sans-serif;
      transition: all 0.3s ease;
      box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
    }

    .view-stats-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    /* Individual Member Statistics Styles */
    .member-detail-header {
      margin-bottom: 40px;
    }

    .member-header-info {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-top: 20px;
    }

    #memberAvatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: white;
      font-weight: bold;
      box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
    }

    .member-info h2 {
      margin: 0;
      font-size: 28px;
      font-weight: bold;
      color: #333;
      font-family: Arial, sans-serif;
      text-transform: uppercase;
      letter-spacing: 1.5px;
    }

    .member-basic-info {
      display: flex;
      gap: 20px;
      margin-top: 8px;
    }

    .info-item {
      font-size: 14px;
      color: #666;
      font-family: Arial, sans-serif;
    }

    /* Individual Graphs Section */
    .individual-graphs-section {
      margin: 40px 0;
    }

    .individual-graphs-section h3 {
      font-size: 24px;
      font-weight: bold;
      color: #333;
      margin-bottom: 30px;
      font-family: Arial, sans-serif;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .individual-graph-card {
      background: linear-gradient(135deg, #fff 0%, #f8f9ff 100%);
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
      border: 1px solid rgba(102, 126, 234, 0.1);
    }

    .graph-header {
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid rgba(102, 126, 234, 0.1);
    }

    .graph-header h4 {
      font-size: 20px;
      font-weight: bold;
      color: #333;
      margin-bottom: 8px;
      font-family: Arial, sans-serif;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .graph-header p {
      font-size: 14px;
      color: #666;
      margin: 0;
      font-family: Arial, sans-serif;
      font-style: italic;
    }

    .graph-content {
      position: relative;
    }

    .graph-placeholder {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 300px;
      color: #999;
      font-size: 16px;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 12px;
      font-family: Arial, sans-serif;
      font-style: italic;
    }

    /* Training Sessions Summary */
    .training-sessions-summary {
      margin: 40px 0;
    }

    .training-sessions-summary h3 {
      font-size: 20px;
      font-weight: bold;
      color: #333;
      margin-bottom: 24px;
      font-family: Arial, sans-serif;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .sessions-table {
      background: white;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }

    .session-row {
      display: grid;
      grid-template-columns: 1fr 1.5fr 0.8fr 0.8fr 0.8fr 0.8fr 0.8fr;
      padding: 16px 20px;
      border-bottom: 1px solid #f0f0f0;
      font-family: Arial, sans-serif;
      font-size: 14px;
    }

    .session-row:first-child {
      background: linear-gradient(135deg, #f8f9ff 0%, #e9ecef 100%);
      font-weight: bold;
      color: #333;
      text-transform: uppercase;
      font-size: 12px;
      letter-spacing: 0.5px;
    }

    .session-row:last-child {
      border-bottom: none;
    }

    .session-row:not(:first-child):hover {
      background: rgba(102, 126, 234, 0.05);
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .graphs-row {
        grid-template-columns: 1fr;
      }
      
      .members-stats-header,
      .member-stats-row {
        grid-template-columns: 1fr;
        text-align: center;
      }
      
      .player-stats-header,
      .player-stats-row {
        font-size: 12px;
        grid-template-columns: repeat(8, 1fr);
      }
    }
    /* Member Stats Cards */
    .members-stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      padding: 20px;
    }
    
    .member-stats-card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      cursor: pointer;
      border: 2px solid transparent;
    }
    
    .member-stats-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
      border-color: #FF6B35;
    }
    
    .member-stats-header {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .member-stats-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #FF6B35, #F7931E);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 16px;
      margin-right: 12px;
    }
    
    .member-stats-info h4 {
      margin: 0;
      font-size: 16px;
      color: #333;
      font-weight: 600;
    }
    
    .member-stats-info .member-status {
      font-size: 12px;
      color: #666;
      margin: 2px 0 0 0;
    }
    
    .stats-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 8px;
    }
    
    .stat-item {
      text-align: center;
      padding: 6px;
      background: #f8f9fa;
      border-radius: 6px;
    }
    
    .stat-label {
      font-size: 10px;
      color: #666;
      text-transform: uppercase;
      font-weight: 600;
      margin-bottom: 2px;
    }
    
    .stat-value {
      font-size: 16px;
      font-weight: bold;
      color: #333;
    }
    
    .no-data-card {
      background: #f8f9fa;
      border: 2px dashed #ddd;
      color: #666;
      text-align: center;
      padding: 20px;
    }
    
    @media (max-width: 1200px) {
      .members-stats-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    
    @media (max-width: 900px) {
      .members-stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (max-width: 600px) {
      .members-stats-grid {
        grid-template-columns: 1fr;
      }
    }

  </style>
</head>
<body>
  <div class="coach-dashboard">
    <!-- Sidebar -->
    <div class="coach-sidebar">
      <!-- Profile Section -->
      <div class="coach-profile" id="profileSection" style="display: none;">
        <div class="coach-avatar" id="coachAvatar">
          <img id="avatarImage" style="display: none; width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" />
          <span id="avatarFallback">üë®‚Äçüè´</span>
        </div>
        <div class="coach-name" id="coachName">COACH NAME</div>
        <div class="coach-sport" id="coachSport">SPORT</div>
        <button class="manage-account-btn" onclick="window.location.href='manage-profile.html'">Manage Account</button>
      </div>

      <!-- Navigation -->
      <nav class="coach-nav">
        <div class="nav-section">
          <div class="nav-item active" data-section="home">Home</div>
          <div class="nav-item" data-section="teams">Teams</div>
          <div class="nav-item" data-section="training">Training</div>
          <div class="nav-item" data-section="competition">Competition</div>
          <div class="nav-item" data-section="statistics">Statistics</div>
        </div>
      </nav>

      <!-- Sign Out -->
      <button class="sign-out-btn" id="signOutBtn">Sign Out</button>
    </div>

    <!-- Main Content -->
    <div class="coach-content">
      <!-- Home Section -->
      <div class="content-section active" id="home">
        <div class="schedule-title">SCHEDULE</div>
        
        <div class="schedule-container">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
            <button id="prevMonthBtn" style="background:none; border:none; font-size:24px; cursor:pointer; padding:8px;">‚Äπ</button>
            <div class="month-header" id="monthHeader">November 2025</div>
            <button id="nextMonthBtn" style="background:none; border:none; font-size:24px; cursor:pointer; padding:8px;">‚Ä∫</button>
          </div>
          <table class="calendar" id="calendar">
            <thead>
              <tr>
                <th>Sun</th>
                <th>Mon</th>
                <th>Tue</th>
                <th>Wed</th>
                <th>Thu</th>
                <th>Fri</th>
                <th>Sat</th>
              </tr>
            </thead>
            <tbody id="calendarBody"></tbody>
          </table>
          
          <div id="selectedDateEvents" style="margin-top:20px; padding:16px; background:#f9f9f9; border-radius:8px; display:none;">
            <h3 style="margin:0 0 12px 0; font-size:16px;">Events on <span id="selectedDateTitle"></span></h3>
            <div id="selectedDateEventsList"></div>
          </div>
        </div>

        <div class="reminders-title">Reminders</div>
        <div class="reminders-box" id="remindersBox">
          <div id="remindersList" class="reminders-list"></div>
          <button class="add-reminder-btn" id="addReminderBtn">Add Reminder</button>
        </div>
      </div>

      <!-- Teams Section -->
      <div id="teams" class="content-section">
        <div class="teams-header">
          <h1 class="teams-title">TEAMS</h1>
          <button class="add-circle-btn" id="addTeamCircleBtn" title="Add New Team">‚äï</button>
        </div>
        
        <div class="teams-search-container">
          <input type="text" class="teams-search-input" placeholder="Search Team Name" id="teamsSearchInput" />
        </div>
        
        <div class="teams-list" id="teamsList">
          <!-- Teams will be loaded dynamically -->
        </div>
      </div>

      <!-- Add Team Section (Create New Team) -->
      <div id="addTeam" class="content-section">
        <div style="display:flex; align-items:center; margin-bottom:20px;">
          <button id="backToTeamsFromAddBtn" style="background:none; border:none; font-size:24px; cursor:pointer; padding:0; margin-right:12px;">‚Üê</button>
          <h2 class="add-team-title" style="margin:0;">Make A New Team!</h2>
        </div>
        
        <div class="add-team-container">
          <div class="add-team-form">
            <div class="add-team-layout">
              <div class="add-team-left">
                <div class="form-group">
                  <label class="form-label">Name</label>
                  <input type="text" id="teamNameInput" class="form-input" placeholder="Enter team name" />
                </div>
                
                <div class="form-group">
                  <label class="form-label">Add Members</label>
                  <div class="member-search-container">
                    <input type="text" id="memberSearchInput" class="member-search-input" placeholder="Search By Name" />
                  </div>
                  
                  <div class="members-grid" id="membersGrid">
                    <!-- Athletes will be loaded dynamically -->
                  </div>
                </div>
              </div>
              
              <div class="add-team-right">
                <div class="team-image-upload">
                  <input type="file" id="teamImageInput" accept="image/*" style="display:none;" />
                  <div class="upload-circle" id="uploadCircle">
                    <img id="teamPreviewImage" style="display:none; width:100%; height:100%; border-radius:50%; object-fit:cover;" />
                    <span class="upload-icon" id="uploadIcon">üë§</span>
                  </div>
                </div>
              </div>
            </div>
            
            <button class="upload-btn" id="createTeamBtn">Upload</button>
          </div>
        </div>
      </div>

        <!-- Team Details Section (Edit Existing Team) -->
        <div id="teamDetails" class="content-section">
          <div style="display:flex; align-items:center; margin-bottom:20px;">
            <button id="backToTeamsBtn" style="background:none; border:none; font-size:24px; cursor:pointer; padding:0; margin-right:12px;">‚Üê</button>
            <h2 class="add-team-title" id="teamDetailsTitle" style="margin:0;">Team Details</h2>
          </div>
          
          <div class="add-team-container">
            <div class="add-team-form">
              <div class="add-team-layout">
                <div class="add-team-left">
                  <div class="form-group">
                    <label class="form-label">Name</label>
                    <input type="text" id="teamDetailsNameInput" class="form-input" placeholder="Enter team name" />
                  </div>
                  
                  <div class="form-group">
                    <label class="form-label">Add Members</label>
                    <div class="member-search-container">
                      <input type="text" id="teamDetailsMemberSearch" class="member-search-input" placeholder="Search By Name" />
                    </div>
                    
                    <div class="members-grid" id="teamDetailsMembersGrid">
                      <!-- Athletes will be loaded dynamically -->
                    </div>
                  </div>
                </div>
                
                <div class="add-team-right">
                  <div class="team-image-upload">
                    <input type="file" id="teamDetailsImageInput" accept="image/*" style="display:none;" />
                    <div class="upload-circle" id="teamDetailsUploadCircle">
                      <img id="teamDetailsPreviewImage" style="display:none; width:100%; height:100%; border-radius:50%; object-fit:cover;" />
                      <span class="upload-icon" id="teamDetailsUploadIcon">üë§</span>
                    </div>
                  </div>
                </div>
              </div>
              
              <div style="display:flex; gap:12px; justify-content:flex-end; margin-top:20px;">
                <button class="upload-btn" id="teamDetailsDeleteBtn" style="background:#dc3545;">Delete Team</button>
                <button class="upload-btn" id="teamDetailsUpdateBtn">Update</button>
              </div>
            </div>
          </div>
        </div>

      <!-- Add Team Section -->
      <!-- Training Section -->
      <div id="training" class="content-section">
        
        <!-- Session Members Section -->
        <div id="sessionMembersSection" class="session-members-section">
          <div class="session-members-header">
            <h3 id="sessionMembersTitle" class="session-members-title">Training Session Members</h3>
            <button id="backToSessionsBtn" class="back-to-sessions-btn">‚Üê Back to Sessions</button>
          </div>
          <div id="sessionMembersList">
            <!-- Members will be loaded here -->
          </div>
        </div>

        <!-- Training List View -->
        <div id="trainingListView" class="schedule-container">
          <div class="schedule-title">TRAINING SESSION</div>
          
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; padding-bottom:16px; border-bottom:2px solid #1e1e1e;">
            <div style="display:flex; gap:20px; font-size:14px;">
              <span class="training-filter-btn active" data-filter="all" style="cursor:pointer; font-weight:600;">All</span>
              <span style="cursor:default;">|</span>
              <span class="training-filter-btn" data-filter="upcoming" style="cursor:pointer;">Upcoming</span>
              <span style="cursor:default;">|</span>
              <span class="training-filter-btn" data-filter="completed" style="cursor:pointer;">Completed</span>
              <span style="cursor:default;">|</span>
              <span class="training-filter-btn" data-filter="in-progress" style="cursor:pointer;">In Progress</span>
            </div>
            <button id="addTrainingSessionBtn" style="background:none; border:none; font-size:32px; cursor:pointer; padding:0; color:#333;">‚äï</button>
          </div>

          <div style="display:flex; gap:16px; margin-bottom:24px; align-items:center;">
            <span style="font-size:14px;">Sort By</span>
            <input type="text" id="sessionSearchInput" placeholder="Search Session Name" style="padding:8px 12px; border:1px solid #ddd; border-radius:4px; font-size:14px; flex:1; max-width:300px;" />
          </div>

          <div id="trainingSessionsList" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(260px, 1fr)); gap:20px; margin-top:20px;">
            <!-- Training sessions will load here -->
          </div>
        </div>

        <!-- Add Training Session Form -->
        <div id="addTrainingView" style="display:none;">
          <div style="display:flex; align-items:center; gap:12px; margin-bottom:24px;">
            <button id="backToTrainingListBtn" style="background:none; border:none; font-size:24px; cursor:pointer; padding:8px;">‚Üê</button>
            <h2 class="teams-title">CREATE TRAINING SESSION</h2>
          </div>
          
          <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:32px;">
            <div class="form-group">
              <label class="form-label">Session Name</label>
              <input type="text" id="sessionNameInput" class="form-input" placeholder="e.g., Strength Training" />
            </div>

            <div class="form-group">
              <label class="form-label">Date</label>
              <input type="date" id="sessionDateInput" class="form-input" />
            </div>

            <div class="form-group">
              <label class="form-label">Time</label>
              <input type="time" id="sessionTimeInput" class="form-input" />
            </div>

            <div class="form-group">
              <label class="form-label">Duration (minutes)</label>
              <input type="number" id="sessionDurationInput" class="form-input" placeholder="60" />
            </div>

            <div class="form-group">
              <label class="form-label">Location</label>
              <div style="display:flex; gap:8px;">
                <input type="text" id="sessionLocationInput" class="form-input" placeholder="e.g., Main Field or search for a place..." style="flex:1;" />
                <button type="button" id="openMapBtn" style="background:#6C63FF; color:white; border:none; padding:0 20px; border-radius:8px; cursor:pointer; font-weight:bold; white-space:nowrap;">üìç Map</button>
              </div>
              <input type="hidden" id="sessionLocationLat" />
              <input type="hidden" id="sessionLocationLng" />
            </div>

            <div class="form-group">
              <label class="form-label">Select Team</label>
              <select id="sessionTeamSelect" class="form-input">
                <option value="">Choose a team...</option>
                <!-- Teams will load here -->
              </select>
            </div>

            <div class="form-group">
              <label class="form-label">Description</label>
              <textarea id="sessionDescriptionInput" class="form-input" placeholder="Training details..." style="min-height:100px; width:200%; max-width:1000px; resize:none; font-family:inherit;"></textarea>
            </div>

            <div style="display:flex; gap:12px;">
              <button id="saveSessionBtn" style="flex:1; background-color:#6C63FF; color:white; border:none; padding:12px; border-radius:8px; margin-top: 300px;cursor:pointer; font-weight:bold;">SAVE SESSION</button>
              <button id="cancelSessionBtn" style="flex:1; background-color:#ddd; color:#333; border:none; padding:12px; border-radius:8px; margin-top: 300px;cursor:pointer; font-weight:bold;">CANCEL</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Map Modal -->
      <div id="mapModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:2000; align-items:center; justify-content:center;">
        <div style="background:white; border-radius:12px; width:90%; max-width:800px; max-height:90vh; display:flex; flex-direction:column;">
          <div style="padding:20px; border-bottom:1px solid #ddd; display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0;">Select Location on Map</h3>
            <button id="closeMapBtn" style="background:none; border:none; font-size:28px; cursor:pointer; color:#666;">&times;</button>
          </div>
          <div style="padding:16px;">
            <input type="text" id="mapSearchInput" placeholder="Search for a location..." style="width:100%; padding:12px; border:1px solid #ddd; border-radius:6px; font-size:14px; margin-bottom:12px;" />
          </div>
          <div id="map" style="flex:1; min-height:400px;"></div>
          <div style="padding:16px; border-top:1px solid #ddd; display:flex; gap:12px;">
            <button id="confirmLocationBtn" style="flex:1; background:#6C63FF; color:white; border:none; padding:12px; border-radius:6px; font-weight:600; cursor:pointer;">CONFIRM LOCATION</button>
            <button id="cancelMapBtn" style="flex:1; background:#ddd; color:#333; border:none; padding:12px; border-radius:6px; font-weight:600; cursor:pointer;">CANCEL</button>
          </div>
        </div>
      </div>

      <!-- Athlete Session Data Modal -->
      <div id="athleteDataModal" class="athlete-data-modal">
        <div class="athlete-data-content">
          <div class="athlete-data-header">
            <div>
              <h3 id="athleteDataTitle" style="margin: 0; font-size: 18px;">Athlete Session Data</h3>
              <p id="athleteDataSubtitle" style="margin: 4px 0 0 0; font-size: 14px; color: #666;">Enter performance data for this training session</p>
            </div>
            <button class="modal-close" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
          </div>
          
          <div class="athlete-data-body">
            <form id="athleteDataForm">
              <div class="stats-grid">
                <!-- Performance Stats -->
                <div class="stats-group">
                  <h4>Performance Stats</h4>
                  <div class="stat-field">
                    <label for="points">Points Scored</label>
                    <input type="number" id="points" name="points" min="0" placeholder="0">
                  </div>
                  <div class="stat-field">
                    <label for="rebounds">Rebounds</label>
                    <input type="number" id="rebounds" name="rebounds" min="0" placeholder="0">
                  </div>
                  <div class="stat-field">
                    <label for="assists">Assists</label>
                    <input type="number" id="assists" name="assists" min="0" placeholder="0">
                  </div>
                  <div class="stat-field">
                    <label for="turnovers">Turnovers</label>
                    <input type="number" id="turnovers" name="turnovers" min="0" placeholder="0">
                  </div>
                  <div class="stat-field">
                    <label for="fouls">Fouls</label>
                    <input type="number" id="fouls" name="fouls" min="0" placeholder="0">
                  </div>
                </div>

                <!-- Session Data -->
                <div class="stats-group">
                  <h4>Session Data</h4>
                  <div class="stat-field">
                    <label for="rpe">RPE (Rating of Perceived Exertion)</label>
                    <input type="number" id="rpe" name="rpe" min="1" max="10" placeholder="5">
                    <div class="rpe-scale">
                      <span>1 - Very Easy</span>
                      <span>5 - Moderate</span>
                      <span>10 - Maximum</span>
                    </div>
                  </div>
                  <div class="stat-field">
                    <label for="attendance">Attendance Status</label>
                    <select id="attendance" name="attendance">
                      <option value="Present">Present</option>
                      <option value="Absent">Absent</option>
                      <option value="Injured">Injured</option>
                      <option value="Late">Late</option>
                      <option value="Left Early">Left Early</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- Coach Notes -->
              <div class="stats-group" style="grid-column: 1 / -1;">
                <h4>Coach's Notes</h4>
                <div class="stat-field">
                  <label for="notes">Performance Notes & Feedback</label>
                  <textarea id="notes" name="notes" placeholder="Add specific notes about this athlete's performance, areas for improvement, highlights, etc."></textarea>
                </div>
              </div>
            </form>
          </div>

          <div class="modal-actions">
            <button id="saveAthleteData" class="modal-btn primary">Save Session Data</button>
            <button id="cancelAthleteData" class="modal-btn secondary">Cancel</button>
          </div>
        </div>
      </div>

      <!-- Competition Section -->
      <div id="competition" class="content-section">
        <div id="competitionListView">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
            <h2 class="teams-title">COMPETITIONS</h2>
            <button id="addCompetitionBtn" style="background-color:#6C63FF; color:white; border:none; padding:12px 24px; border-radius:8px; cursor:pointer; font-weight:bold;">+ ADD COMPETITION</button>
          </div>

          <div style="display:flex; gap:16px; margin-bottom:24px;">
            <button class="competition-filter active" data-filter="all">All</button>
            <button class="competition-filter" data-filter="upcoming">Upcoming</button>
            <button class="competition-filter" data-filter="completed">Completed</button>
          </div>

          <div id="competitionsList" style="display:flex; flex-direction:column; gap:16px;">
            <!-- Competitions will load here -->
          </div>
        </div>

        <!-- Add Competition Form -->
        <div id="addCompetitionView" style="display:none;">
          <div style="display:flex; align-items:center; gap:12px; margin-bottom:24px;">
            <button id="backToCompetitionListBtn" style="background:none; border:none; font-size:24px; cursor:pointer; padding:8px;">‚Üê</button>
            <h2 class="teams-title">CREATE COMPETITION</h2>
          </div>
          
          <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:32px;">
            <div class="form-group">
              <label class="form-label">Competition Name</label>
              <input type="text" id="compNameInput" class="form-input" placeholder="e.g., Final Match" />
            </div>

            <div class="form-group">
              <label class="form-label">Date</label>
              <input type="date" id="compDateInput" class="form-input" />
            </div>

            <div class="form-group">
              <label class="form-label">Time</label>
              <input type="time" id="compTimeInput" class="form-input" />
            </div>

            <div class="form-group">
              <label class="form-label">Location</label>
              <input type="text" id="compLocationInput" class="form-input" placeholder="e.g., Da'an Sport Center" />
            </div>

            <div class="form-group">
              <label class="form-label">Team 1 (Your Team)</label>
              <select id="compTeam1Input" class="form-input">
                <option value="">Select your team...</option>
                <!-- Teams will load here -->
              </select>
            </div>

            <div class="form-group">
              <label class="form-label">Team 2 (Opponent)</label>
              <input type="text" id="compTeam2Input" class="form-input" placeholder="e.g., Opponent Team Name" />
            </div>
          </div>

          <div style="display:flex; gap:12px; margin-top:32px;">
            <button id="saveCompetitionBtn" style="flex:1; background-color:#6C63FF; color:white; border:none; padding:12px; border-radius:8px; cursor:pointer; font-weight:bold;">SAVE COMPETITION</button>
            <button id="cancelCompetitionBtn" style="flex:1; background-color:#ddd; color:#333; border:none; padding:12px; border-radius:8px; cursor:pointer; font-weight:bold;">CANCEL</button>
          </div>
        </div>
      </div>

      <!-- Statistics Section -->
      <div id="statistics" class="content-section">
        <div class="schedule-title">
          Team Performance Analytics
        </div>
        <div class="schedule-container">

          <!-- Teams Overview View -->
          <div id="teams-overview-view" class="stats-view">
            <div class="stats-overview-header">
              <h3>Select a Team to View Statistics</h3>
            </div>
            <div class="clean-teams-grid" id="cleanTeamsList">
              <!-- Teams will be populated here -->
            </div>
          </div>

          <!-- Team Stats Detail View -->
          <div id="team-stats-detail-view" class="stats-view" style="display: none;">
            <div class="team-detail-header">
              <button class="stats-back-btn" onclick="backToTeamsOverview()">‚Üê Back to Teams</button>
              <div class="team-header-info">
                <h2 id="teamDetailTitle">Team Name</h2>
                <div class="team-quick-stats" id="teamQuickStats">
                  <div class="quick-stat-item">
                    <span class="stat-label">Total Members</span>
                    <span class="stat-value" id="totalMembers">0</span>
                  </div>
                  <div class="quick-stat-item">
                    <span class="stat-label">Avg Performance</span>
                    <span class="stat-value" id="avgTeamPerformance">0.0</span>
                  </div>
                  <div class="quick-stat-item">
                    <span class="stat-label">Training Sessions</span>
                    <span class="stat-value" id="totalSessions">0</span>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Team Overall Statistics -->
            <div class="team-overview-stats">
              <h3>Team Overview Statistics</h3>
              <div class="team-stats-single-column">
                <div class="team-stat-card-wide">
                  <h4>Team Performance Trend</h4>
                  <canvas id="teamPerformanceTrendChart" width="800" height="350"></canvas>
                  <div id="teamTrendPlaceholder" class="graph-placeholder">No training data available yet</div>
                </div>
                <div class="team-stat-card-wide">
                  <h4>Average Team Stats</h4>
                  <canvas id="teamAverageStatsChart" width="800" height="350"></canvas>
                  <div id="teamAvgPlaceholder" class="graph-placeholder">No training data available yet</div>
                </div>
              </div>
            </div>

            <!-- Team Members Section -->
            <div class="team-members-section">
              <h3>Team Members</h3>
              <div class="members-list" id="teamMembersList">
                <!-- Members will be populated here as rows -->
              </div>
            </div>
          </div>

          <!-- Individual Member Statistics View -->
          <div id="member-stats-detail-view" class="stats-view" style="display: none; padding: 40px;">
            <div class="detail-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);">
              <button class="back-button" onclick="backToTeamDetail()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 10px 15px; border-radius: 8px; cursor: pointer; margin-bottom: 15px; font-size: 14px; transition: all 0.3s ease;">
                ‚Üê Back to Team
              </button>
              <div style="display: flex; align-items: center; gap: 20px;">
                <div class="member-avatar-large" id="memberAvatarText" style="width: 60px; height: 60px; border-radius: 50%; background: rgba(255,255,255,0.3); display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold;">M</div>
                <div>
                  <h2 id="memberDetailTitle" style="margin: 0; font-size: 28px; font-weight: 600;">Member Name</h2>
                  <p style="margin: 5px 0; opacity: 0.9; font-size: 16px;">Student ID: <span id="memberStudentId">12345</span></p>
                  <p style="margin: 0; opacity: 0.9; font-size: 16px;">Position: <span id="memberPosition">Player</span></p>
                </div>
              </div>
            </div>

            <!-- Athlete Performance Summary Cards -->
            <div id="athletePerformanceSummary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
              <!-- Summary cards will be populated by JavaScript -->
            </div>

            <!-- Six Performance Charts - Full Width Layout -->
            <div style="display: flex; flex-direction: column; gap: 25px; margin-bottom: 30px;">
              
              <!-- Points Chart -->
              <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08);">
                <h3 style="color: #333; margin-bottom: 15px; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                  <span style="background: #e3f2fd; color: #1976d2; padding: 4px 8px; border-radius: 6px; font-size: 12px;">üìä</span>
                  Points per Session
                </h3>
                <div style="position: relative; height: 400px;">
                  <canvas id="athletePointsChart" style="width: 100%; height: 100%;"></canvas>
                  <div id="athletePointsPlaceholder" class="chart-placeholder" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #888; font-size: 14px;">
                    No points data available
                  </div>
                </div>
              </div>

              <!-- Rebounds Chart -->
              <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08);">
                <h3 style="color: #333; margin-bottom: 15px; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                  <span style="background: #e8f5e8; color: #2e7d32; padding: 4px 8px; border-radius: 6px; font-size: 12px;">üèÄ</span>
                  Rebounds per Session
                </h3>
                <div style="position: relative; height: 400px;">
                  <canvas id="athleteReboundsChart" style="width: 100%; height: 100%;"></canvas>
                  <div id="athleteReboundsPlaceholder" class="chart-placeholder" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #888; font-size: 14px;">
                    No rebounds data available
                  </div>
                </div>
              </div>

              <!-- Assists Chart -->
              <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08);">
                <h3 style="color: #333; margin-bottom: 15px; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                  <span style="background: #fff3e0; color: #f57c00; padding: 4px 8px; border-radius: 6px; font-size: 12px;">ü§ù</span>
                  Assists per Session
                </h3>
                <div style="position: relative; height: 400px;">
                  <canvas id="athleteAssistsChart" style="width: 100%; height: 100%;"></canvas>
                  <div id="athleteAssistsPlaceholder" class="chart-placeholder" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #888; font-size: 14px;">
                    No assists data available
                  </div>
                </div>
              </div>

              <!-- Turnovers Chart -->
              <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08);">
                <h3 style="color: #333; margin-bottom: 15px; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                  <span style="background: #ffebee; color: #d32f2f; padding: 4px 8px; border-radius: 6px; font-size: 12px;">‚ö†Ô∏è</span>
                  Turnovers per Session
                </h3>
                <div style="position: relative; height: 400px;">
                  <canvas id="athleteTurnoversChart" style="width: 100%; height: 100%;"></canvas>
                  <div id="athleteTurnoversPlaceholder" class="chart-placeholder" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #888; font-size: 14px;">
                    No turnovers data available
                  </div>
                </div>
              </div>

              <!-- Fouls Chart -->
              <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08);">
                <h3 style="color: #333; margin-bottom: 15px; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                  <span style="background: #fce4ec; color: #c2185b; padding: 4px 8px; border-radius: 6px; font-size: 12px;">üö´</span>
                  Fouls per Session
                </h3>
                <div style="position: relative; height: 400px;">
                  <canvas id="athleteFoulsChart" style="width: 100%; height: 100%;"></canvas>
                  <div id="athleteFoulsPlaceholder" class="chart-placeholder" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #888; font-size: 14px;">
                    No fouls data available
                  </div>
                </div>
              </div>

              <!-- RPE Chart -->
              <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08);">
                <h3 style="color: #333; margin-bottom: 15px; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                  <span style="background: #f3e5f5; color: #7b1fa2; padding: 4px 8px; border-radius: 6px; font-size: 12px;">üí™</span>
                  Rate of Perceived Exertion (RPE)
                </h3>
                <div style="position: relative; height: 400px;">
                  <canvas id="athleteRpeChart" style="width: 100%; height: 100%;"></canvas>
                  <div id="athleteRpePlaceholder" class="chart-placeholder" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #888; font-size: 14px;">
                    No RPE data available
                  </div>
                </div>
              </div>

            </div>

            <!-- Training Sessions Summary Table -->
            <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-top: 30px;">
              <h3 style="color: #333; margin-bottom: 20px; font-size: 18px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                <span style="background: #f3e5f5; color: #7b1fa2; padding: 6px 10px; border-radius: 8px; font-size: 14px;">üìã</span>
                Training Sessions Summary
              </h3>
              <div id="athleteSessionsTable" style="overflow-x: auto;">
                <!-- Training sessions data will be populated here -->
                <div style="text-align: center; color: #888; padding: 40px; font-size: 14px;">
                  Loading training session data...
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Leaflet (OpenStreetMap) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <!-- Chart.js for Analytics -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- Team Analytics Module -->
  <script src="team_analytics.js"></script>

  <!-- Chart.js Library for Statistics Visualization -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.1/dist/chartjs-adapter-moment.min.js"></script>
  
  <!-- ES Module Scripts -->
  <script type="module">
    import { requireAuth, logout, getUserProfile } from './script.js';
    import { auth, db } from './firebase-config.js';
    import { doc, getDoc, updateDoc, collection, getDocs, query, where, setDoc, deleteDoc, arrayUnion, arrayRemove, addDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    // Protect this page for coaches only
    requireAuth('coach');

    let currentUser = null;
    let reminders = [];
    let athletes = [];
    let teams = [];
    let currentSelectedTeam = null;
    let currentSelectedMember = null;
    let chartRefreshListeners = []; // Track active Firebase listeners
    let autoRefreshEnabled = true; // Control automatic chart refreshing
    let globalTeamAnalytics = null; // Global analytics instance to prevent multiple instances
    let chartRefreshTimeouts = new Map(); // For debouncing chart updates

    // Get current user and populate profile
    
    // Helper function to display profile
    function displayCoachProfile(profile) {
      if (!profile) return;
      document.getElementById('profileSection').style.display = 'block';
      document.getElementById('coachName').textContent = profile.name || 'COACH NAME';
      
      // Capitalize sport name
      const sport = profile.sport ? profile.sport.charAt(0).toUpperCase() + profile.sport.slice(1) : 'SPORT';
      document.getElementById('coachSport').textContent = sport;
      
      const avatarImage = document.getElementById('avatarImage');
      const avatarFallback = document.getElementById('avatarFallback');
      
      if (profile.avatar) {
        avatarImage.src = profile.avatar;
        avatarImage.style.display = 'block';
        avatarFallback.style.display = 'none';
      } else {
        avatarImage.style.display = 'none';
        avatarFallback.style.display = 'block';
      }
      
      reminders = Array.isArray(profile.reminders) ? profile.reminders.slice() : [];
      renderReminders();
    }
    
    // Try to load cached profile for immediate display
    const cachedUID = Object.keys(localStorage).find(key => key.startsWith('profile_'));
    if (cachedUID) {
      try {
        const cached = JSON.parse(localStorage.getItem(cachedUID));
        displayCoachProfile(cached);
      } catch (e) {
        console.log('Cache load error:', e);
      }
    }
    
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        currentUser = user;
        const profile = await getUserProfile(user.uid);
        displayCoachProfile(profile);
        
        // Load initial data
        if (profile) {
          await loadTeams();
          await loadTrainingSessions();
          await generateCalendar(); // Refresh calendar with events
          
          // Auto-refresh training sessions every minute to update statuses
          setInterval(() => {
            if (trainingSessions.length > 0) {
              renderTrainingSessions();
            }
            generateCalendar(); // Also refresh calendar
          }, 60000); // Refresh every 60 seconds
        }
      }
    });

    // Load teams from Firebase
    async function loadTeams() {
      if (!currentUser) return;
      
      try {
        const teamsRef = collection(db, 'teams');
        const q = query(teamsRef, where('coachId', '==', currentUser.uid));
        const querySnapshot = await getDocs(q);
        
        teams = [];
        querySnapshot.forEach((doc) => {
          teams.push({
            id: doc.id,
            ...doc.data()
          });
        });
        
        renderTeams();
      } catch (error) {
        console.error('Error loading teams:', error);
      }
    }

    // Render teams list
    function renderTeams() {
      const teamsList = document.getElementById('teamsList');
      if (!teamsList) return;
      
      // Keep only the dynamically added teams
      teamsList.innerHTML = '';
      
      teams.forEach(team => {
        const teamItem = document.createElement('div');
        teamItem.className = 'team-item';
        teamItem.dataset.teamId = team.id;
        teamItem.style.cursor = 'pointer';
        teamItem.innerHTML = `
          <img src="${team.image || 'assets/coach.png'}" alt="Team" class="team-item-image" />
          <div class="team-item-content">
            <div class="team-item-name">${team.name}</div>
            <div class="team-item-participants">${team.memberIds?.length || 0} Members</div>
          </div>
        `;
        teamsList.appendChild(teamItem);
      });
    }

    // Delete team
    async function deleteTeam(teamId) {
      if (!confirm('Are you sure you want to delete this team?')) return;
      
      try {
        await deleteDoc(doc(db, 'teams', teamId));
        teams = teams.filter(t => t.id !== teamId);
        renderTeams();
      } catch (error) {
        console.error('Error deleting team:', error);
        alert('Failed to delete team. Please try again.');
      }
    }

    // Edit team
    let editingTeamId = null;
    
    async function editTeam(teamId) {
      const team = teams.find(t => t.id === teamId);
      if (!team) return;
      
      editingTeamId = teamId;
      
      // Load athletes
      await fetchAthletes();
      
      // Populate form with team data
      document.getElementById('teamNameInput').value = team.name;
      
      // Show team image if exists
      if (team.image && team.image !== 'assets/coach.png') {
        teamImageData = team.image;
        teamPreviewImage.src = team.image;
        teamPreviewImage.style.display = 'block';
        uploadIcon.style.display = 'none';
      }
      
      // Select members that are in the team
      setTimeout(() => {
        const memberCards = document.querySelectorAll('.member-card');
        memberCards.forEach(card => {
          const athleteId = card.dataset.athleteId;
          const btn = card.querySelector('.member-add-btn');
          if (team.memberIds && team.memberIds.includes(athleteId)) {
            btn.classList.add('selected');
            btn.textContent = '‚úì';
          }
        });
      }, 100);
      
      // Change button text to "Update"
      createTeamBtn.textContent = 'Update';
      
      // Navigate to add team page
      document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
      document.getElementById('addTeam').classList.add('active');
      document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
    }

    // Team list click handler - view team details on click
    const teamsList = document.getElementById('teamsList');
    if (teamsList) {
      teamsList.addEventListener('click', (e) => {
        const teamItem = e.target.closest('.team-item');
        if (teamItem) {
          const teamId = teamItem.dataset.teamId;
          if (teamId) {
            viewTeamDetails(teamId);
          }
        }
      });
    }

    // Store current viewing team
    let currentViewingTeamId = null;
    let teamDetailsImageData = null;

    // Show team details section (edit view)
    window.viewTeamDetails = async function(teamId) {
      const team = teams.find(t => t.id === teamId);
      if (!team) return;
      window.teams = teams;
      currentViewingTeamId = teamId;
      
      // Load all athletes if not already loaded
      if (athletes.length === 0) {
        await fetchAthletes();
      }
      
      // Populate team name
      document.getElementById('teamDetailsNameInput').value = team.name;
      
      // Populate team image
      const previewImg = document.getElementById('teamDetailsPreviewImage');
      const uploadIcon = document.getElementById('teamDetailsUploadIcon');
      if (team.image && team.image !== 'assets/coach.png') {
        teamDetailsImageData = team.image;
        previewImg.src = team.image;
        previewImg.style.display = 'block';
        uploadIcon.style.display = 'none';
      } else {
        teamDetailsImageData = null;
        previewImg.style.display = 'none';
        previewImg.src = '';
        uploadIcon.style.display = 'block';
      }
      
      // Render athletes grid with selected members
      renderTeamDetailsMembers(team.memberIds || []);
      
      // Clear search
      document.getElementById('teamDetailsMemberSearch').value = '';
      
      // Show section
      document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
      document.getElementById('teamDetails').classList.add('active');
    }

    // Back button to return to teams page
    document.getElementById('backToTeamsBtn')?.addEventListener('click', () => {
      document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
      document.getElementById('teams').classList.add('active');
      currentViewingTeamId = null;
    });

    // Render team details members grid
    function renderTeamDetailsMembers(selectedMemberIds) {
      const membersGrid = document.getElementById('teamDetailsMembersGrid');
      if (!membersGrid) return;
      
      membersGrid.innerHTML = '';
      
      if (athletes.length === 0) {
        membersGrid.innerHTML = '<div style="grid-column: 1/-1; text-align:center; color:#666;">No athletes found</div>';
        return;
      }
      
      athletes.forEach(athlete => {
        const memberCard = document.createElement('div');
        memberCard.className = 'member-card';
        memberCard.dataset.athleteId = athlete.id;
        
        const isSelected = selectedMemberIds.includes(athlete.id);
        if (isSelected) {
          memberCard.style.background = '#e6d5f5';
          memberCard.style.border = '2px solid #9b59b6';
        }
        
        memberCard.innerHTML = `
          <img src="${athlete.avatar}" alt="${athlete.name}" class="member-avatar" />
          <span class="member-name">${athlete.name}</span>
          <button class="member-add-btn${isSelected ? ' selected' : ''}">${isSelected ? '‚úì' : '‚äï'}</button>
        `;
        membersGrid.appendChild(memberCard);
      });
    }

    // Team details image upload
    const teamDetailsUploadCircle = document.getElementById('teamDetailsUploadCircle');
    const teamDetailsImageInput = document.getElementById('teamDetailsImageInput');
    const teamDetailsPreviewImage = document.getElementById('teamDetailsPreviewImage');
    const teamDetailsUploadIcon = document.getElementById('teamDetailsUploadIcon');
    
    if (teamDetailsUploadCircle && teamDetailsImageInput) {
      teamDetailsUploadCircle.addEventListener('click', () => {
        teamDetailsImageInput.click();
      });
      
      teamDetailsImageInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            teamDetailsImageData = event.target.result;
            teamDetailsPreviewImage.src = teamDetailsImageData;
            teamDetailsPreviewImage.style.display = 'block';
            teamDetailsUploadIcon.style.display = 'none';
          };
          reader.readAsDataURL(file);
        }
      });
    }

    // Toggle member selection in team details
    const teamDetailsMembersGrid = document.getElementById('teamDetailsMembersGrid');
    if (teamDetailsMembersGrid) {
      teamDetailsMembersGrid.addEventListener('click', (e) => {
        const btn = e.target.closest('.member-add-btn');
        if (!btn) return;
        
        const card = btn.closest('.member-card');
        if (btn.classList.contains('selected')) {
          btn.classList.remove('selected');
          btn.textContent = '‚äï';
          card.style.background = '#fff';
          card.style.border = '1px solid #888';
        } else {
          btn.classList.add('selected');
          btn.textContent = '‚úì';
          card.style.background = '#e6d5f5';
          card.style.border = '2px solid #9b59b6';
        }
      });
    }

    // Search functionality for team details members
    const teamDetailsMemberSearch = document.getElementById('teamDetailsMemberSearch');
    if (teamDetailsMemberSearch) {
      teamDetailsMemberSearch.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const memberCards = document.querySelectorAll('#teamDetailsMembersGrid .member-card');
        
        memberCards.forEach(card => {
          const name = card.querySelector('.member-name').textContent.toLowerCase();
          if (name.includes(searchTerm)) {
            card.style.display = 'flex';
          } else {
            card.style.display = 'none';
          }
        });
      });
    }

    // Update team button
    const teamDetailsUpdateBtn = document.getElementById('teamDetailsUpdateBtn');
    if (teamDetailsUpdateBtn) {
      teamDetailsUpdateBtn.addEventListener('click', async () => {
        if (!currentViewingTeamId) return;
        
        const teamName = document.getElementById('teamDetailsNameInput').value;
        if (!teamName.trim()) {
          alert('Please enter a team name');
          return;
        }
        
        // Get selected member IDs
        const selectedMemberCards = document.querySelectorAll('#teamDetailsMembersGrid .member-add-btn.selected');
        const selectedMemberIds = Array.from(selectedMemberCards).map(btn => {
          return btn.closest('.member-card')?.dataset.athleteId;
        }).filter(id => id);
        
        // Use uploaded image or existing
        const team = teams.find(t => t.id === currentViewingTeamId);
        const imageUrl = teamDetailsImageData || team.image || 'assets/coach.png';
        
        // Update team object
        const teamData = {
          name: teamName,
          image: imageUrl,
          coachId: currentUser.uid,
          memberIds: selectedMemberIds,
          updatedAt: new Date().toISOString()
        };
        
        try {
          await setDoc(doc(db, 'teams', currentViewingTeamId), teamData, { merge: true });
          
          // Update local teams array
          const teamIndex = teams.findIndex(t => t.id === currentViewingTeamId);
          if (teamIndex !== -1) {
            teams[teamIndex] = {
              id: currentViewingTeamId,
              ...teamData
            };
          }
          
          alert('Team updated successfully!');
          renderTeams();
          
          // Go back to teams list
          document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
          document.getElementById('teams').classList.add('active');
          currentViewingTeamId = null;
        } catch (error) {
          console.error('Error updating team:', error);
          alert('Failed to update team: ' + error.message);
        }
      });
    }

    // Delete team button
    const teamDetailsDeleteBtn = document.getElementById('teamDetailsDeleteBtn');
    if (teamDetailsDeleteBtn) {
      teamDetailsDeleteBtn.addEventListener('click', async () => {
        if (!currentViewingTeamId) return;
        
        if (!confirm('Are you sure you want to delete this team?')) return;
        
        try {
          await deleteDoc(doc(db, 'teams', currentViewingTeamId));
          teams = teams.filter(t => t.id !== currentViewingTeamId);
          renderTeams();
          
          // Go back to teams list
          document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
          document.getElementById('teams').classList.add('active');
          currentViewingTeamId = null;
          
          alert('Team deleted successfully!');
        } catch (error) {
          console.error('Error deleting team:', error);
          alert('Failed to delete team.');
        }
      });
    }

    // Calendar state
    let currentCalendarMonth = new Date().getMonth();
    let currentCalendarYear = new Date().getFullYear();
    let calendarEvents = [];

    // Initialize calendar
    async function generateCalendar() {
      const firstDay = new Date(currentCalendarYear, currentCalendarMonth, 1).getDay();
      const daysInMonth = new Date(currentCalendarYear, currentCalendarMonth + 1, 0).getDate();
      const today = new Date();
      
      // Update month header
      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      document.getElementById('monthHeader').textContent = `${monthNames[currentCalendarMonth]} ${currentCalendarYear}`;
      
      const calendarBody = document.getElementById('calendarBody');
      calendarBody.innerHTML = '';
      
      // Load events for current month
      await loadCalendarEvents();
      console.log('Rendering calendar with events:', calendarEvents.length);
      
      let date = 1;
      for (let i = 0; i < 6; i++) {
        const row = document.createElement('tr');
        for (let j = 0; j < 7; j++) {
          const cell = document.createElement('td');
          if (i === 0 && j < firstDay) {
            cell.textContent = '';
          } else if (date > daysInMonth) {
            cell.textContent = '';
          } else {
            const currentDate = date;
            const dateString = `${currentCalendarYear}-${String(currentCalendarMonth + 1).padStart(2, '0')}-${String(currentDate).padStart(2, '0')}`;
            
            cell.textContent = currentDate;
            cell.style.cursor = 'pointer';
            cell.style.position = 'relative';
            
            // Highlight today
            if (currentDate === today.getDate() && 
                currentCalendarMonth === today.getMonth() && 
                currentCalendarYear === today.getFullYear()) {
              cell.classList.add('today');
            }
            
            // Check for events on this date
            const eventsOnDate = calendarEvents.filter(e => e.date === dateString);
            if (eventsOnDate.length > 0) {
              cell.style.fontWeight = 'bold';
              const indicator = document.createElement('div');
              indicator.style.cssText = 'position:absolute; bottom:4px; left:50%; transform:translateX(-50%); display:flex; gap:3px; justify-content:center;';
              eventsOnDate.slice(0, 3).forEach(event => {
                const dot = document.createElement('div');
                dot.style.cssText = `width:6px; height:6px; border-radius:50%; background:${
                  event.type === 'training' ? '#6C63FF' : 
                  event.type === 'competition' ? '#ff6b6b' : '#ffa500'
                }; box-shadow: 0 1px 3px rgba(0,0,0,0.3);`;
                dot.title = event.type === 'training' ? 'Training Session' : 'Competition';
                indicator.appendChild(dot);
              });
              cell.appendChild(indicator);
            }
            
            // Click handler
            cell.addEventListener('click', () => showEventsForDate(dateString, currentDate));
            
            date++;
          }
          row.appendChild(cell);
        }
        calendarBody.appendChild(row);
      }
    }

    // Load calendar events (training sessions and competitions)
    async function loadCalendarEvents() {
      if (!currentUser) {
        console.log('No current user for calendar events');
        return;
      }
      
      calendarEvents = [];
      console.log('Loading calendar events for user:', currentUser.uid);
      
      try {
        // Load training sessions
        const sessionsQuery = query(
          collection(db, 'trainingSessions'),
          where('coachId', '==', currentUser.uid)
        );
        const sessionsSnapshot = await getDocs(sessionsQuery);
        console.log('Training sessions found:', sessionsSnapshot.size);
        sessionsSnapshot.forEach(doc => {
          const data = doc.data();
          console.log('Training session date:', data.date);
          calendarEvents.push({
            id: doc.id,
            type: 'training',
            date: data.date,
            time: data.time,
            title: data.sessionName,
            details: `Team: ${data.teamName || 'N/A'}`,
            location: data.location
          });
        });
        
        // Load competitions
        const competitionsQuery = query(
          collection(db, 'competitions'),
          where('coachId', '==', currentUser.uid)
        );
        const competitionsSnapshot = await getDocs(competitionsQuery);
        console.log('Competitions found:', competitionsSnapshot.size);
        competitionsSnapshot.forEach(doc => {
          const data = doc.data();
          console.log('Competition date:', data.date);
          calendarEvents.push({
            id: doc.id,
            type: 'competition',
            date: data.date,
            time: data.time,
            title: data.competitionName,
            details: `${data.opponentName || 'TBD'}`,
            location: data.location
          });
        });
        
        console.log('Total calendar events loaded:', calendarEvents.length);
        console.log('Events:', calendarEvents);
      } catch (error) {
        console.error('Error loading calendar events:', error);
      }
    }

    // Show events for selected date
    function showEventsForDate(dateString, day) {
      const eventsOnDate = calendarEvents.filter(e => e.date === dateString);
      const eventDisplay = document.getElementById('selectedDateEvents');
      const eventsList = document.getElementById('selectedDateEventsList');
      const dateTitle = document.getElementById('selectedDateTitle');
      
      if (eventsOnDate.length === 0) {
        eventDisplay.style.display = 'none';
        return;
      }
      
      const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      dateTitle.textContent = `${monthNames[currentCalendarMonth]} ${day}, ${currentCalendarYear}`;
      
      eventsList.innerHTML = '';
      eventsOnDate.forEach(event => {
        const eventItem = document.createElement('div');
        eventItem.style.cssText = 'padding:12px; margin-bottom:8px; background:white; border-radius:6px; border-left:4px solid ' + 
          (event.type === 'training' ? '#6C63FF' : '#ff6b6b');
        eventItem.innerHTML = `
          <div style="font-weight:600; margin-bottom:4px;">${event.title}</div>
          <div style="font-size:12px; color:#666; margin-bottom:2px;">
            <span style="text-transform:capitalize;">${event.type}</span> ‚Ä¢ ${event.time || 'No time set'}
          </div>
          <div style="font-size:12px; color:#666;">${event.details}</div>
          ${event.location ? `<div style="font-size:12px; color:#666; margin-top:4px;">üìç ${event.location}</div>` : ''}
        `;
        eventsList.appendChild(eventItem);
      });
      
      eventDisplay.style.display = 'block';
    }

    // Calendar navigation
    document.getElementById('prevMonthBtn')?.addEventListener('click', () => {
      currentCalendarMonth--;
      if (currentCalendarMonth < 0) {
        currentCalendarMonth = 11;
        currentCalendarYear--;
      }
      generateCalendar();
    });

    document.getElementById('nextMonthBtn')?.addEventListener('click', () => {
      currentCalendarMonth++;
      if (currentCalendarMonth > 11) {
        currentCalendarMonth = 0;
        currentCalendarYear++;
      }
      generateCalendar();
    });

    generateCalendar();

    // Navigation
    function showSection(sectionId) {
      document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
      document.querySelectorAll('.content-section').forEach(sectionEl => sectionEl.classList.remove('active'));
      
      const navItem = document.querySelector(`[data-section="${sectionId}"]`);
      if (navItem) {
        navItem.classList.add('active');
      }
      const section = document.getElementById(sectionId);
      if (section) {
        section.classList.add('active');
      }
    }
    
    // Check URL hash on page load
    if (window.location.hash) {
      const sectionId = window.location.hash.substring(1); // Remove the '#'
      if (document.getElementById(sectionId)) {
        showSection(sectionId);
        // Load teams if teams section is requested on page load
        if (sectionId === 'teams' && teams.length === 0) {
          loadTeams();
        }
      }
    }
    
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', () => {
        const section = item.getAttribute('data-section');

        window.location.hash = section; // Update URL hash
        showSection(section);
        
        // Load teams if teams section is clicked
        if (section === 'teams' && teams.length === 0) {
          loadTeams();
        }

        // Load training sessions if training section is clicked
        if (section === 'training') {
          loadTrainingSessions();
        }

        // Load statistics if statistics section is clicked
        if (section === 'statistics') {
          loadStatisticsData();
        }
      });
    });

    // Sign Out
    document.getElementById('signOutBtn').addEventListener('click', async (e) => {
      e.preventDefault();
      await logout();
    });

    // Back to Sessions button
    document.getElementById('backToSessionsBtn')?.addEventListener('click', () => {
      // Hide session members section and show training list
      document.getElementById('sessionMembersSection').style.display = 'none';
      document.getElementById('trainingListView').style.display = 'block';
    });

    // Reminder helpers
    function renderReminders() {
      const remindersListEl = document.getElementById('remindersList');
      if (!remindersListEl) return;
      remindersListEl.innerHTML = '';

      if (!reminders.length) {
        const empty = document.createElement('div');
        empty.className = 'reminder-empty';
        empty.textContent = 'No reminders yet.';
        remindersListEl.appendChild(empty);
        return;
      }

      reminders.forEach((text, index) => {
        const item = document.createElement('div');
        item.className = 'reminder-item';
        item.innerHTML = `
          <div class="reminder-item-row">
            <span class="reminder-text">${text}</span>
            <button class="reminder-delete-btn" data-index="${index}" aria-label="Delete reminder">
              Delete
            </button>
          </div>
        `;
        remindersListEl.appendChild(item);
      });
    }

    async function persistReminders(nextReminders) {
      if (!currentUser) return;
      await updateDoc(doc(db, 'profiles', currentUser.uid), { reminders: nextReminders });
    }

    async function addReminder() {
      const reminder = prompt('Enter new reminder:');
      if (!reminder) return;
      const trimmed = reminder.trim();
      if (!trimmed) return;

      const next = [...reminders, trimmed];
      reminders = next;
      renderReminders();
      try {
        await persistReminders(next);
      } catch (err) {
        console.error('Failed to save reminder', err);
        alert('Could not save reminder. Please try again.');
        reminders = reminders.filter((_, idx) => idx !== next.length - 1);
        renderReminders();
      }
    }

    async function deleteReminder(index) {
      if (index < 0 || index >= reminders.length) return;
      const next = reminders.filter((_, i) => i !== index);
      const previous = reminders;
      reminders = next;
      renderReminders();
      try {
        await persistReminders(next);
      } catch (err) {
        console.error('Failed to delete reminder', err);
        alert('Could not delete reminder. Please try again.');
        reminders = previous;
        renderReminders();
      }
    }

    document.getElementById('addReminderBtn').addEventListener('click', addReminder);
    const remindersList = document.getElementById('remindersList');
    if (remindersList) {
      remindersList.addEventListener('click', (e) => {
        const btn = e.target.closest('.reminder-delete-btn');
        if (!btn) return;
        const index = Number(btn.dataset.index);
        deleteReminder(index);
      });
    }

    // Fetch athletes from database
    async function fetchAthletes() {
      const membersGrid = document.getElementById('membersGrid');
      
      try {
        console.log('Starting to fetch athletes...');
        
        // For now, use sample data if we don't have permission
        // You'll need to update Firebase rules to allow coaches to read athlete profiles
        athletes = [
          { id: '1', name: 'Sample Athlete 1', avatar: 'assets/athlete.png', sport: '' },
          { id: '2', name: 'Sample Athlete 2', avatar: 'assets/athlete.png', sport: '' },
          { id: '3', name: 'Sample Athlete 3', avatar: 'assets/athlete.png', sport: '' },
          { id: '4', name: 'Sample Athlete 4', avatar: 'assets/athlete.png', sport: '' }
        ];
        
        // Try to fetch real athletes
        if (db && currentUser) {
          try {
            const profilesRef = collection(db, 'profiles');
            const querySnapshot = await getDocs(profilesRef);
            
            const fetchedAthletes = [];
            querySnapshot.forEach((doc) => {
              const data = doc.data();
              // Only include athletes, exclude the current coach
              if (doc.id !== currentUser.uid && (!data.role || data.role === 'athlete')) {
                fetchedAthletes.push({
                  id: doc.id,
                  name: data.name || data.email || 'Unknown',
                  avatar: data.avatar || 'assets/athlete.png',
                  sport: data.sport || ''
                });
              }
            });
            
            if (fetchedAthletes.length > 0) {
              athletes = fetchedAthletes;
              console.log('Successfully loaded athletes from database:', athletes.length);
            }
          } catch (dbError) {
            console.warn('Could not fetch from database, using sample data:', dbError.message);
            if (membersGrid) {
              const warningDiv = document.createElement('div');
              warningDiv.style.cssText = 'grid-column: 1/-1; padding:10px; background:#fff3cd; border:1px solid #ffc107; border-radius:8px; margin-bottom:12px; font-size:12px;';
              warningDiv.textContent = 'Note: Using sample data. Update Firebase rules to see real athletes.';
              membersGrid.parentElement.insertBefore(warningDiv, membersGrid);
            }
          }
        }
        
        console.log('Athletes to display:', athletes.length);
        renderMemberGrid();
      } catch (error) {
        console.error('Error in fetchAthletes:', error);
        
        if (membersGrid) {
          membersGrid.innerHTML = `<div style="grid-column: 1/-1; text-align:center; color:#666;">
            <p>Unable to load athletes.</p>
            <p style="font-size:12px;">Firebase permissions may need to be updated.</p>
          </div>`;
        }
      }
    }

    // Render member grid with fetched athletes
    function renderMemberGrid() {
      const membersGrid = document.getElementById('membersGrid');
      if (!membersGrid) return;
      
      membersGrid.innerHTML = '';
      
      if (athletes.length === 0) {
        membersGrid.innerHTML = '<div style="grid-column: 1/-1; text-align:center; color:#666;">No athletes found</div>';
        return;
      }
      
      athletes.forEach(athlete => {
        const memberCard = document.createElement('div');
        memberCard.className = 'member-card';
        memberCard.dataset.athleteId = athlete.id;
        memberCard.innerHTML = `
          <img src="${athlete.avatar}" alt="${athlete.name}" class="member-avatar" />
          <span class="member-name">${athlete.name}</span>
          <button class="member-add-btn">‚äï</button>
        `;
        membersGrid.appendChild(memberCard);
      });
    }

    // Search functionality for members
    const memberSearchInput = document.getElementById('memberSearchInput');
    if (memberSearchInput) {
      memberSearchInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const memberCards = document.querySelectorAll('.member-card');
        
        memberCards.forEach(card => {
          const name = card.querySelector('.member-name').textContent.toLowerCase();
          if (name.includes(searchTerm)) {
            card.style.display = 'flex';
          } else {
            card.style.display = 'none';
          }
        });
      });
    }

    // Add team button - navigate to add team section
    const addTeamCircleBtn = document.getElementById('addTeamCircleBtn');
    if (addTeamCircleBtn) {
      addTeamCircleBtn.addEventListener('click', async () => {
        // Reset editing mode
        editingTeamId = null;
        createTeamBtn.textContent = 'Upload';
        
        // Reset form
        document.getElementById('teamNameInput').value = '';
        teamImageData = null;
        if (teamPreviewImage) {
          teamPreviewImage.style.display = 'none';
          teamPreviewImage.src = '';
        }
        if (uploadIcon) uploadIcon.style.display = 'block';
        if (teamImageInput) teamImageInput.value = '';
        
        // Fetch athletes when navigating to add team page
        await fetchAthletes();
        
        // Switch to add team section
        document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
        document.getElementById('addTeam').classList.add('active');
        
        // Update nav items
        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
      });
    }

    // Back button from add team page
    document.getElementById('backToTeamsFromAddBtn')?.addEventListener('click', () => {
      document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
      document.getElementById('teams').classList.add('active');
    });
    
    // Team image upload
    let teamImageData = null;
    const uploadCircle = document.getElementById('uploadCircle');
    const teamImageInput = document.getElementById('teamImageInput');
    const teamPreviewImage = document.getElementById('teamPreviewImage');
    const uploadIcon = document.getElementById('uploadIcon');
    
    if (uploadCircle && teamImageInput) {
      uploadCircle.addEventListener('click', () => {
        teamImageInput.click();
      });
      
      teamImageInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            teamImageData = event.target.result;
            teamPreviewImage.src = teamImageData;
            teamPreviewImage.style.display = 'block';
            uploadIcon.style.display = 'none';
          };
          reader.readAsDataURL(file);
        }
      });
    }
    
    // Toggle member selection
    const membersGrid = document.getElementById('membersGrid');
    if (membersGrid) {
      membersGrid.addEventListener('click', (e) => {
        const btn = e.target.closest('.member-add-btn');
        if (!btn) return;
        
        if (btn.classList.contains('selected')) {
          btn.classList.remove('selected');
          btn.textContent = '‚äï';
        } else {
          btn.classList.add('selected');
          btn.textContent = '‚úì';
        }
      });
    }
    
    // Create/Update team button
    const createTeamBtn = document.getElementById('createTeamBtn');
    if (createTeamBtn) {
      createTeamBtn.addEventListener('click', async () => {
        const teamName = document.getElementById('teamNameInput').value;
        if (!teamName.trim()) {
          alert('Please enter a team name');
          return;
        }
        
        // Get selected member IDs
        const selectedMemberCards = document.querySelectorAll('.member-add-btn.selected');
        const selectedMemberIds = Array.from(selectedMemberCards).map(btn => {
          return btn.closest('.member-card')?.dataset.athleteId;
        }).filter(id => id);
        
        // Use uploaded image or default
        const imageUrl = teamImageData || 'assets/coach.png';
        
        // Create team object
        const teamData = {
          name: teamName,
          image: imageUrl,
          coachId: currentUser.uid,
          memberIds: selectedMemberIds,
          updatedAt: new Date().toISOString()
        };
        
        try {
          if (editingTeamId) {
            // Update existing team
            try {
              await setDoc(doc(db, 'teams', editingTeamId), teamData, { merge: true });
              console.log('Team updated in Firebase successfully');
            } catch (firebaseError) {
              console.warn('Could not update in Firebase:', firebaseError.message);
            }
            
            // Update local teams array
            const teamIndex = teams.findIndex(t => t.id === editingTeamId);
            if (teamIndex !== -1) {
              teams[teamIndex] = {
                id: editingTeamId,
                ...teamData
              };
            }
            
            alert('Team updated successfully!');
            editingTeamId = null;
            createTeamBtn.textContent = 'Upload';
          } else {
            // Create new team
            teamData.createdAt = new Date().toISOString();
            const teamsRef = collection(db, 'teams');
            const newTeamRef = doc(teamsRef);
            
            try {
              await setDoc(newTeamRef, teamData);
              console.log('Team saved to Firebase successfully');
            } catch (firebaseError) {
              console.warn('Could not save to Firebase:', firebaseError.message);
            }
            
            // Add to local teams array
            teams.push({
              id: newTeamRef.id,
              ...teamData
            });
            
            alert('Team created successfully!');
          }
          
          // Render teams
          renderTeams();
          
          // Reset form
          document.getElementById('teamNameInput').value = '';
          teamImageData = null;
          if (teamPreviewImage) {
            teamPreviewImage.style.display = 'none';
            teamPreviewImage.src = '';
          }
          if (uploadIcon) uploadIcon.style.display = 'block';
          if (teamImageInput) teamImageInput.value = '';
          document.querySelectorAll('.member-add-btn.selected').forEach(btn => {
            btn.classList.remove('selected');
            btn.textContent = '‚äï';
          });
          
          // Navigate back to teams section
          document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
          document.getElementById('teams').classList.add('active');
          
          // Update nav items
          document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
          document.querySelector('[data-section="teams"]').classList.add('active');
        } catch (error) {
          console.error('Error saving team:', error);
          console.error('Error details:', error.message, error.code);
          alert('Failed to save team: ' + error.message);
        }
      });
    }

    // ===== TRAINING SESSION FUNCTIONS =====
    let trainingSessions = [];
    let currentTrainingFilter = 'all';

    // Calculate status based on date and time (respects manual override)
    function calculateSessionStatus(session) {
      // If coach manually set status, use that (unless it's currently in-progress)
      if (session.manualStatus) {
        const now = new Date();
        const sessionDateTime = new Date(`${session.date}T${session.time}`);
        const sessionEndTime = new Date(sessionDateTime.getTime() + (session.duration || 60) * 60000);
        
        // Override manual status if session is currently in progress
        if (now >= sessionDateTime && now < sessionEndTime) {
          return 'in-progress';
        }
        
        return session.manualStatus;
      }
      
      // Auto-calculate status
      const now = new Date();
      const sessionDateTime = new Date(`${session.date}T${session.time}`);
      const sessionEndTime = new Date(sessionDateTime.getTime() + (session.duration || 60) * 60000);
      
      if (now < sessionDateTime) {
        return 'upcoming';
      } else if (now >= sessionDateTime && now < sessionEndTime) {
        return 'in-progress';
      } else {
        return 'completed';
      }
    }

    // Load training sessions from Firebase
    async function loadTrainingSessions() {
      try {
        const userId = currentUser.uid;
        const sessionsQuery = query(
          collection(db, 'trainingSessions'),
          where('coachId', '==', userId)
        );
        
        const querySnapshot = await getDocs(sessionsQuery);
        trainingSessions = []; // Use global variable, not const local variable
        
        querySnapshot.forEach((doc) => {
          trainingSessions.push({
            id: doc.id,
            ...doc.data()
          });
        });
        
        renderTrainingSessions();
      } catch (error) {
        console.error('Error loading training sessions:', error);
      }
    }

    // Render training sessions list
    function renderTrainingSessions() {
      const sessionsList = document.getElementById('trainingSessionsList');
      if (!sessionsList) return;

      if (trainingSessions.length === 0) {
        sessionsList.innerHTML = '<div style="text-align:center; color:#999; padding:40px; grid-column: 1/-1;">No training sessions yet. Create one to get started!</div>';
        return;
      }

      // Calculate current status for each session
      const sessionsWithStatus = trainingSessions.map(session => ({
        ...session,
        status: calculateSessionStatus(session)
      }));

      // Filter sessions based on current filter
      let filteredSessions = sessionsWithStatus;
      if (currentTrainingFilter !== 'all') {
        filteredSessions = sessionsWithStatus.filter(session => session.status === currentTrainingFilter);
      }

      // Sort by date (newest first)
      filteredSessions.sort((a, b) => {
        const dateA = new Date(`${a.date}T${a.time}`);
        const dateB = new Date(`${b.date}T${b.time}`);
        return dateB - dateA;
      });

      // Display filtered sessions
      if (filteredSessions.length === 0) {
        sessionsList.innerHTML = `<div style="text-align:center; color:#999; padding:40px; grid-column: 1/-1;">No ${currentTrainingFilter} sessions found.</div>`;
        return;
      }

      sessionsList.innerHTML = '';
      filteredSessions.forEach(session => {
        const sessionCard = document.createElement('div');
        sessionCard.className = 'training-card';
        
        sessionCard.innerHTML = `
          <div class="training-card-title" onclick="showSessionMembers('${session.id}')">
            ${session.sessionName}
          </div>
          
          <div class="training-card-info" onclick="showSessionMembers('${session.id}')">
            <strong>Date:</strong>
            <span>${new Date(session.date).toLocaleDateString()}</span>
          </div>
          
          <div class="training-card-info" onclick="showSessionMembers('${session.id}')">
            <strong>Time:</strong>
            <span>${session.time || 'Not set'}</span>
          </div>
          
          <div class="training-card-info" onclick="showSessionMembers('${session.id}')">
            <strong>Team:</strong>
            <span>${session.teamName || 'Not assigned'}</span>
          </div>
          
          <div class="training-card-info">
            <strong>Status:</strong>
            <select onchange="updateSessionStatus('${session.id}', this.value)" style="
              font-size: 12px; 
              font-weight: 600; 
              padding: 4px 8px; 
              border: 2px solid ${
                session.status === 'completed' ? '#28a745' : 
                session.status === 'in-progress' ? '#dc3545' : 
                '#ffa500'
              }; 
              border-radius: 6px; 
              background: white; 
              color: ${
                session.status === 'completed' ? '#28a745' : 
                session.status === 'in-progress' ? '#dc3545' : 
                '#ffa500'
              }; 
              cursor: pointer;
              margin-left: auto;
            ">
              <option value="upcoming" ${session.status === 'upcoming' ? 'selected' : ''}>Upcoming</option>
              <option value="in-progress" ${session.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
              <option value="completed" ${session.status === 'completed' ? 'selected' : ''}>Completed</option>
            </select>
          </div>
          
          <div class="training-card-actions">
            <button class="training-card-btn view" onclick="showSessionMembers('${session.id}')">
              View Team
            </button>
            <button class="training-card-btn" onclick="event.stopPropagation(); editTrainingSession('${session.id}')">
              Edit
            </button>
            <button class="training-card-btn delete" onclick="event.stopPropagation(); deleteTrainingSession('${session.id}')">
              Delete
            </button>
          </div>
        `;
        
        sessionsList.appendChild(sessionCard);
      });
    }

    // Delete training session
    window.deleteTrainingSession = async function(sessionId) {
      if (!confirm('Are you sure you want to delete this training session?')) return;

      try {
        // Delete all athlete session data for this session
        const athleteDataQuery = query(collection(db, 'athleteSessionData'), where('sessionId', '==', sessionId));
        const athleteDataSnapshot = await getDocs(athleteDataQuery);
        
        // Delete all athlete performance records for this session
        const deletePromises = athleteDataSnapshot.docs.map(doc => deleteDoc(doc.ref));
        await Promise.all(deletePromises);
        
        console.log(`üóëÔ∏è Deleted ${deletePromises.length} athlete performance records for session ${sessionId}`);
        
        // Delete the training session itself
        await deleteDoc(doc(db, 'trainingSessions', sessionId));
        
        // Update local state
        trainingSessions = trainingSessions.filter(s => s.id !== sessionId);
        renderTrainingSessions();
        
        alert(`Training session and ${deletePromises.length} athlete performance records deleted successfully!`);
      } catch (error) {
        console.error('Error deleting training session:', error);
        alert('Failed to delete training session: ' + error.message);
      }
    };

    // Update session status
    window.updateSessionStatus = async function(sessionId, newStatus) {
      try {
        await updateDoc(doc(db, 'trainingSessions', sessionId), {
          manualStatus: newStatus,
          statusUpdatedAt: new Date()
        });
        
        // Update local array
        const session = trainingSessions.find(s => s.id === sessionId);
        if (session) {
          session.manualStatus = newStatus;
          session.statusUpdatedAt = new Date();
        }
        
        renderTrainingSessions();
      } catch (error) {
        console.error('Error updating status:', error);
        alert('Failed to update status: ' + error.message);
      }
    };

    // Training session filter buttons
    document.querySelectorAll('.training-filter-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        // Update active state
        document.querySelectorAll('.training-filter-btn').forEach(b => {
          b.classList.remove('active');
          b.style.fontWeight = 'normal';
        });
        this.classList.add('active');
        this.style.fontWeight = '600';
        
        // Update filter and re-render
        currentTrainingFilter = this.dataset.filter;
        renderTrainingSessions();
      });
    });

    // Delete training session
    window.deleteTrainingSession = async function(sessionId) {
      if (!confirm('Are you sure you want to delete this training session?')) return;

      try {
        // Delete all athlete session data for this session
        const athleteDataQuery = query(collection(db, 'athleteSessionData'), where('sessionId', '==', sessionId));
        const athleteDataSnapshot = await getDocs(athleteDataQuery);
        
        // Delete all athlete performance records for this session
        const deletePromises = athleteDataSnapshot.docs.map(doc => deleteDoc(doc.ref));
        await Promise.all(deletePromises);
        
        console.log(`üóëÔ∏è Deleted ${deletePromises.length} athlete performance records for session ${sessionId}`);
        
        // Delete the training session itself
        await deleteDoc(doc(db, 'trainingSessions', sessionId));
        
        // Update local state
        trainingSessions = trainingSessions.filter(s => s.id !== sessionId);
        renderTrainingSessions();
        
        alert(`Training session and ${deletePromises.length} athlete performance records deleted successfully!`);
      } catch (error) {
        console.error('Error deleting training session:', error);
        alert('Failed to delete training session');
      }
    };

    // Edit training session
    window.editTrainingSession = async function(sessionId) {
      const session = trainingSessions.find(s => s.id === sessionId);
      if (!session) return;

      // Make sure teams are loaded
      if (teams.length === 0) {
        await loadTeams();
      }

      // Populate team select dropdown
      const teamSelect = document.getElementById('sessionTeamSelect');
      teamSelect.innerHTML = '<option value="">Choose a team...</option>';
      if (teams.length === 0) {
        teamSelect.innerHTML += '<option disabled>No teams available</option>';
      } else {
        teams.forEach(team => {
          const option = document.createElement('option');
          option.value = team.id;
          option.textContent = team.name;
          teamSelect.appendChild(option);
        });
      }

      // Populate form with session data
      document.getElementById('sessionNameInput').value = session.sessionName || '';
      document.getElementById('sessionDateInput').value = session.date || '';
      document.getElementById('sessionTimeInput').value = session.time || '';
      document.getElementById('sessionDurationInput').value = session.duration || '';
      document.getElementById('sessionLocationInput').value = session.location || '';
      document.getElementById('sessionDescriptionInput').value = session.description || '';
      document.getElementById('sessionTeamSelect').value = session.teamId || '';

      // Store the ID being edited
      window.currentEditingSessionId = sessionId;
      window.isEditingSession = true;

      // Switch to add training view
      document.getElementById('trainingListView').style.display = 'none';
      document.getElementById('addTrainingView').style.display = 'block';
    };
    // Global variables for athlete data modal
    let currentSessionData = null;

    // Show session members section
    window.showSessionMembers = async function(sessionId) {
      const session = trainingSessions.find(s => s.id === sessionId);
      if (!session) {
        alert('Session not found');
        return;
      }

      if (!session.teamId) {
        alert('No team assigned to this session');
        return;
      }

      // Store session data globally for modal access
      currentSessionData = session;

      // Test Firebase rules first
      console.log('Testing Firebase rules...');
      try {
        const testDoc = await getDoc(doc(db, 'profiles', currentUser.uid));
        console.log('Firebase rules test - can read own profile:', testDoc.exists());
      } catch (error) {
        console.error('Firebase rules test failed:', error);
      }

      // Make sure teams are loaded with complete data
      if (teams.length === 0) {
        await loadTeams();
      }

      // Find the team
      let team = teams.find(t => t.id === session.teamId);
      if (!team) {
        // Try to reload teams and find again
        await loadTeams();
        team = teams.find(t => t.id === session.teamId);
        if (!team) {
          alert('Team not found');
          return;
        }
      }

      console.log('Team found:', team);
      console.log('Team memberIds:', team.memberIds);

      // Update section title
      document.getElementById('sessionMembersTitle').textContent = `${session.sessionName} - Team Members`;

      // Hide training list and show members section
      document.getElementById('trainingListView').style.display = 'none';
      document.getElementById('sessionMembersSection').style.display = 'block';

      // Load and display team members
      await loadSessionMembers(team, session);
    };

    // Load member session stats
    async function loadMemberSessionStats(athleteId, sessionId) {
      try {
        const dataId = `${athleteId}_${sessionId}`;
        const docRef = doc(db, 'athleteSessionData', dataId);
        const docSnap = await getDoc(docRef);
        
        if (docSnap.exists()) {
          return docSnap.data();
        }
        return null;
      } catch (error) {
        console.error('Error loading member stats:', error);
        return null;
      }
    }

    // Load session members
    async function loadSessionMembers(team, session) {
      const membersList = document.getElementById('sessionMembersList');
      
      console.log('Loading members for team:', team);
      console.log('Team memberIds:', team.memberIds);
      console.log('All team properties:', Object.keys(team));
      
      // Check both memberIds and members fields
      const memberIds = team.memberIds || team.members || [];
      
      if (!memberIds || memberIds.length === 0) {
        membersList.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">No members assigned to this team yet.</div>';
        return;
      }

      membersList.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">Loading team members...</div>';

      try {
        const memberDetails = [];
        
        console.log('Fetching details for memberIds:', memberIds);
        
        // Get member details from Firebase users collection and profiles collection
        for (const memberId of memberIds) {
          try {
            console.log('Fetching member:', memberId);
            console.log('Current user:', currentUser?.uid);
            console.log('Auth state:', currentUser ? 'authenticated' : 'not authenticated');
            
            // Try users collection first
            console.log('Attempting to fetch from users collection...');
            let memberDoc = await getDoc(doc(db, 'users', memberId));
            let memberData = null;
            
            if (memberDoc.exists()) {
              memberData = memberDoc.data();
              console.log('SUCCESS: Found in users collection:', memberData);
            } else {
              console.log('Not found in users collection, document does not exist');
              // Try profiles collection if not found in users
              console.log('Attempting to fetch from profiles collection...');
              memberDoc = await getDoc(doc(db, 'profiles', memberId));
              if (memberDoc.exists()) {
                memberData = memberDoc.data();
                console.log('SUCCESS: Found in profiles collection:', memberData);
              } else {
                console.log('Not found in profiles collection either, document does not exist');
              }
            }
            
            if (memberData) {
              memberDetails.push({
                id: memberId,
                ...memberData
              });
            } else {
              console.log('No data found for member:', memberId);
            }
          } catch (error) {
            console.error(`FIREBASE ERROR loading member ${memberId}:`, error);
            console.error('Error code:', error.code);
            console.error('Error message:', error.message);
            console.error('Error details:', error);
          }
        }

        console.log('Member details loaded:', memberDetails);

        if (memberDetails.length === 0) {
          membersList.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">No member details found. This may be due to Firebase permissions.<br><small>Checked IDs: ' + JSON.stringify(memberIds) + '<br>Tried both users and profiles collections</small></div>';
          return;
        }

        // Render member stats cards
        membersList.innerHTML = '';
        membersList.className = 'members-stats-grid';
        
        // Load stats for all members
        const membersWithStats = await Promise.all(
          memberDetails.map(async (member) => {
            const stats = await loadMemberSessionStats(member.id, session.id);
            return { ...member, stats };
          })
        );
        
        membersWithStats.forEach(member => {
          const memberCard = document.createElement('div');
          memberCard.className = member.stats ? 'member-stats-card' : 'member-stats-card no-data-card';
          
          const initials = (member.firstName && member.lastName) 
            ? `${member.firstName.charAt(0)}${member.lastName.charAt(0)}`.toUpperCase()
            : member.email ? member.email.charAt(0).toUpperCase() 
            : member.name ? member.name.charAt(0).toUpperCase()
            : '?';
          
          const displayName = (member.firstName && member.lastName) 
            ? `${member.firstName} ${member.lastName}` 
            : member.name || member.email || 'Name not set';
          
          if (member.stats) {
            memberCard.innerHTML = `
              <div class="member-stats-header">
                <div class="member-stats-avatar">${initials}</div>
                <div class="member-stats-info">
                  <h4>${displayName}</h4>
                  <div class="member-status">${member.stats.attendance || 'Present'}</div>
                </div>
              </div>
              <div class="stats-row">
                <div class="stat-item">
                  <div class="stat-label">PTS</div>
                  <div class="stat-value">${member.stats.points || 0}</div>
                </div>
                <div class="stat-item">
                  <div class="stat-label">REB</div>
                  <div class="stat-value">${member.stats.rebounds || 0}</div>
                </div>
              </div>
              <div class="stats-row">
                <div class="stat-item">
                  <div class="stat-label">AST</div>
                  <div class="stat-value">${member.stats.assists || 0}</div>
                </div>
                <div class="stat-item">
                  <div class="stat-label">TO</div>
                  <div class="stat-value">${member.stats.turnovers || 0}</div>
                </div>
              </div>
              <div class="stats-row">
                <div class="stat-item">
                  <div class="stat-label">FOULS</div>
                  <div class="stat-value">${member.stats.fouls || 0}</div>
                </div>
                <div class="stat-item">
                  <div class="stat-label">RPE</div>
                  <div class="stat-value">${member.stats.rpe || '-'}</div>
                </div>
              </div>
            `;
          } else {
            memberCard.innerHTML = `
              <div class="member-stats-header">
                <div class="member-stats-avatar">${initials}</div>
                <div class="member-stats-info">
                  <h4>${displayName}</h4>
                  <div class="member-status">No session data</div>
                </div>
              </div>
              <div style="text-align: center; color: #999; margin-top: 16px;">
                <p>Click to add session data</p>
              </div>
            `;
          }
          
          // Make member card clickable to open athlete data modal
          memberCard.addEventListener('click', () => {
            console.log('Clicked member:', member);
            console.log('Session context:', session);
            openAthleteDataModal(member, session);
          });
          
          membersList.appendChild(memberCard);
        });

      } catch (error) {
        console.error('Error loading session members:', error);
        membersList.innerHTML = '<div style="text-align:center; color:#dc3545; padding:20px;">Error loading team members. This may be due to Firebase permissions.<br>Error: ' + error.message + '</div>';
      }
    }

    // Athlete Data Modal Functions
    let currentAthleteData = null;
    let currentSessionContext = null;

    function openAthleteDataModal(athlete, session) {
      console.log('Opening athlete data modal for:', athlete.name);
      console.log('Session object received:', session);
      console.log('Session properties:', Object.keys(session));
      
      currentAthleteData = athlete;
      currentSessionContext = session;
      
      // Update modal title
      const modalTitle = document.querySelector('#athleteDataModal .modal-title');
      if (modalTitle) {
        modalTitle.textContent = `Session Data - ${athlete.name}`;
      }
      
      // Update session info
      const sessionInfo = document.querySelector('#athleteDataModal .session-info');
      if (sessionInfo) {
        sessionInfo.innerHTML = `
          <strong>Training Session:</strong> ${session.sessionName || 'Unknown Session'}<br>
          <strong>Date:</strong> ${new Date(session.date).toLocaleDateString()}<br>
          <strong>Team:</strong> ${session.teamName || 'Unknown'}<br>
          <strong>Team ID:</strong> ${session.teamId || 'Missing teamId'}
        `;
      }
      
      // Load existing data if available
      loadExistingAthleteData(athlete.id, session.id);
      
      // Store session data in hidden form fields for reliable access
      const form = document.getElementById('athleteDataForm');
      if (form) {
        // Remove existing hidden fields
        form.querySelectorAll('input[type="hidden"]').forEach(input => input.remove());
        
        // Add session data as hidden fields
        const sessionFields = [
          { name: 'sessionId', value: session.id || '' },
          { name: 'sessionName', value: session.sessionName || '' },
          { name: 'sessionDate', value: session.date || '' },
          { name: 'sessionTeamId', value: session.teamId || '' },
          { name: 'sessionTeamName', value: session.teamName || '' }
        ];
        
        sessionFields.forEach(field => {
          const hiddenInput = document.createElement('input');
          hiddenInput.type = 'hidden';
          hiddenInput.name = field.name;
          hiddenInput.value = field.value;
          form.appendChild(hiddenInput);
        });
      }
      
      // Show modal
      const modal = document.getElementById('athleteDataModal');
      if (modal) {
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden'; // Prevent background scrolling
      }
    }

    function closeAthleteDataModal() {
      const modal = document.getElementById('athleteDataModal');
      if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto'; // Restore scrolling
      }
      
      // Clear form
      clearAthleteDataForm();
      currentAthleteData = null;
      currentSessionContext = null;
    }

    function clearAthleteDataForm() {
      const form = document.getElementById('athleteDataForm');
      if (form) {
        form.reset();
      }
    }

    async function loadExistingAthleteData(athleteId, sessionId) {
      try {
        const dataId = `${athleteId}_${sessionId}`;
        const docRef = doc(db, 'athleteSessionData', dataId);
        const docSnap = await getDoc(docRef);
        
        if (docSnap.exists()) {
          const data = docSnap.data();
          console.log('Loading existing athlete data:', data);
          
          // Populate form with existing data
          const form = document.getElementById('athleteDataForm');
          if (form) {
            const fields = ['points', 'rebounds', 'assists', 'turnovers', 'fouls', 'rpe', 'attendance', 'notes'];
            fields.forEach(field => {
              const input = form.querySelector(`[name="${field}"]`);
              if (input && data[field] !== undefined) {
                input.value = data[field];
              }
            });
          }
        }
      } catch (error) {
        console.error('Error loading existing athlete data:', error);
      }
    }

    async function saveAthleteData() {
      console.log('saveAthleteData called');
      console.log('currentAthleteData:', currentAthleteData);
      console.log('currentSessionContext:', currentSessionContext);
      
      if (!currentAthleteData || !currentSessionContext) {
        console.error('Missing data - currentAthleteData:', currentAthleteData, 'currentSessionContext:', currentSessionContext);
        alert('Error: Missing athlete or session data');
        return;
      }
      
      try {
        const form = document.getElementById('athleteDataForm');
        const formData = new FormData(form);
        
        // Get session data from form (more reliable) or fallback to global variables
        const sessionId = formData.get('sessionId') || currentSessionContext?.id;
        const sessionName = formData.get('sessionName') || currentSessionContext?.sessionName || 'Unknown Session';
        const sessionDate = formData.get('sessionDate') || currentSessionContext?.date;
        const teamId = formData.get('sessionTeamId') || currentSessionContext?.teamId || 'unknown';
        const teamName = formData.get('sessionTeamName') || currentSessionContext?.teamName || 'Unknown Team';
        
        if (!sessionId) {
          alert('Error: Session information is missing');
          return;
        }
        
        // Create data object
        const athleteSessionData = {
          athleteId: currentAthleteData.id,
          athleteName: currentAthleteData.name,
          athleteEmail: currentAthleteData.email, // Add email for cross-reference
          sessionId: sessionId,
          sessionName: sessionName,
          sessionDate: sessionDate,
          teamId: teamId,
          teamName: teamName,
          // Session data
          rpe: (formData.get('attendance') === 'Absent' || formData.get('attendance') === 'Injured') ? 0 : (parseInt(formData.get('rpe')) || 1),
          attendance: formData.get('attendance') || 'Present',
          notes: formData.get('notes') || '',
          
          // Performance stats - set to 0 if absent or injured
          points: (formData.get('attendance') === 'Absent' || formData.get('attendance') === 'Injured') ? 0 : (parseInt(formData.get('points')) || 0),
          rebounds: (formData.get('attendance') === 'Absent' || formData.get('attendance') === 'Injured') ? 0 : (parseInt(formData.get('rebounds')) || 0),
          assists: (formData.get('attendance') === 'Absent' || formData.get('attendance') === 'Injured') ? 0 : (parseInt(formData.get('assists')) || 0),
          turnovers: (formData.get('attendance') === 'Absent' || formData.get('attendance') === 'Injured') ? 0 : (parseInt(formData.get('turnovers')) || 0),
          fouls: (formData.get('attendance') === 'Absent' || formData.get('attendance') === 'Injured') ? 0 : (parseInt(formData.get('fouls')) || 0),
          
          // Metadata
          updatedAt: new Date().toISOString(),
          updatedBy: currentUser?.email || 'unknown'
        };
        
        console.log('Data to save:', athleteSessionData);
        console.log('Athlete ID being saved:', currentAthleteData.id);
        console.log('Athlete email being saved:', currentAthleteData.email);
        
        // Save to Firestore - use athleteSessionData collection
        const dataId = `${currentAthleteData.id}_${sessionId}`;
        const docRef = doc(db, 'athleteSessionData', dataId);
        
        await setDoc(docRef, athleteSessionData, { merge: true });
        
        console.log('Athlete session data saved successfully');
        alert('Athlete data saved successfully!');
        
        // Close modal
        closeAthleteDataModal();
        
        // Refresh the member display to show updated stats
        const team = teams.find(t => t.id === teamId);
        if (team && sessionId) {
          // Recreate session object for refresh
          const sessionForRefresh = {
            id: sessionId,
            sessionName: sessionName,
            date: sessionDate,
            teamId: teamId,
            teamName: teamName
          };
          await loadSessionMembers(team, sessionForRefresh);
        }
        
      } catch (error) {
        console.error('Error saving athlete data:', error);
        alert('Error saving data: ' + error.message);
      }
    }

    // Modal event listeners
    document.addEventListener('DOMContentLoaded', () => {
      // Close modal when clicking outside
      const modal = document.getElementById('athleteDataModal');
      if (modal) {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            closeAthleteDataModal();
          }
        });
      }
      
      // Save button
      const saveBtn = document.getElementById('saveAthleteData');
      if (saveBtn) {
        saveBtn.addEventListener('click', saveAthleteData);
      }
      
      // Cancel button
      const cancelBtn = document.getElementById('cancelAthleteData');
      if (cancelBtn) {
        cancelBtn.addEventListener('click', closeAthleteDataModal);
      }
      
      // Close button
      const closeBtn = document.querySelector('#athleteDataModal .modal-close');
      if (closeBtn) {
        closeBtn.addEventListener('click', closeAthleteDataModal);
      }
    });

    // Show add training session form
    const addTrainingSessionBtn = document.getElementById('addTrainingSessionBtn');
    if (addTrainingSessionBtn) {
      addTrainingSessionBtn.addEventListener('click', async () => {
        // Make sure teams are loaded
        if (teams.length === 0) {
          await loadTeams();
        }

        // Reset form
        document.getElementById('sessionNameInput').value = '';
        document.getElementById('sessionDateInput').value = '';
        document.getElementById('sessionTimeInput').value = '';
        document.getElementById('sessionDurationInput').value = '';
        document.getElementById('sessionLocationInput').value = '';
        document.getElementById('sessionDescriptionInput').value = '';
        document.getElementById('sessionTeamSelect').value = '';

        // Clear editing state
        window.currentEditingSessionId = null;
        window.isEditingSession = false;

        // Populate team select
        const teamSelect = document.getElementById('sessionTeamSelect');
        teamSelect.innerHTML = '<option value="">Choose a team...</option>';
        if (teams.length === 0) {
          teamSelect.innerHTML += '<option disabled>No teams available</option>';
        } else {
          teams.forEach(team => {
            const option = document.createElement('option');
            option.value = team.id;
            option.textContent = team.name;
            teamSelect.appendChild(option);
          });
        }

        // Switch to add training view
        document.getElementById('trainingListView').style.display = 'none';
        document.getElementById('addTrainingView').style.display = 'block';
      });
    }

    // Back button from add training session
    const backToTrainingListBtn = document.getElementById('backToTrainingListBtn');
    if (backToTrainingListBtn) {
      backToTrainingListBtn.addEventListener('click', () => {
        document.getElementById('trainingListView').style.display = 'block';
        document.getElementById('addTrainingView').style.display = 'none';
      });
    }

    // Cancel button
    const cancelSessionBtn = document.getElementById('cancelSessionBtn');
    if (cancelSessionBtn) {
      cancelSessionBtn.addEventListener('click', () => {
        document.getElementById('trainingListView').style.display = 'block';
        document.getElementById('addTrainingView').style.display = 'none';
      });
    }

    // Save training session
    const saveSessionBtn = document.getElementById('saveSessionBtn');
    if (saveSessionBtn) {
      saveSessionBtn.addEventListener('click', async () => {
        const sessionName = document.getElementById('sessionNameInput').value.trim();
        const sessionDate = document.getElementById('sessionDateInput').value;
        const sessionTime = document.getElementById('sessionTimeInput').value;
        const duration = document.getElementById('sessionDurationInput').value;
        const location = document.getElementById('sessionLocationInput').value.trim();
        const description = document.getElementById('sessionDescriptionInput').value.trim();
        const teamId = document.getElementById('sessionTeamSelect').value;

        if (!sessionName || !sessionDate || !sessionTime || !teamId) {
          alert('Please fill in all required fields (Name, Date, Time, Team)');
          return;
        }

        try {
          const selectedTeam = teams.find(t => t.id === teamId);
          const locationLat = document.getElementById('sessionLocationLat')?.value;
          const locationLng = document.getElementById('sessionLocationLng')?.value;
          
          const sessionData = {
            coachId: currentUser.uid,
            sessionName,
            date: sessionDate,
            time: sessionTime,
            duration: parseInt(duration) || 60,
            location,
            locationLat: locationLat || null,
            locationLng: locationLng || null,
            description,
            teamId,
            teamName: selectedTeam?.name || '',
            createdAt: new Date()
          };

          if (window.isEditingSession && window.currentEditingSessionId) {
            // Update existing session
            await updateDoc(doc(db, 'trainingSessions', window.currentEditingSessionId), sessionData);
            
            // Update local array
            const index = trainingSessions.findIndex(s => s.id === window.currentEditingSessionId);
            if (index !== -1) {
              trainingSessions[index] = {
                id: window.currentEditingSessionId,
                ...sessionData
              };
            }
            
            alert('Training session updated successfully!');
          } else {
            // Create new session using addDoc
            const newSessionRef = await addDoc(collection(db, 'trainingSessions'), sessionData);
            trainingSessions.push({
              id: newSessionRef.id,
              ...sessionData
            });
            
            alert('Training session created successfully!');
          }

          // Reset form and switch back to list
          renderTrainingSessions();
          document.getElementById('trainingListView').style.display = 'block';
          document.getElementById('addTrainingView').style.display = 'none';
          window.currentEditingSessionId = null;
          window.isEditingSession = false;
        } catch (error) {
          console.error('Error saving training session:', error);
          alert('Failed to save training session: ' + error.message);
        }
      });
    }

    // ========== MAP INTEGRATION (LEAFLET/OPENSTREETMAP) ==========
    let map;
    let marker;
    let selectedLocation = null;

    // Initialize map when modal opens
    function initMap() {
      const defaultLocation = [40.7128, -74.0060]; // Default to New York [lat, lng]
      
      // Create map
      map = L.map('map').setView(defaultLocation, 13);

      // Add OpenStreetMap tiles
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 19
      }).addTo(map);

      // Add draggable marker
      marker = L.marker(defaultLocation, { draggable: true }).addTo(map);

      // Update location when marker is dragged
      marker.on('dragend', () => {
        const position = marker.getLatLng();
        selectedLocation = {
          lat: position.lat,
          lng: position.lng
        };
        reverseGeocode(position.lat, position.lng);
      });

      // Add click listener to map
      map.on('click', (e) => {
        marker.setLatLng(e.latlng);
        selectedLocation = {
          lat: e.latlng.lat,
          lng: e.latlng.lng
        };
        reverseGeocode(e.latlng.lat, e.latlng.lng);
      });

      // Request user's current location immediately
      if (navigator.geolocation) {
        // Show loading message
        const mapSearchInput = document.getElementById('mapSearchInput');
        mapSearchInput.placeholder = 'Getting your location...';
        
        navigator.geolocation.getCurrentPosition(
          (position) => {
            // Success - center on user's location
            const userLocation = [position.coords.latitude, position.coords.longitude];
            map.setView(userLocation, 15);
            marker.setLatLng(userLocation);
            selectedLocation = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };
            reverseGeocode(position.coords.latitude, position.coords.longitude);
            mapSearchInput.placeholder = 'Search for a location...';
          },
          (error) => {
            // Error or denied - use default location
            console.error('Location error:', error);
            mapSearchInput.placeholder = 'Location access denied. Search for a location...';
            alert('Please allow location access to use your current position, or search for a location manually.');
          },
          {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 0
          }
        );
      } else {
        alert('Geolocation is not supported by your browser. Please search for a location manually.');
      }
    }

    // Search for location using Nominatim (OpenStreetMap's geocoding service)
    async function searchLocation(query) {
      try {
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
        const results = await response.json();
        
        if (results.length > 0) {
          const result = results[0];
          const lat = parseFloat(result.lat);
          const lng = parseFloat(result.lon);
          
          map.setView([lat, lng], 15);
          marker.setLatLng([lat, lng]);
          selectedLocation = { lat, lng };
          document.getElementById('sessionLocationInput').value = result.display_name;
        } else {
          alert('Location not found. Try a different search term.');
        }
      } catch (error) {
        console.error('Search error:', error);
        alert('Error searching for location.');
      }
    }

    // Reverse geocode to get address from coordinates
    async function reverseGeocode(lat, lng) {
      try {
        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
        const result = await response.json();
        
        if (result.display_name) {
          document.getElementById('sessionLocationInput').value = result.display_name;
        }
      } catch (error) {
        console.error('Reverse geocode error:', error);
      }
    }

    // Open map modal
    document.getElementById('openMapBtn')?.addEventListener('click', () => {
      const mapModal = document.getElementById('mapModal');
      mapModal.style.display = 'flex';
      
      // Initialize map if not already done
      setTimeout(() => {
        if (!map) {
          initMap();
        } else {
          map.invalidateSize();
        }
      }, 100);
    });

    // Search button handler
    document.getElementById('mapSearchInput')?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        const query = e.target.value.trim();
        if (query) {
          searchLocation(query);
        }
      }
    });

    // Close map modal
    document.getElementById('closeMapBtn')?.addEventListener('click', () => {
      document.getElementById('mapModal').style.display = 'none';
    });

    document.getElementById('cancelMapBtn')?.addEventListener('click', () => {
      document.getElementById('mapModal').style.display = 'none';
    });

    // Confirm location
    document.getElementById('confirmLocationBtn')?.addEventListener('click', () => {
      if (selectedLocation) {
        document.getElementById('sessionLocationLat').value = selectedLocation.lat;
        document.getElementById('sessionLocationLng').value = selectedLocation.lng;
      }
      document.getElementById('mapModal').style.display = 'none';
    });

    // Load training sessions when training section is active
    document.querySelector('[data-section="training"]')?.addEventListener('click', () => {
      loadTrainingSessions();
    });

    // Search functionality for training sessions
    const sessionSearchInput = document.getElementById('sessionSearchInput');
    if (sessionSearchInput) {
      sessionSearchInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const sessionCards = document.querySelectorAll('#trainingSessionsList > div');
        
        sessionCards.forEach(card => {
          const sessionName = card.textContent.toLowerCase();
          if (sessionName.includes(searchTerm)) {
            card.style.display = 'flex';
          } else {
            card.style.display = 'none';
          }
        });
      });
    }

    // ========== COMPETITION SECTION ==========
    let competitions = [];
    let currentCompetitionFilter = 'all';

    // Load competitions from Firebase
    async function loadCompetitions() {
      if (!currentUser) return;
      
      try {
        const competitionsRef = collection(db, 'competitions');
        const q = query(competitionsRef, where('coachId', '==', currentUser.uid));
        const querySnapshot = await getDocs(q);
        
        competitions = [];
        querySnapshot.forEach((doc) => {
          competitions.push({
            id: doc.id,
            ...doc.data()
          });
        });
        
        renderCompetitions();
      } catch (error) {
        console.error('Error loading competitions:', error);
      }
    }

    // Render competitions list
    function renderCompetitions() {
      const competitionsList = document.getElementById('competitionsList');
      if (!competitionsList) return;
      
      competitionsList.innerHTML = '';
      
      if (competitions.length === 0) {
        competitionsList.innerHTML = '<p style="text-align:center; color:#666; padding:40px;">No competitions yet. Click "ADD COMPETITION" to create one.</p>';
        return;
      }

      // Filter competitions
      const now = new Date();
      const filteredCompetitions = competitions.filter(comp => {
        if (currentCompetitionFilter === 'all') return true;
        
        const compDate = new Date(comp.date);
        if (currentCompetitionFilter === 'upcoming') {
          return compDate >= now;
        } else if (currentCompetitionFilter === 'completed') {
          return compDate < now;
        }
        return true;
      });

      // Sort by date
      filteredCompetitions.sort((a, b) => new Date(a.date) - new Date(b.date));

      filteredCompetitions.forEach(comp => {
        const compDate = new Date(comp.date);
        const formattedDate = compDate.toLocaleDateString('en-GB', { 
          day: 'numeric',
          month: 'long',
          year: 'numeric'
        });
        
        const compCard = document.createElement('div');
        compCard.className = 'competition-card';
        compCard.innerHTML = `
          <div class="competition-actions">
            <button class="competition-action-btn edit-comp-btn" data-comp-id="${comp.id}">‚úé</button>
            <button class="competition-action-btn delete-comp-btn" data-comp-id="${comp.id}">üóë</button>
          </div>
          
          <div class="competition-team">
            <div class="competition-team-avatar">${comp.team1Name.charAt(0).toUpperCase()}</div>
            <div class="competition-team-name">${comp.team1Name}</div>
          </div>
          
          <div class="competition-details">
            <div class="competition-name">${comp.name}</div>
            <div class="competition-info">${formattedDate.toUpperCase()}</div>
            <div class="competition-info">${comp.time}</div>
            <div class="competition-info">${comp.location}</div>
          </div>
          
          <div class="competition-team">
            <div class="competition-team-avatar">${comp.opponentName.charAt(0).toUpperCase()}</div>
            <div class="competition-team-name">${comp.opponentName}</div>
          </div>
        `;
        
        competitionsList.appendChild(compCard);
      });

      // Add event listeners for edit and delete buttons
      document.querySelectorAll('.edit-comp-btn').forEach(btn => {
        btn.addEventListener('click', () => editCompetition(btn.dataset.compId));
      });

      document.querySelectorAll('.delete-comp-btn').forEach(btn => {
        btn.addEventListener('click', () => deleteCompetition(btn.dataset.compId));
      });
    }

    // Show add competition form
    const addCompetitionBtn = document.getElementById('addCompetitionBtn');
    if (addCompetitionBtn) {
      addCompetitionBtn.addEventListener('click', () => {
        // Populate Team 1 dropdown with coach's teams
        const team1Select = document.getElementById('compTeam1Input');
        team1Select.innerHTML = '<option value="">Select your team...</option>';
        teams.forEach(team => {
          const option = document.createElement('option');
          option.value = team.id;
          option.textContent = team.name;
          team1Select.appendChild(option);
        });

        // Reset form
        document.getElementById('compNameInput').value = '';
        document.getElementById('compDateInput').value = '';
        document.getElementById('compTimeInput').value = '';
        document.getElementById('compLocationInput').value = '';
        document.getElementById('compTeam1Input').value = '';
        document.getElementById('compTeam2Input').value = '';

        // Clear editing state
        window.currentEditingCompId = null;

        // Switch to add competition view
        document.getElementById('competitionListView').style.display = 'none';
        document.getElementById('addCompetitionView').style.display = 'block';
      });
    }

    // Back button from add competition
    const backToCompetitionListBtn = document.getElementById('backToCompetitionListBtn');
    if (backToCompetitionListBtn) {
      backToCompetitionListBtn.addEventListener('click', () => {
        document.getElementById('competitionListView').style.display = 'block';
        document.getElementById('addCompetitionView').style.display = 'none';
      });
    }

    // Cancel button
    const cancelCompetitionBtn = document.getElementById('cancelCompetitionBtn');
    if (cancelCompetitionBtn) {
      cancelCompetitionBtn.addEventListener('click', () => {
        document.getElementById('competitionListView').style.display = 'block';
        document.getElementById('addCompetitionView').style.display = 'none';
      });
    }

    // Save competition
    const saveCompetitionBtn = document.getElementById('saveCompetitionBtn');
    if (saveCompetitionBtn) {
      saveCompetitionBtn.addEventListener('click', async () => {
        const name = document.getElementById('compNameInput').value;
        const date = document.getElementById('compDateInput').value;
        const time = document.getElementById('compTimeInput').value;
        const location = document.getElementById('compLocationInput').value;
        const team1Id = document.getElementById('compTeam1Input').value;
        const team2 = document.getElementById('compTeam2Input').value;

        if (!name || !date || !time || !location || !team1Id || !team2) {
          alert('Please fill in all fields');
          return;
        }

        try {
          // Get the team name from the selected team ID
          const selectedTeam = teams.find(t => t.id === team1Id);
          const team1Name = selectedTeam ? selectedTeam.name : 'Unknown Team';

          const competitionData = {
            competitionName: name,
            date,
            time,
            location,
            team1Id: team1Id,
            team1Name: team1Name,
            opponentName: team2,
            coachId: currentUser.uid,
            createdAt: new Date().toISOString()
          };

          if (window.currentEditingCompId) {
            // Update existing competition
            const compRef = doc(db, 'competitions', window.currentEditingCompId);
            await updateDoc(compRef, competitionData);
            
            // Update local array
            const index = competitions.findIndex(c => c.id === window.currentEditingCompId);
            if (index !== -1) {
              competitions[index] = {
                id: window.currentEditingCompId,
                ...competitionData
              };
            }
            
            alert('Competition updated successfully!');
          } else {
            // Create new competition
            const newCompRef = await addDoc(collection(db, 'competitions'), competitionData);
            competitions.push({
              id: newCompRef.id,
              ...competitionData
            });
            
            alert('Competition created successfully!');
          }

          // Reset form and switch back to list
          renderCompetitions();
          document.getElementById('competitionListView').style.display = 'block';
          document.getElementById('addCompetitionView').style.display = 'none';
          window.currentEditingCompId = null;
        } catch (error) {
          console.error('Error saving competition:', error);
          alert('Failed to save competition: ' + error.message);
        }
      });
    }

    // Edit competition
    async function editCompetition(compId) {
      const competition = competitions.find(c => c.id === compId);
      if (!competition) return;

      // Populate form
      document.getElementById('compNameInput').value = competition.name;
      document.getElementById('compDateInput').value = competition.date;
      document.getElementById('compTimeInput').value = competition.time;
      document.getElementById('compLocationInput').value = competition.location;
      document.getElementById('compTeam1Input').value = competition.team1;
      document.getElementById('compTeam2Input').value = competition.team2;

      // Set editing state
      window.currentEditingCompId = compId;

      // Switch to edit view
      document.getElementById('competitionListView').style.display = 'none';
      document.getElementById('addCompetitionView').style.display = 'block';
    }

    // Delete competition
    async function deleteCompetition(compId) {
      if (!confirm('Are you sure you want to delete this competition?')) return;

      try {
        await deleteDoc(doc(db, 'competitions', compId));
        competitions = competitions.filter(c => c.id !== compId);
        renderCompetitions();
        alert('Competition deleted successfully!');
      } catch (error) {
        console.error('Error deleting competition:', error);
        alert('Failed to delete competition: ' + error.message);
      }
    }

    // Competition filter buttons
    const competitionFilters = document.querySelectorAll('.competition-filter');
    competitionFilters.forEach(filter => {
      filter.addEventListener('click', () => {
        competitionFilters.forEach(f => f.classList.remove('active'));
        filter.classList.add('active');
        currentCompetitionFilter = filter.dataset.filter;
        renderCompetitions();
      });
    });

    // Load competitions when competition section is active
    document.querySelector('[data-section="competition"]')?.addEventListener('click', () => {
      loadCompetitions();
    });

    // ========== ENHANCED STATISTICS SECTION ==========

    // Load and display teams in statistics view
    async function loadStatisticsData() {
      try {
        // Make sure teams are loaded
        if (teams.length === 0) {
          await loadTeams();
        }

        // Fetch fresh team data with member counts before rendering
        await refreshTeamsWithMemberCounts();

        // Show teams overview
        renderTeamsOverview();
        document.getElementById('teams-overview-view').style.display = 'block';
        document.getElementById('team-stats-detail-view').style.display = 'none';
        document.getElementById('member-stats-detail-view').style.display = 'none';
      } catch (error) {
        console.error('Error loading statistics:', error);
      }
    }

    // Refresh teams data with accurate member counts
    async function refreshTeamsWithMemberCounts() {
      try {
        console.log('Refreshing teams with member counts...');
        
        for (let i = 0; i < teams.length; i++) {
          const team = teams[i];
          const teamDoc = await getDoc(doc(db, 'teams', team.id));
          
          if (teamDoc.exists()) {
            const freshTeamData = teamDoc.data();
            console.log(`Fresh data for team ${team.name}:`, freshTeamData);
            
            // Update the team in the teams array with fresh data including memberIds
            teams[i] = {
              ...team,
              ...freshTeamData,
              memberCount: freshTeamData.memberIds ? freshTeamData.memberIds.length : 0
            };
            
            console.log(`Updated team ${team.name} member count:`, teams[i].memberCount);
          } else {
            // Fallback to existing member count if available
            teams[i].memberCount = team.members ? team.members.length : 0;
          }
        }
        
        console.log('All teams refreshed with member counts:', teams);
      } catch (error) {
        console.error('Error refreshing teams data:', error);
        // Fallback to existing data
        teams.forEach((team, index) => {
          teams[index].memberCount = team.members ? team.members.length : 0;
        });
      }
    }

    // Render teams list in clean card layout
    function renderTeamsOverview() {
      const teamsList = document.getElementById('cleanTeamsList');
      if (!teamsList) {
        console.error('cleanTeamsList element not found');
        return;
      }

      console.log('Rendering teams overview, teams count:', teams.length);

      if (teams.length === 0) {
        teamsList.innerHTML = '<div style="grid-column: 1/-1; padding: 40px; text-align: center; color: #666; font-family: Arial, sans-serif;">No teams available. Create your first team to get started!</div>';
        return;
      }

      teamsList.innerHTML = teams.map(team => {
        // Use the refreshed member count or fallback to calculating it
        let memberCount = 0;
        if (team.memberCount !== undefined) {
          memberCount = team.memberCount;
        } else if (team.memberIds) {
          memberCount = team.memberIds.length;
        } else if (team.members) {
          memberCount = team.members.length;
        }
        
        console.log(`Team ${team.name} member count:`, memberCount);
        
        return `
          <div class="clean-team-card" onclick="showTeamDetail('${team.id}')">
            <div class="team-card-header">
              <div class="team-card-avatar">
                ${team.image ? `<img src="${team.image}" alt="${team.name}">` : team.name.charAt(0).toUpperCase()}
              </div>
              <div class="team-card-info">
                <h4>${team.name}</h4>
                <p>${memberCount} member${memberCount !== 1 ? 's' : ''}</p>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Show team detail view with overall team statistics
    async function showTeamDetail(teamId) {
      console.log('üîç showTeamDetail called with teamId:', teamId);
      
      currentSelectedTeam = teams.find(t => t.id === teamId);
      if (!currentSelectedTeam) {
        console.error('‚ùå Team not found:', teamId);
        console.log('Available teams:', teams.map(t => ({ id: t.id, name: t.name })));
        return;
      }

      console.log('Showing team detail for:', currentSelectedTeam);

      // Update team header
      document.getElementById('teamDetailTitle').textContent = currentSelectedTeam.name;
      
      // Fetch fresh team data with members from Firebase
      try {
        const teamDoc = await getDoc(doc(db, 'teams', teamId));
        if (teamDoc.exists()) {
          const teamData = teamDoc.data();
          console.log('Fetched team data:', teamData);
          
          // Update the team object with fresh data
          currentSelectedTeam = { id: teamId, ...teamData };
          
          // Update quick stats with real member count
          const memberCount = teamData.memberIds ? teamData.memberIds.length : 0;
          document.getElementById('totalMembers').textContent = memberCount;
          document.getElementById('avgTeamPerformance').textContent = '8.5'; // Placeholder
          document.getElementById('totalSessions').textContent = '12'; // Placeholder

          // Load team members list with fresh data
          await loadTeamMembersWithProfiles(teamData.memberIds || []);
        } else {
          console.log('Team document not found');
          // Fallback to existing team data
          const memberCount = currentSelectedTeam.members ? currentSelectedTeam.members.length : 0;
          document.getElementById('totalMembers').textContent = memberCount;
          document.getElementById('avgTeamPerformance').textContent = '8.5'; // Placeholder
          document.getElementById('totalSessions').textContent = '12'; // Placeholder
          
          await loadTeamMembersList(teamId);
        }
      } catch (error) {
        console.error('Error fetching team data:', error);
        // Fallback to existing team data
        const memberCount = currentSelectedTeam.members ? currentSelectedTeam.members.length : 0;
        document.getElementById('totalMembers').textContent = memberCount;
        document.getElementById('avgTeamPerformance').textContent = '8.5'; // Placeholder
        document.getElementById('totalSessions').textContent = '12'; // Placeholder
        
        await loadTeamMembersList(teamId);
      }

      // Show team detail view
      document.getElementById('teams-overview-view').style.display = 'none';
      document.getElementById('team-stats-detail-view').style.display = 'block';
      document.getElementById('member-stats-detail-view').style.display = 'none';

      // Load team graphs (placeholders for now)
      loadTeamOverviewGraphs(teamId);
    }

    // Load team members with their profiles from Firebase
    async function loadTeamMembersWithProfiles(memberIds) {
      const membersContainer = document.getElementById('teamMembersList');
      if (!membersContainer) return;

      console.log('Loading members with profiles for IDs:', memberIds);

      if (!memberIds || memberIds.length === 0) {
        membersContainer.innerHTML = '<div style="padding: 40px; text-align: center; color: #666; font-family: Arial, sans-serif;">No members in this team yet. Add members to get started!</div>';
        return;
      }

      try {
        const memberProfiles = [];
        
        // Fetch each member's profile
        for (const memberId of memberIds) {
          console.log('Fetching profile for member ID:', memberId);
          const memberDoc = await getDoc(doc(db, 'profiles', memberId));
          if (memberDoc.exists()) {
            const memberData = memberDoc.data();
            console.log('Found member profile:', memberData);
            memberProfiles.push({
              id: memberId,
              name: memberData.fullName || memberData.name || 'Unknown',
              studentId: memberData.studentId || memberId,
              position: memberData.position || 'Player',
              email: memberData.email || '',
              ...memberData
            });
          } else {
            console.log('Profile not found for member ID:', memberId);
            // Add placeholder for missing profile
            memberProfiles.push({
              id: memberId,
              name: 'Unknown Member',
              studentId: memberId,
              position: 'Player'
            });
          }
        }

        console.log('All member profiles loaded:', memberProfiles);

        // Render the members list
        if (memberProfiles.length === 0) {
          membersContainer.innerHTML = '<div style="padding: 40px; text-align: center; color: #666; font-family: Arial, sans-serif;">No member profiles found.</div>';
          return;
        }

        membersContainer.innerHTML = memberProfiles.map(member => `
          <div class="member-row" onclick="showMemberDetail('${member.studentId}', '${member.name}', '${member.position}')">
            <div class="member-info">
              <div class="member-avatar">${member.name.charAt(0).toUpperCase()}</div>
              <div class="member-details">
                <div class="member-name">${member.name}</div>
                <div class="member-student-id">ID: ${member.studentId}</div>
              </div>
            </div>
            <button class="view-stats-btn" onclick="event.stopPropagation(); showMemberDetail('${member.studentId}', '${member.name}', '${member.position}')">
              View Stats
            </button>
          </div>
        `).join('');

      } catch (error) {
        console.error('Error loading member profiles:', error);
        membersContainer.innerHTML = '<div style="padding: 40px; text-align: center; color: #666; font-family: Arial, sans-serif;">Error loading team members. Please try again.</div>';
      }
    }

    // Load team members as rows (fallback for old team format)
    async function loadTeamMembersList(teamId) {
      const membersContainer = document.getElementById('teamMembersList');
      if (!membersContainer) return;

      console.log('Loading team members (fallback method) for team:', currentSelectedTeam);

      const team = teams.find(t => t.id === teamId) || currentSelectedTeam;
      
      // Check if we have members in the old format
      if (team && team.members && team.members.length > 0) {
        console.log('Using old members format:', team.members);
        
        membersContainer.innerHTML = team.members.map(member => `
          <div class="member-row" onclick="showMemberDetail('${member.studentId}', '${member.name}', '${member.position || 'Player'}')">
            <div class="member-info">
              <div class="member-avatar">${member.name.charAt(0).toUpperCase()}</div>
              <div class="member-details">
                <div class="member-name">${member.name}</div>
                <div class="member-student-id">ID: ${member.studentId}</div>
              </div>
            </div>
            <button class="view-stats-btn" onclick="event.stopPropagation(); showMemberDetail('${member.studentId}', '${member.name}', '${member.position || 'Player'}')">
              View Stats
            </button>
          </div>
        `).join('');
        
      } else if (team && team.memberIds && team.memberIds.length > 0) {
        console.log('Found memberIds, calling loadTeamMembersWithProfiles');
        // If we have memberIds, use the new method
        await loadTeamMembersWithProfiles(team.memberIds);
        
      } else {
        console.log('No members found for team');
        membersContainer.innerHTML = '<div style="padding: 40px; text-align: center; color: #666; font-family: Arial, sans-serif;">No members in this team yet. Add members to get started!</div>';
      }
    }

    // Load team overview graphs with real-time updates
    async function loadTeamOverviewGraphs(teamId) {
      try {
        console.log('üîÑ Loading team performance analytics with real-time updates...');
        
        // Clear any existing listeners
        clearChartRefreshListeners();
        
        // Initialize or reuse global analytics engine
        if (!globalTeamAnalytics) {
          globalTeamAnalytics = new TeamPerformanceAnalytics();
        }
        
        // Store analytics instance globally for cleanup
        window.teamAnalytics = globalTeamAnalytics;
        
        // Set up real-time chart refresh
        setupTeamChartRealTimeRefresh(teamId, globalTeamAnalytics);
        
        // Initial load
        await refreshTeamCharts(teamId, globalTeamAnalytics);
        
      } catch (error) {
        console.error('Error setting up team performance graphs:', error);
        showTeamPlaceholders();
      }
    }
    
    // Setup real-time chart refresh listeners
    function setupTeamChartRealTimeRefresh(teamId, analytics) {
      if (!autoRefreshEnabled) return;
      
      console.log('üîÑ Setting up real-time chart refresh for team:', teamId);
      
      // Debounced refresh function to prevent rapid-fire updates
      const debouncedRefresh = (eventType) => {
        // Clear existing timeout for this event type
        if (chartRefreshTimeouts.has(eventType)) {
          clearTimeout(chartRefreshTimeouts.get(eventType));
        }
        
        // Set new timeout
        const timeoutId = setTimeout(async () => {
          console.log(`${eventType} updated, refreshing charts...`);
          await refreshTeamCharts(teamId, analytics);
          chartRefreshTimeouts.delete(eventType);
        }, 500); // 500ms debounce
        
        chartRefreshTimeouts.set(eventType, timeoutId);
      };
      
      // Listen for training session changes
      const sessionsQuery = query(collection(db, 'trainingSessions'), where('teamId', '==', teamId));
      const sessionsUnsubscribe = onSnapshot(sessionsQuery, () => {
        debouncedRefresh('üìà Training sessions');
      });
      
      // Listen for athlete session data changes
      const athleteDataQuery = query(collection(db, 'athleteSessionData'), where('teamId', '==', teamId));
      const athleteDataUnsubscribe = onSnapshot(athleteDataQuery, () => {
        debouncedRefresh('üë• Athlete data');
      });
      
      // Store listeners for cleanup
      chartRefreshListeners.push(sessionsUnsubscribe, athleteDataUnsubscribe);
    }
    
    // Refresh team charts with latest data
    async function refreshTeamCharts(teamId, analytics) {
      try {
        // Fetch training sessions for this team
        const trainingSessions = await fetchTeamTrainingSessions(teamId);
        console.log('Fetched training sessions:', trainingSessions);
        
        if (trainingSessions.length === 0) {
          showTeamPlaceholders();
          return;
        }
        
        // Fetch athlete session data for all sessions
        const athleteSessionData = await fetchAllAthleteSessionData(trainingSessions);
        console.log('Fetched athlete session data:', athleteSessionData);
        
        // Calculate team performance trends
        const performanceData = analytics.calculateTeamPerformanceTrend(trainingSessions, athleteSessionData);
        console.log('Performance analytics result:', performanceData);
        
        if (performanceData.sessionStats.length > 0) {
          // Render the team performance trend chart
          analytics.renderChart('teamPerformanceTrendChart', performanceData.sessionStats, currentSelectedTeam.name);
          
          // Display summary statistics
          displayTeamSummaryStats(performanceData.summary);
          
          // Show the chart, hide placeholder
          document.getElementById('teamPerformanceTrendChart').style.display = 'block';
          document.getElementById('teamTrendPlaceholder').style.display = 'none';
        } else {
          document.getElementById('teamPerformanceTrendChart').style.display = 'none';
          document.getElementById('teamTrendPlaceholder').style.display = 'block';
        }
        
        // Calculate and render player average points chart
        const playerData = analytics.calculatePlayerAveragePoints(trainingSessions, athleteSessionData);
        console.log('Player performance analytics result:', playerData);
        
        if (playerData.playerStats.length > 0) {
          // Render the player average points bar chart
          analytics.renderPlayerAverageChart('teamAverageStatsChart', playerData.playerStats, currentSelectedTeam.name);
          
          // Display player summary statistics
          displayPlayerSummaryStats(playerData.summary);
          
          // Show the chart, hide placeholder
          document.getElementById('teamAverageStatsChart').style.display = 'block';
          document.getElementById('teamAvgPlaceholder').style.display = 'none';
        } else {
          document.getElementById('teamAverageStatsChart').style.display = 'none';
          document.getElementById('teamAvgPlaceholder').style.display = 'block';
        }
        
      } catch (error) {
        console.error('Error refreshing team charts:', error);
        showTeamPlaceholders();
      }
    }
    
    // Show team chart placeholders
    function showTeamPlaceholders() {
      document.getElementById('teamPerformanceTrendChart').style.display = 'none';
      document.getElementById('teamTrendPlaceholder').style.display = 'block';
      document.getElementById('teamAverageStatsChart').style.display = 'none';
      document.getElementById('teamAvgPlaceholder').style.display = 'block';
    }
    
    // Clear all chart refresh listeners
    function clearChartRefreshListeners() {
      // Clear Firebase listeners
      chartRefreshListeners.forEach(unsubscribe => {
        if (typeof unsubscribe === 'function') {
          unsubscribe();
        }
      });
      chartRefreshListeners = [];
      
      // Clear any pending chart refresh timeouts
      chartRefreshTimeouts.forEach(timeoutId => clearTimeout(timeoutId));
      chartRefreshTimeouts.clear();
      
      // Destroy any existing charts using the global analytics instance
      if (globalTeamAnalytics) {
        if (globalTeamAnalytics.chartInstance) {
          globalTeamAnalytics.chartInstance.destroy();
          globalTeamAnalytics.chartInstance = null;
        }
        if (globalTeamAnalytics.playerChartInstance) {
          globalTeamAnalytics.playerChartInstance.destroy();
          globalTeamAnalytics.playerChartInstance = null;
        }
      }
      
      // Also destroy via window reference (fallback)
      if (window.teamAnalytics) {
        if (window.teamAnalytics.chartInstance) {
          window.teamAnalytics.chartInstance.destroy();
          window.teamAnalytics.chartInstance = null;
        }
        if (window.teamAnalytics.playerChartInstance) {
          window.teamAnalytics.playerChartInstance.destroy();
          window.teamAnalytics.playerChartInstance = null;
        }
      }
      
      // Clear any Chart.js instances on common canvas IDs
      ['teamPerformanceTrendChart', 'teamAverageStatsChart'].forEach(canvasId => {
        const canvas = document.getElementById(canvasId);
        if (canvas) {
          const existingChart = Chart.getChart(canvas);
          if (existingChart) {
            existingChart.destroy();
          }
        }
      });
      
      console.log('üßπ Cleared chart refresh listeners');
    }

    // Show individual member statistics with three graphs
    async function showMemberDetail(studentId, memberName, position) {
      currentSelectedMember = { studentId, name: memberName, position };
      
      // Update member header
      document.getElementById('memberDetailTitle').textContent = memberName;
      document.getElementById('memberStudentId').textContent = studentId;
      document.getElementById('memberPosition').textContent = position;
      document.getElementById('memberAvatarText').textContent = memberName.charAt(0).toUpperCase();

      // Show member detail view
      document.getElementById('teams-overview-view').style.display = 'none';
      document.getElementById('team-stats-detail-view').style.display = 'none';
      document.getElementById('member-stats-detail-view').style.display = 'block';

      // Load individual member graphs and data
      loadMemberGraphs(studentId);
      loadMemberSessionsSummary(studentId);
    }

    // Load individual member graphs with comprehensive 6-metric system
    async function loadMemberGraphs(studentId) {
      try {
        console.log('üìä Loading comprehensive athlete performance metrics for:', studentId);
        
        // Clear any existing listeners
        clearChartRefreshListeners();
        
        // Initialize or reuse global analytics engine
        if (!globalTeamAnalytics) {
          globalTeamAnalytics = new TeamPerformanceAnalytics();
        }
        
        // Set up real-time member chart refresh
        setupMemberChartRealTimeRefresh(studentId, globalTeamAnalytics);
        
        // Initial load of all 6 performance metrics
        await refreshAthleteMetricCharts(studentId, globalTeamAnalytics);
        
      } catch (error) {
        console.error('Error loading athlete performance metrics:', error);
        showAthleteMetricPlaceholders();
      }
    }
    
    // Setup real-time member chart refresh listeners
    function setupMemberChartRealTimeRefresh(studentId, analytics) {
      if (!autoRefreshEnabled) return;
      
      console.log('üîÑ Setting up real-time athlete performance refresh for:', studentId);
      
      // Debounced refresh for athlete metrics
      const debouncedAthleteRefresh = () => {
        if (chartRefreshTimeouts.has('athlete-metrics')) {
          clearTimeout(chartRefreshTimeouts.get('athlete-metrics'));
        }
        
        const timeoutId = setTimeout(async () => {
          console.log('üë§ Athlete data updated, refreshing performance metrics...');
          await refreshAthleteMetricCharts(studentId, analytics);
          chartRefreshTimeouts.delete('athlete-metrics');
        }, 300); // 300ms debounce for athlete charts
        
        chartRefreshTimeouts.set('athlete-metrics', timeoutId);
      };
      
      // Listen for athlete session data changes for this specific member
      const memberDataQuery = query(collection(db, 'athleteSessionData'), where('athleteId', '==', studentId));
      const memberDataUnsubscribe = onSnapshot(memberDataQuery, debouncedAthleteRefresh);
      
      // Store listener for cleanup
      chartRefreshListeners.push(memberDataUnsubscribe);
    }
    
    // Refresh all 6 athlete metric charts with latest data
    async function refreshAthleteMetricCharts(studentId, analytics) {
      try {
        // Fetch athlete session data for this member
        const athleteSessionData = await fetchAthleteSessionData(studentId);
        console.log('üîç RAW Athlete session data for', studentId, ':', athleteSessionData);
        
        // Log each session with details
        athleteSessionData.forEach((session, index) => {
          console.log(`üìä Session ${index + 1}:`, {
            date: session.sessionDate,
            name: session.sessionName,
            points: session.points,
            sessionId: session.sessionId,
            teamId: session.teamId,
            fullData: session
          });
        });
        
        if (athleteSessionData.length === 0) {
          showAthleteMetricPlaceholders();
          return;
        }
        
        // Calculate comprehensive athlete performance metrics
        const athletePerformance = analytics.calculateAthletePerformanceMetrics(athleteSessionData);
        console.log('Athlete performance result:', athletePerformance);
        
        if (!athletePerformance.sessionMetrics || athletePerformance.sessionMetrics.length === 0) {
          showAthleteMetricPlaceholders();
          return;
        }
        
        // Define the 6 specific metrics and their chart configurations
        const metricConfigs = [
          { metric: 'points', canvasId: 'athletePointsChart', color: '#1976d2', label: 'Points' },
          { metric: 'rebounds', canvasId: 'athleteReboundsChart', color: '#2e7d32', label: 'Rebounds' },
          { metric: 'assists', canvasId: 'athleteAssistsChart', color: '#f57c00', label: 'Assists' },
          { metric: 'turnovers', canvasId: 'athleteTurnoversChart', color: '#d32f2f', label: 'Turnovers' },
          { metric: 'fouls', canvasId: 'athleteFoulsChart', color: '#c2185b', label: 'Fouls' },
          { metric: 'rpe', canvasId: 'athleteRpeChart', color: '#7b1fa2', label: 'RPE' }
        ];
        
        // Render each of the 6 performance charts
        metricConfigs.forEach(config => {
          analytics.renderAthleteMetricChart(
            config.canvasId, 
            athletePerformance.sessionMetrics, 
            config.metric, 
            currentSelectedMember?.name || 'Athlete',
            config.color
          );
        });
        
        // Update performance summary with comprehensive stats
        if (athletePerformance.summary) {
          updateAthletePerformanceSummary(athletePerformance.summary, currentSelectedMember?.name || 'Athlete');
        }
        
        // Load sessions table
        loadAthleteSessionsTable(athleteSessionData, currentSelectedMember?.name || 'Athlete');
        
      } catch (error) {
        console.error('Error refreshing athlete metric charts:', error);
        showAthleteMetricPlaceholders();
      }
    }
    
    // Show placeholders for all athlete metric charts
    function showAthleteMetricPlaceholders() {
      const metrics = ['Points', 'Rebounds', 'Assists', 'Turnovers', 'Fouls', 'Rpe'];
      
      metrics.forEach(metric => {
        const placeholder = document.getElementById(`athlete${metric}Placeholder`);
        const chart = document.getElementById(`athlete${metric}Chart`);
        
        if (placeholder && chart) {
          chart.style.display = 'none';
          placeholder.style.display = 'block';
        }
      });
    }
    
    // Update athlete performance summary with comprehensive stats
    function updateAthletePerformanceSummary(summary, athleteName) {
      console.log(`üë§ ${athleteName} Performance Summary:`, summary);
      
      const summaryContainer = document.getElementById('athletePerformanceSummary');
      if (!summaryContainer || !summary) {
        console.log('‚ùå No summary container or summary data');
        return;
      }

      // Check if we have averages data
      if (!summary.averages) {
        console.log('‚ùå No averages data in summary:', summary);
        return;
      }
      
      // Create performance summary cards using the correct property structure
      const summaryCards = [
        { label: 'Avg Points', value: summary.averages.points?.toFixed(1) || '0.0', icon: 'üìä', color: '#1976d2' },
        { label: 'Avg Rebounds', value: summary.averages.rebounds?.toFixed(1) || '0.0', icon: 'üèÄ', color: '#2e7d32' },
        { label: 'Avg Assists', value: summary.averages.assists?.toFixed(1) || '0.0', icon: 'ü§ù', color: '#f57c00' },
        { label: 'Avg Turnovers', value: summary.averages.turnovers?.toFixed(1) || '0.0', icon: '‚ö†Ô∏è', color: '#d32f2f' },
        { label: 'Avg Fouls', value: summary.averages.fouls?.toFixed(1) || '0.0', icon: 'üö´', color: '#c2185b' },
        { label: 'Avg RPE', value: summary.averages.rpe?.toFixed(1) || '0.0', icon: 'üí™', color: '#7b1fa2' }
      ];

      console.log('üìä Summary cards data:', summaryCards);
      
      summaryContainer.innerHTML = summaryCards.map(card => `
        <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); text-align: center; border-left: 4px solid ${card.color};">
          <div style="font-size: 24px; margin-bottom: 8px;">${card.icon}</div>
          <div style="font-size: 24px; font-weight: bold; color: ${card.color}; margin-bottom: 5px;">${card.value}</div>
          <div style="color: #666; font-size: 14px; font-weight: 500;">${card.label}</div>
        </div>
      `).join('');

      console.log('‚úÖ Updated athlete performance summary cards');
    }
    
    // Fetch athlete session data for a specific member
    async function fetchAthleteSessionData(studentId) {
      try {
        // Query athlete session data for this member
        const athleteQuery = query(
          collection(db, 'athleteSessionData'),
          where('athleteId', '==', studentId)
        );
        
        const athleteSnapshot = await getDocs(athleteQuery);
        const sessionData = [];
        
        athleteSnapshot.forEach(doc => {
          sessionData.push({
            id: doc.id,
            ...doc.data()
          });
        });
        
        // Sort by session date
        sessionData.sort((a, b) => new Date(a.sessionDate) - new Date(b.sessionDate));
        
        return sessionData;
      } catch (error) {
        console.error('Error fetching athlete session data:', error);
        return [];
      }
    }

    // Debug function to find and clean unwanted session data
    window.debugAthleteData = async function(studentId) {
      try {
        console.log('üîç Debugging athlete data for:', studentId);
        
        // Get all athlete session data
        const athleteQuery = query(
          collection(db, 'athleteSessionData'),
          where('athleteId', '==', studentId)
        );
        
        const snapshot = await getDocs(athleteQuery);
        const allData = [];
        
        snapshot.forEach(doc => {
          allData.push({
            id: doc.id,
            ...doc.data()
          });
        });
        
        console.log('üìä All athlete session data:', allData);
        
        // Group by date
        const dataByDate = {};
        allData.forEach(session => {
          const date = session.sessionDate;
          if (!dataByDate[date]) dataByDate[date] = [];
          dataByDate[date].push(session);
        });
        
        console.log('üìÖ Data grouped by date:', dataByDate);
        
        // Find December 8th data specifically
        const dec8Data = allData.filter(session => 
          session.sessionDate === '2025-12-08' || 
          session.sessionDate === '2024-12-08' ||
          session.sessionDate.includes('12-08') ||
          session.sessionDate.includes('12/08')
        );
        
        if (dec8Data.length > 0) {
          console.log('üö® Found December 8th data that might be unwanted:', dec8Data);
          console.log('üìã To remove this data, run: removeUnwantedData("' + studentId + '", "2025-12-08")');
        }
        
        return { allData, dataByDate, dec8Data };
        
      } catch (error) {
        console.error('Error debugging athlete data:', error);
      }
    };
    
    // Function to remove unwanted session data
    window.removeUnwantedData = async function(studentId, sessionDate) {
      try {
        console.log('üóëÔ∏è Removing unwanted data for', studentId, 'on', sessionDate);
        
        const athleteQuery = query(
          collection(db, 'athleteSessionData'),
          where('athleteId', '==', studentId),
          where('sessionDate', '==', sessionDate)
        );
        
        const snapshot = await getDocs(athleteQuery);
        const deletePromises = [];
        
        snapshot.forEach(doc => {
          console.log('üóëÔ∏è Deleting document:', doc.id, doc.data());
          deletePromises.push(deleteDoc(doc.ref));
        });
        
        await Promise.all(deletePromises);
        console.log('‚úÖ Successfully removed unwanted data for', sessionDate);
        
        // Refresh the current view if we're looking at this athlete
        if (currentSelectedMember && currentSelectedMember.studentId === studentId) {
          console.log('üîÑ Refreshing athlete charts...');
          await refreshAthleteMetricCharts(studentId, globalTeamAnalytics);
        }
        
      } catch (error) {
        console.error('Error removing unwanted data:', error);
      }
    };

    // Quick function to remove December 8th data for current selected member
    window.quickCleanDec8 = async function() {
      if (!currentSelectedMember) {
        console.log('‚ùå No athlete selected. Please select an athlete first.');
        return;
      }
      
      const studentId = currentSelectedMember.studentId;
      console.log('üßπ Cleaning December 8th data for:', studentId);
      
      try {
        // Find all sessions for this athlete on December 8th (multiple date formats)
        const athleteQuery = query(
          collection(db, 'athleteSessionData'),
          where('athleteId', '==', studentId)
        );
        
        const snapshot = await getDocs(athleteQuery);
        const toDelete = [];
        
        snapshot.forEach(doc => {
          const data = doc.data();
          const sessionDate = data.sessionDate;
          
          // Check if it's December 8th in any format
          if (sessionDate && (
            sessionDate === '2025-12-08' || 
            sessionDate === '2024-12-08' ||
            sessionDate === '12-08-2025' ||
            sessionDate === '12/08/2025' ||
            sessionDate === '08-12-2025' ||
            sessionDate === '08/12/2025' ||
            sessionDate.includes('2025-12-08') ||
            sessionDate.includes('12-08') ||
            sessionDate.includes('Dec 8') ||
            sessionDate.includes('December 8')
          )) {
            console.log('üóëÔ∏è Found December 8th data to delete:', doc.id, data);
            toDelete.push(doc.ref);
          }
        });
        
        if (toDelete.length > 0) {
          console.log(`üóëÔ∏è Deleting ${toDelete.length} December 8th records...`);
          await Promise.all(toDelete.map(ref => deleteDoc(ref)));
          console.log('‚úÖ Successfully deleted December 8th data!');
          
          // Refresh the athlete charts
          await refreshAthleteMetricCharts(studentId, globalTeamAnalytics);
          console.log('üîÑ Charts refreshed!');
        } else {
          console.log('‚úÖ No December 8th data found to delete.');
        }
        
      } catch (error) {
        console.error('‚ùå Error cleaning December 8th data:', error);
      }
    };

    // Clean up any suspicious session data (unusual names, test data)
    window.cleanSuspiciousData = async function() {
      if (!currentSelectedMember) {
        console.log('‚ùå No athlete selected. Please select an athlete first.');
        return;
      }
      
      const studentId = currentSelectedMember.studentId;
      console.log('üßπ Cleaning suspicious/test data for:', studentId);
      
      try {
        const athleteQuery = query(
          collection(db, 'athleteSessionData'),
          where('athleteId', '==', studentId)
        );
        
        const snapshot = await getDocs(athleteQuery);
        const toDelete = [];
        const suspiciousNames = ['sdgsdg', 'test', 'sample', 'demo', 'asdf', 'qwerty', 'xxx', '123'];
        
        snapshot.forEach(doc => {
          const data = doc.data();
          const sessionName = (data.sessionName || '').toLowerCase();
          const sessionDate = data.sessionDate;
          
          // Check for suspicious session names or December 8th
          const isSuspicious = suspiciousNames.some(name => sessionName.includes(name));
          const isDec8 = sessionDate && (
            sessionDate === '2025-12-08' || 
            sessionDate.includes('12-08') ||
            sessionDate.includes('Dec 8')
          );
          
          if (isSuspicious || isDec8) {
            console.log('üóëÔ∏è Found suspicious data to delete:', doc.id, data);
            toDelete.push(doc.ref);
          }
        });
        
        if (toDelete.length > 0) {
          console.log(`üóëÔ∏è Deleting ${toDelete.length} suspicious records...`);
          await Promise.all(toDelete.map(ref => deleteDoc(ref)));
          console.log('‚úÖ Successfully deleted suspicious data!');
          
          // Refresh the athlete charts
          await refreshAthleteMetricCharts(studentId, globalTeamAnalytics);
          console.log('üîÑ Charts refreshed!');
        } else {
          console.log('‚úÖ No suspicious data found to delete.');
        }
        
      } catch (error) {
        console.error('‚ùå Error cleaning suspicious data:', error);
      }
    };

    // Universal cleanup function - delete ALL unwanted session data
    window.universalCleanup = async function() {
      console.log('üßπ Starting universal cleanup of unwanted session data...');
      
      try {
        // Get all athlete session data
        const allAthleteData = await getDocs(collection(db, 'athleteSessionData'));
        const toDelete = [];
        
        // Define unwanted patterns
        const unwantedNames = ['sdgsdg', 'strength', 'test', 'sample', 'demo', 'asdf', 'qwerty', 'xxx', '123'];
        const unwantedDates = ['2024-12-07', '2024-12-08', '2025-12-07', '2025-12-08', '12-07', '12-08', 'Dec 7', 'Dec 8', 'December 7', 'December 8'];
        
        allAthleteData.forEach(doc => {
          const data = doc.data();
          const sessionName = (data.sessionName || '').toLowerCase();
          const sessionDate = data.sessionDate || '';
          const description = (data.description || '').toLowerCase();
          
          // Check for unwanted session names
          const hasUnwantedName = unwantedNames.some(name => sessionName.includes(name));
          
          // Check for unwanted dates
          const hasUnwantedDate = unwantedDates.some(date => 
            sessionDate.includes(date.toLowerCase()) || 
            sessionDate.includes(date)
          );
          
          // Check for unwanted descriptions (like "Âä†Ê≤πÔºÅ")
          const hasUnwantedDesc = description.includes('Âä†Ê≤π') || description.includes('strength');
          
          if (hasUnwantedName || hasUnwantedDate || hasUnwantedDesc) {
            console.log('üóëÔ∏è Marking for deletion:', {
              id: doc.id,
              name: data.sessionName,
              date: data.sessionDate,
              desc: data.description,
              athlete: data.athleteName
            });
            toDelete.push(doc.ref);
          }
        });
        
        if (toDelete.length > 0) {
          const confirmed = confirm(`Found ${toDelete.length} unwanted athlete session records. Delete them all? This cannot be undone!`);
          
          if (confirmed) {
            console.log(`üóëÔ∏è Deleting ${toDelete.length} unwanted records...`);
            await Promise.all(toDelete.map(ref => deleteDoc(ref)));
            
            // Also delete corresponding training sessions
            const trainingSessions = await getDocs(collection(db, 'trainingSessions'));
            const sessionToDelete = [];
            
            trainingSessions.forEach(doc => {
              const data = doc.data();
              const sessionName = (data.sessionName || '').toLowerCase();
              const sessionDate = data.sessionDate || '';
              const description = (data.description || '').toLowerCase();
              
              const hasUnwantedName = unwantedNames.some(name => sessionName.includes(name));
              const hasUnwantedDate = unwantedDates.some(date => sessionDate.includes(date.toLowerCase()));
              const hasUnwantedDesc = description.includes('Âä†Ê≤π') || description.includes('strength');
              
              if (hasUnwantedName || hasUnwantedDate || hasUnwantedDesc) {
                sessionToDelete.push(doc.ref);
              }
            });
            
            if (sessionToDelete.length > 0) {
              await Promise.all(sessionToDelete.map(ref => deleteDoc(ref)));
              console.log(`‚úÖ Also deleted ${sessionToDelete.length} training sessions`);
            }
            
            alert(`‚úÖ Successfully deleted ${toDelete.length} athlete records and ${sessionToDelete.length} training sessions!`);
            console.log('üîÑ Cleanup complete! Refresh your dashboard to see changes.');
            
            // Refresh current athlete charts if one is selected
            if (currentSelectedMember && globalTeamAnalytics) {
              await refreshAthleteMetricCharts(currentSelectedMember.studentId, globalTeamAnalytics);
            }
          }
        } else {
          alert('‚úÖ No unwanted data found to delete!');
          console.log('‚úÖ Database is clean!');
        }
        
      } catch (error) {
        console.error('‚ùå Error during universal cleanup:', error);
        alert('Error during cleanup: ' + error.message);
      }
    };

    // Force delete the specific December 8th "sdgsdg" session for current athlete
    window.forceDeleteDec8 = async function() {
      if (!currentSelectedMember) {
        alert('‚ùå No athlete selected. Please select an athlete first.');
        return;
      }
      
      const studentId = currentSelectedMember.studentId;
      console.log('üóëÔ∏è FORCE deleting December 8th sdgsdg session for:', studentId);
      
      try {
        // Check both 2024 and 2025 December 8th dates
        const dates = ['2024-12-08', '2025-12-08'];
        let totalDeleted = 0;
        
        for (const date of dates) {
          const athleteQuery = query(
            collection(db, 'athleteSessionData'),
            where('athleteId', '==', studentId),
            where('sessionDate', '==', date)
          );
          
          const snapshot = await getDocs(athleteQuery);
          let deletedCount = 0;
          
          const deletePromises = [];
          snapshot.forEach(doc => {
            console.log(`üóëÔ∏è DELETING ${date}:`, doc.id, doc.data());
            deletePromises.push(deleteDoc(doc.ref));
            deletedCount++;
          });
          
          if (deletePromises.length > 0) {
            await Promise.all(deletePromises);
            console.log(`‚úÖ DELETED ${deletedCount} records from ${date}!`);
            totalDeleted += deletedCount;
          }
        }
        
        if (totalDeleted > 0) {
          alert(`‚úÖ Successfully deleted ${totalDeleted} unwanted December 8th sessions!`);
          
          // Force refresh
          setTimeout(async () => {
            await refreshAthleteMetricCharts(studentId, globalTeamAnalytics);
            console.log('üîÑ Charts force refreshed!');
          }, 1000);
        } else {
          console.log('‚úÖ No December 8th data found to delete.');
          alert('‚úÖ No December 8th data found.');
        }
        
      } catch (error) {
        console.error('‚ùå Error force deleting:', error);
        alert('‚ùå Error: ' + error.message);
      }
    };

    // Specific cleanup for "word" athlete December 8th data
    window.cleanWordAthlete = async function() {
      console.log('üéØ Specifically cleaning ALL December 8th data for "word" athlete...');
      
      try {
        let totalDeleted = 0;
        
        // Check all possible December 8th date formats
        const dateQueries = [
          where('sessionDate', '==', '2024-12-08'),
          where('sessionDate', '==', '2025-12-08')
        ];
        
        for (const dateCondition of dateQueries) {
          const query1 = query(
            collection(db, 'athleteSessionData'),
            dateCondition
          );
          
          const snapshot = await getDocs(query1);
          
          for (const doc of snapshot.docs) {
            const data = doc.data();
            console.log('üîç Found Dec 8th record:', doc.id, data);
            
            // Check if this belongs to "word" athlete
            if (data.athleteName === 'word' || 
                (data.athleteId && data.athleteId.toString().includes('word')) ||
                (data.sessionName && data.sessionName.includes('sdgsdg'))) {
              
              console.log('üóëÔ∏è Deleting word athlete Dec 8th data:', doc.id);
              await deleteDoc(doc.ref);
              totalDeleted++;
            }
          }
        }
        
        if (totalDeleted > 0) {
          console.log(`‚úÖ Successfully deleted ${totalDeleted} December 8th records for word athlete!`);
          alert(`‚úÖ Cleaned ${totalDeleted} December 8th records for "word" athlete!`);
          
          // Refresh all views
          loadTeamMembers();
          if (currentSelectedMember?.name === 'word') {
            await refreshAthleteMetricCharts(currentSelectedMember.studentId, globalTeamAnalytics);
          }
        } else {
          console.log('‚úÖ No December 8th data found for "word" athlete.');
          alert('‚úÖ No December 8th data found for "word" athlete.');
        }
        
      } catch (error) {
        console.error('‚ùå Error cleaning word athlete December 8th data:', error);
        alert('‚ùå Error cleaning word athlete data: ' + error.message);
      }
    };

    // Comprehensive cleanup of ALL "sdgsdg" test sessions from entire database
    window.cleanAllSdgsdgSessions = async function() {
      console.log('üßπ COMPREHENSIVE CLEANUP: Removing ALL "sdgsdg" test sessions...');
      
      const confirmCleanup = confirm(
        'üßπ This will permanently delete ALL "sdgsdg" test sessions from your database.\n\n' +
        'This includes:\n' +
        '‚Ä¢ Training sessions with name "sdgsdg"\n' +
        '‚Ä¢ All athlete performance data from those sessions\n\n' +
        'This is SAFE and will clean up test data.\n\n' +
        'Continue with cleanup?'
      );
      
      if (!confirmCleanup) {
        console.log('‚ùå Cleanup cancelled by user');
        return;
      }
      
      try {
        let totalDeleted = 0;
        
        // Step 1: Clean athleteSessionData collection
        console.log('üîç Step 1: Cleaning athleteSessionData...');
        const athleteQuery = query(
          collection(db, 'athleteSessionData'),
          where('sessionName', '==', 'sdgsdg')
        );
        
        const athleteSnapshot = await getDocs(athleteQuery);
        console.log(`Found ${athleteSnapshot.size} athlete session records with "sdgsdg"`);
        
        const deletePromises = [];
        athleteSnapshot.forEach(doc => {
          console.log('üóëÔ∏è Deleting athlete session:', doc.id, doc.data());
          deletePromises.push(deleteDoc(doc.ref));
          totalDeleted++;
        });
        
        if (deletePromises.length > 0) {
          await Promise.all(deletePromises);
          console.log(`‚úÖ Deleted ${deletePromises.length} athlete session records`);
        }
        
        // Step 2: Clean trainingSessions collection  
        console.log('üîç Step 2: Cleaning trainingSessions...');
        const sessionQuery = query(
          collection(db, 'trainingSessions'),
          where('sessionName', '==', 'sdgsdg')
        );
        
        const sessionSnapshot = await getDocs(sessionQuery);
        console.log(`Found ${sessionSnapshot.size} training sessions with "sdgsdg"`);
        
        const sessionDeletePromises = [];
        sessionSnapshot.forEach(doc => {
          console.log('üóëÔ∏è Deleting training session:', doc.id, doc.data());
          sessionDeletePromises.push(deleteDoc(doc.ref));
          totalDeleted++;
        });
        
        if (sessionDeletePromises.length > 0) {
          await Promise.all(sessionDeletePromises);
          console.log(`‚úÖ Deleted ${sessionDeletePromises.length} training session records`);
        }
        
        // Final results
        if (totalDeleted > 0) {
          console.log(`üéâ CLEANUP COMPLETE! Deleted ${totalDeleted} total "sdgsdg" records`);
          alert(`üéâ Successfully cleaned ${totalDeleted} "sdgsdg" test records!\n\nYour database is now clean. All views will refresh automatically.`);
          
          // Refresh everything
          await loadTeamMembers();
          await refreshTeamCharts();
          
          if (currentSelectedMember) {
            await refreshAthleteMetricCharts(currentSelectedMember.studentId, globalTeamAnalytics);
          }
          
          console.log('üîÑ All views refreshed after cleanup!');
        } else {
          console.log('‚úÖ No "sdgsdg" sessions found - database already clean!');
          alert('‚úÖ No "sdgsdg" test sessions found. Your database is already clean!');
        }
        
      } catch (error) {
        console.error('‚ùå Error during comprehensive cleanup:', error);
        alert(`‚ùå Error during cleanup: ${error.message}\n\nCheck console for details.`);
      }
    };

    // Comprehensive cleanup of ALL "Strength" sessions from entire database
    window.cleanAllStrengthSessions = async function() {
      console.log('üßπ COMPREHENSIVE CLEANUP: Removing ALL "Strength" sessions...');
      
      const confirmCleanup = confirm(
        'üßπ This will permanently delete ALL "Strength" sessions from your database.\n\n' +
        'This includes:\n' +
        '‚Ä¢ Training sessions with name "Strength"\n' +
        '‚Ä¢ All athlete performance data from those sessions\n\n' +
        'This action cannot be undone.\n\n' +
        'Continue with cleanup?'
      );
      
      if (!confirmCleanup) {
        console.log('‚ùå Cleanup cancelled by user');
        return;
      }
      
      try {
        let totalDeleted = 0;
        
        // Step 1: Clean athleteSessionData collection
        console.log('üîç Step 1: Cleaning athleteSessionData...');
        const athleteSnapshot = await getDocs(collection(db, 'athleteSessionData'));
        
        const deletePromises = [];
        athleteSnapshot.forEach(doc => {
          const data = doc.data();
          const sessionName = (data.sessionName || '').toLowerCase();
          
          if (sessionName.includes('strength')) {
            console.log('üóëÔ∏è Deleting athlete session:', doc.id, data);
            deletePromises.push(deleteDoc(doc.ref));
            totalDeleted++;
          }
        });
        
        if (deletePromises.length > 0) {
          await Promise.all(deletePromises);
          console.log(`‚úÖ Deleted ${deletePromises.length} athlete session records`);
        }
        
        // Step 2: Clean trainingSessions collection  
        console.log('üîç Step 2: Cleaning trainingSessions...');
        const sessionSnapshot = await getDocs(collection(db, 'trainingSessions'));
        
        const sessionDeletePromises = [];
        sessionSnapshot.forEach(doc => {
          const data = doc.data();
          const sessionName = (data.sessionName || '').toLowerCase();
          
          if (sessionName.includes('strength')) {
            console.log('üóëÔ∏è Deleting training session:', doc.id, data);
            sessionDeletePromises.push(deleteDoc(doc.ref));
            totalDeleted++;
          }
        });
        
        if (sessionDeletePromises.length > 0) {
          await Promise.all(sessionDeletePromises);
          console.log(`‚úÖ Deleted ${sessionDeletePromises.length} training session records`);
        }
        
        // Final results
        if (totalDeleted > 0) {
          console.log(`üéâ CLEANUP COMPLETE! Deleted ${totalDeleted} total "Strength" records`);
          alert(`üéâ Successfully cleaned ${totalDeleted} "Strength" session records!\n\nYour database is now clean. All views will refresh automatically.`);
          
          // Refresh everything
          await loadTeamMembers();
          if (typeof refreshTeamCharts === 'function') {
            await refreshTeamCharts();
          }
          
          if (currentSelectedMember && globalTeamAnalytics) {
            await refreshAthleteMetricCharts(currentSelectedMember.studentId, globalTeamAnalytics);
          }
          
          console.log('üîÑ All views refreshed after cleanup!');
        } else {
          console.log('‚úÖ No "Strength" sessions found - database already clean!');
          alert('‚úÖ No "Strength" sessions found. Your database is already clean!');
        }
        
      } catch (error) {
        console.error('‚ùå Error during comprehensive cleanup:', error);
        alert(`‚ùå Error during cleanup: ${error.message}\n\nCheck console for details.`);
      }
    };

    // Load and display athlete training sessions table
    function loadAthleteSessionsTable(sessionData, athleteName) {
      const tableContainer = document.getElementById('athleteSessionsTable');
      if (!tableContainer || !sessionData || sessionData.length === 0) {
        if (tableContainer) {
          tableContainer.innerHTML = '<div style="text-align: center; color: #888; padding: 40px; font-size: 14px;">No training session data available for this athlete yet.</div>';
        }
        return;
      }
      
      // Sort sessions by date (newest first)
      const sortedSessions = [...sessionData].sort((a, b) => new Date(b.sessionDate) - new Date(a.sessionDate));
      
      // Helper function to get attendance styling
      function getAttendanceStyle(attendance) {
        const status = (attendance || 'Present').toLowerCase();
        
        switch (status) {
          case 'present':
            return {
              style: 'background: #e8f5e8; color: #2e7d32; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px;',
              icon: '‚úÖ'
            };
          case 'absent':
            return {
              style: 'background: #ffebee; color: #d32f2f; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px;',
              icon: '‚ùå'
            };
          case 'injured':
            return {
              style: 'background: #fff3e0; color: #f57c00; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px;',
              icon: 'ü§ï'
            };
          case 'late':
            return {
              style: 'background: #fff9c4; color: #f9a825; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px;',
              icon: '‚è∞'
            };
          case 'left early':
            return {
              style: 'background: #f3e5f5; color: #7b1fa2; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px;',
              icon: 'üö™'
            };
          case 'excused':
            return {
              style: 'background: #e3f2fd; color: #1976d2; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px;',
              icon: 'üìã'
            };
          default:
            return {
              style: 'background: #f5f5f5; color: #666; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px;',
              icon: '‚ùì'
            };
        }
      }
      
      // Create table HTML
      const tableHTML = `
        <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
          <thead>
            <tr style="background: #f8f9fa; border-bottom: 2px solid #e9ecef;">
              <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057; border-bottom: 1px solid #dee2e6;">Date</th>
              <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057; border-bottom: 1px solid #dee2e6;">Session</th>
              <th style="padding: 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 1px solid #dee2e6;">Status</th>
              <th style="padding: 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 1px solid #dee2e6;">Points</th>
              <th style="padding: 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 1px solid #dee2e6;">Rebounds</th>
              <th style="padding: 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 1px solid #dee2e6;">Assists</th>
              <th style="padding: 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 1px solid #dee2e6;">Turnovers</th>
              <th style="padding: 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 1px solid #dee2e6;">Fouls</th>
              <th style="padding: 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 1px solid #dee2e6;">RPE</th>
            </tr>
          </thead>
          <tbody>
            ${sortedSessions.map((session, index) => {
              const attendance = session.attendance || 'Present';
              const attendanceStyle = getAttendanceStyle(attendance);
              return `
              <tr style="border-bottom: 1px solid #e9ecef; ${index % 2 === 0 ? 'background: #f8f9fa;' : 'background: white;'} transition: background-color 0.2s ease;">
                <td style="padding: 12px; color: #495057;">${formatSessionDate(session.sessionDate)}</td>
                <td style="padding: 12px; color: #495057; font-weight: 500;">${session.sessionName || 'Training Session'}</td>
                <td style="padding: 12px; text-align: center;">
                  <span style="${attendanceStyle.style}">${attendanceStyle.icon} ${attendance}</span>
                </td>
                <td style="padding: 12px; text-align: center; color: #1976d2; font-weight: 600;">${session.points || 0}</td>
                <td style="padding: 12px; text-align: center; color: #2e7d32; font-weight: 600;">${session.rebounds || 0}</td>
                <td style="padding: 12px; text-align: center; color: #f57c00; font-weight: 600;">${session.assists || 0}</td>
                <td style="padding: 12px; text-align: center; color: #d32f2f; font-weight: 600;">${session.turnovers || 0}</td>
                <td style="padding: 12px; text-align: center; color: #c2185b; font-weight: 600;">${session.fouls || 0}</td>
                <td style="padding: 12px; text-align: center; color: #7b1fa2; font-weight: 600;">${session.rpe || 0}/10</td>
              </tr>`;
            }).join('')}
          </tbody>
        </table>
      `;
      
      tableContainer.innerHTML = tableHTML;
      
      // Add hover effects to table rows
      const rows = tableContainer.querySelectorAll('tbody tr');
      rows.forEach(row => {
        row.addEventListener('mouseenter', () => {
          row.style.background = '#e3f2fd';
        });
        row.addEventListener('mouseleave', () => {
          const index = Array.from(rows).indexOf(row);
          row.style.background = index % 2 === 0 ? '#f8f9fa' : 'white';
        });
      });
    }
    
    // Helper function to format session date
    function formatSessionDate(dateString) {
      try {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'short',
          day: 'numeric'
        });
      } catch (error) {
        return dateString || 'Unknown Date';
      }
    }

    // Load member training sessions summary
    async function loadMemberSessionsSummary(studentId) {
      const tableContainer = document.getElementById('memberSessionsTable');
      if (!tableContainer) return;

      try {
        // Fetch member's session data
        const sessionData = await fetchMemberSessionData(studentId, currentSelectedTeam.id);
        
        if (sessionData.length === 0) {
          tableContainer.innerHTML = `
            <div class="session-row">
              <div>Date</div>
              <div>Session Type</div>
              <div>Points</div>
              <div>Rebounds</div>
              <div>Assists</div>
              <div>Turnovers</div>
              <div>RPE</div>
            </div>
            <div style="padding: 40px; text-align: center; color: #666; font-family: Arial, sans-serif; font-style: italic;">
              No training sessions recorded yet. Training data will appear here once sessions are completed.
            </div>
          `;
          return;
        }

        // Create table structure with real data
        const tableHTML = `
          <div class="session-row">
            <div>Date</div>
            <div>Session Type</div>
            <div>Points</div>
            <div>Rebounds</div>
            <div>Assists</div>
            <div>Turnovers</div>
            <div>RPE</div>
          </div>
          ${sessionData.map(session => `
            <div class="session-row">
              <div>${new Date(session.sessionDate).toLocaleDateString()}</div>
              <div>${session.sessionName || 'Training Session'}</div>
              <div>${session.points || 0}</div>
              <div>${session.rebounds || 0}</div>
              <div>${session.assists || 0}</div>
              <div>${session.turnovers || 0}</div>
              <div>${session.rpe || 'N/A'}</div>
            </div>
          `).join('')}
        `;
        
        tableContainer.innerHTML = tableHTML;

      } catch (error) {
        console.error('Error loading member sessions summary:', error);
        tableContainer.innerHTML = `
          <div class="session-row">
            <div>Date</div>
            <div>Session Type</div>
            <div>Points</div>
            <div>Rebounds</div>
            <div>Assists</div>
            <div>Turnovers</div>
            <div>RPE</div>
          </div>
          <div style="padding: 40px; text-align: center; color: #e74c3c; font-family: Arial, sans-serif;">
            Error loading training sessions. Please try again.
          </div>
        `;
      }
    }

    // Enhanced back navigation functions
    window.backToTeamsOverview = function() {
      document.getElementById('teams-overview-view').style.display = 'block';
      document.getElementById('team-stats-detail-view').style.display = 'none';
      document.getElementById('member-stats-detail-view').style.display = 'none';
      currentSelectedTeam = null;
      currentSelectedMember = null;
    };

    window.backToTeamDetail = function() {
      if (currentSelectedTeam) {
        showTeamDetail(currentSelectedTeam.id);
      } else {
        backToTeamsOverview();
      }
    };

    // Make functions available globally - move here to ensure they're defined early
    window.showTeamDetail = showTeamDetail;
    window.showMemberDetail = showMemberDetail;
    
    // Debug function for testing
    window.testTeamClick = function() {
      console.log('üß™ Testing team click functionality...');
      console.log('Teams available:', teams.length);
      console.log('showTeamDetail function:', typeof window.showTeamDetail);
      if (teams.length > 0) {
        console.log('First team ID:', teams[0].id);
        showTeamDetail(teams[0].id);
      }
    };

    // Make functions available globally
    window.showTeamDetail = showTeamDetail;
    window.showMemberDetail = showMemberDetail;
    
    // Debug function for testing
    window.testTeamClick = function() {
      console.log('üß™ Testing team click functionality...');
      console.log('Teams available:', teams.length);
      console.log('showTeamDetail function:', typeof window.showTeamDetail);
      if (teams.length > 0) {
        console.log('First team ID:', teams[0].id);
        showTeamDetail(teams[0].id);
      }
    };

    // ========== ANALYTICS SUPPORT FUNCTIONS ==========
    
    // Fetch training sessions for a specific team
    async function fetchTeamTrainingSessions(teamId) {
      try {
        const sessionsQuery = query(
          collection(db, 'trainingSessions'),
          where('teamId', '==', teamId)
        );
        
        const sessionsSnapshot = await getDocs(sessionsQuery);
        const sessions = [];
        
        sessionsSnapshot.forEach(doc => {
          sessions.push({
            id: doc.id,
            ...doc.data()
          });
        });
        
        // Sort by date
        sessions.sort((a, b) => new Date(a.sessionDate) - new Date(b.sessionDate));
        
        return sessions;
      } catch (error) {
        console.error('Error fetching team training sessions:', error);
        return [];
      }
    }
    
    // Fetch athlete session data for multiple sessions
    async function fetchAllAthleteSessionData(trainingSessions) {
      try {
        const allAthleteData = [];
        
        // Fetch athlete data for each session
        for (const session of trainingSessions) {
          const athleteQuery = query(
            collection(db, 'athleteSessionData'),
            where('sessionId', '==', session.id)
          );
          
          const athleteSnapshot = await getDocs(athleteQuery);
          
          athleteSnapshot.forEach(doc => {
            allAthleteData.push({
              id: doc.id,
              sessionId: session.id,
              ...doc.data()
            });
          });
        }
        
        return allAthleteData;
      } catch (error) {
        console.error('Error fetching athlete session data:', error);
        return [];
      }
    }
    
    // Display team summary statistics
    function displayTeamSummaryStats(summary) {
      if (!summary) return;
      
      // Update the quick stats in the header
      document.getElementById('avgTeamPerformance').textContent = summary.overallAverage.toFixed(1);
      document.getElementById('totalSessions').textContent = summary.totalSessions;
      
      // Log detailed summary for debugging
      console.log('üìä Team Performance Summary:', {
        'Total Sessions': summary.totalSessions,
        'Overall Average Points/Player': summary.overallAverage,
        'Highest Session Average': summary.highestAverage,
        'Lowest Session Average': summary.lowestAverage,
        'Total Athletes Tracked': summary.totalAthletesTracked,
        'Consistency Score': summary.consistencyScore + '%'
      });
    }

    // Display player summary statistics
    function displayPlayerSummaryStats(summary) {
      if (!summary) return;
      
      // Log detailed summary for debugging
      console.log('üë• Player Performance Summary:', {
        'Total Players': summary.totalPlayers,
        'Top Performer': summary.topPerformer?.playerName + ' (' + summary.topPerformer?.averagePoints.toFixed(1) + ' avg)',
        'Highest Average': summary.highestAverage.toFixed(1),
        'Lowest Average': summary.lowestAverage.toFixed(1),
        'Overall Average': summary.overallAverage.toFixed(1),
        'Performance Spread': summary.performanceSpread.toFixed(1) + ' points',
        'Avg Sessions/Player': summary.averageSessionsPerPlayer
      });
      
      // Update additional stats if UI elements exist
      const topPerformerElement = document.getElementById('topPerformer');
      if (topPerformerElement && summary.topPerformer) {
        topPerformerElement.textContent = `${summary.topPerformer.playerName} (${summary.topPerformer.averagePoints.toFixed(1)} avg)`;
      }
      
      const totalPlayersElement = document.getElementById('totalPlayers');
      if (totalPlayersElement) {
        totalPlayersElement.textContent = summary.totalPlayers;
      }
    }

    // ========== SAMPLE DATA GENERATOR ==========
    async function generateSampleTrainingData() {
      console.log('üèÄ Generating sample training data...');
      
      if (!currentUser) {
        alert('Please make sure you are logged in as a coach.');
        return;
      }
      
      try {
        // Generate unique IDs
        const timestamp = Date.now();
        const sampleTeamId = `sample-team-${timestamp}`;
        const sampleTeamName = `Sample Team ${timestamp}`;
        
        // Create athlete IDs
        const athleteIds = [
          `athlete1-${timestamp}`,
          `athlete2-${timestamp}`,
          `athlete3-${timestamp}`,
          `athlete4-${timestamp}`,
          `athlete5-${timestamp}`
        ];
        
        console.log('üìù Creating sample team...');
        // Create sample team
        await setDoc(doc(db, 'teams', sampleTeamId), {
          name: sampleTeamName,
          sport: 'Basketball',
          coachId: currentUser.uid,
          coachEmail: currentUser.email,
          createdAt: new Date().toISOString(),
          memberIds: athleteIds,
          image: '',
          description: 'Sample team for testing analytics'
        });
        
        console.log('üë• Creating athlete profiles...');
        // Create athlete profiles
        const athletes = [
          { id: athleteIds[0], name: 'John Smith', email: 'john.smith@example.com' },
          { id: athleteIds[1], name: 'Sarah Johnson', email: 'sarah.johnson@example.com' },
          { id: athleteIds[2], name: 'Mike Davis', email: 'mike.davis@example.com' },
          { id: athleteIds[3], name: 'Emma Wilson', email: 'emma.wilson@example.com' },
          { id: athleteIds[4], name: 'Alex Brown', email: 'alex.brown@example.com' }
        ];
        
        for (const athlete of athletes) {
          await setDoc(doc(db, 'profiles', athlete.id), {
            fullName: athlete.name,
            email: athlete.email,
            studentId: athlete.id.substr(-8),
            position: 'Player',
            sport: 'Basketball',
            role: 'athlete',
            createdAt: new Date().toISOString()
          });
        }
        
        console.log('üèÉ‚Äç‚ôÇÔ∏è Creating training sessions...');
        // Generate 5 sample training sessions
        const sessions = [];
        
        for (let i = 0; i < 5; i++) {
          const sessionDate = new Date();
          sessionDate.setDate(sessionDate.getDate() - (i * 7)); // Weekly sessions
          
          const sessionData = {
            sessionName: `Training Session ${5 - i}`,
            sessionDate: sessionDate.toISOString().split('T')[0],
            sessionTime: '18:00',
            teamId: sampleTeamId,
            teamName: sampleTeamName,
            coachId: currentUser.uid,
            status: 'completed',
            duration: '90',
            location: 'Main Court',
            description: `Basketball training session ${5 - i} - Skills and scrimmage`,
            createdAt: new Date().toISOString()
          };
          
          // Add session to Firebase
          const sessionRef = await addDoc(collection(db, 'trainingSessions'), sessionData);
          sessions.push({ id: sessionRef.id, ...sessionData });
          console.log(`‚úÖ Created: ${sessionData.sessionName}`);
        }
        
        console.log('üìä Creating athlete performance data...');
        // Generate athlete performance data for each session
        for (const session of sessions) {
          for (const athlete of athletes) {
            // Generate realistic performance data
            const attendanceOptions = ['Present', 'Present', 'Present', 'Late', 'Left Early'];
            const attendance = attendanceOptions[Math.floor(Math.random() * attendanceOptions.length)];
            
            // Adjust performance based on attendance
            let pointsMultiplier = 1.0;
            if (attendance === 'Late') pointsMultiplier = 0.7;
            else if (attendance === 'Left Early') pointsMultiplier = 0.8;
            
            const performanceData = {
              athleteId: athlete.id,
              athleteName: athlete.name,
              athleteEmail: athlete.email,
              sessionId: session.id,
              sessionName: session.sessionName,
              sessionDate: session.sessionDate,
              teamId: sampleTeamId,
              teamName: sampleTeamName,
              attendance: attendance,
              points: Math.floor((Math.random() * 20 + 5) * pointsMultiplier), // 5-25 points
              rebounds: Math.floor(Math.random() * 10 + 1), // 1-10 rebounds
              assists: Math.floor(Math.random() * 8 + 1), // 1-8 assists
              turnovers: Math.floor(Math.random() * 5), // 0-4 turnovers
              fouls: Math.floor(Math.random() * 4), // 0-3 fouls
              rpe: Math.floor(Math.random() * 4 + 6), // 6-9 RPE scale
              notes: '',
              createdAt: new Date().toISOString()
            };
            
            // Add athlete session data to Firebase
            await addDoc(collection(db, 'athleteSessionData'), performanceData);
          }
        }
        
        console.log('üéâ Sample training data created successfully!');
        console.log(`üìä Created: ${sessions.length} training sessions with ${athletes.length} athletes each`);
        alert(`Sample data created successfully!\\n\\n‚Ä¢ Team: ${sampleTeamName}\\n‚Ä¢ Sessions: ${sessions.length}\\n‚Ä¢ Athletes: ${athletes.length}\\n\\nCharts will automatically refresh with new data!`);
        
        // Refresh the teams list and statistics
        loadStatisticsData();
        
        // If we're currently viewing a team, refresh its charts automatically
        if (currentSelectedTeam && currentSelectedTeam.id === sampleTeamId) {
          console.log('‚ôªÔ∏è Auto-refreshing current team charts...');
          // The real-time listeners will handle the refresh automatically
        }
        
      } catch (error) {
        console.error('‚ùå Error creating sample data:', error);
        alert('Error creating sample data. Check console for details.');
      }
    }

  </script>
</body>
</html>
