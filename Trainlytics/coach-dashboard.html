<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trainlytics - Coach Dashboard</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .coach-dashboard {
      display: flex;
      height: 100vh;
      background: #ffffff;
    }

    .coach-sidebar {
      width: 250px;
      background: white;
      border-right: 1px solid #000;
      display: flex;
      flex-direction: column;
      padding: 24px 20px;
      overflow-y: auto;
    }

    .coach-profile {
      text-align: center;
      padding-bottom: 20px;
      border-bottom: 1px solid #ddd;
      margin-bottom: 20px;
    }

    .coach-avatar {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: #dcc4f8;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 10px;
      font-size: 36px;
    }

    .coach-name {
      font-weight: bold;
      font-size: 13px;
      margin-bottom: 4px;
      text-transform: uppercase;
      font-family: Arial, sans-serif;
      letter-spacing: 0.5px;
    }

    .coach-sport {
      font-size: 11px;
      color: #666;
      margin-bottom: 12px;
      text-transform: uppercase;
      font-family: Arial, sans-serif;
    }

    .manage-account-btn {
      background: #b8bcc4;
      border: none;
      padding: 10px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 11px;
      font-weight: bold;
      text-transform: uppercase;
      font-family: Arial, sans-serif;
      letter-spacing: 0.5px;
    }

    .manage-account-btn:hover {
      background: #a9adb5;
    }

    .coach-nav {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .nav-section {
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    .nav-item {
      padding: 8px 0;
      cursor: pointer;
      border-radius: 0;
      font-size: 16px;
      text-align: left;
      transition: color 0.2s;
      font-family: Arial, sans-serif;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #000;
    }

    .nav-item:hover {
      background: none;
      color: #9333ea;
    }

    .nav-item.active {
      background: none;
      color: #000;
      font-weight: bold;
    }

    .sign-out-btn {
      background: #b8bcc4;
      border: none;
      padding: 10px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-weight: bold;
      text-transform: uppercase;
      font-size: 11px;
      margin-top: auto;
      font-family: Arial, sans-serif;
      letter-spacing: 0.5px;
    }

    .sign-out-btn:hover {
      background: #a9adb5;
    }

    /* Session Members Section */
    .session-members-section {
      display: none;
      width: 100%;
      margin-bottom: 20px;
    }

    .session-members-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
    }

    .session-members-title {
      font-size: 42px;
      font-weight: 700;
      color: #000;
      margin: 0;
      letter-spacing: 3px;
      font-family: Arial, sans-serif;
      text-transform: uppercase;
    }

    .back-to-sessions-btn {
      background: #6C63FF;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
    }

    .back-to-sessions-btn:hover {
      background: #5a52d5;
    }

    .member-card {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 0;
      cursor: pointer;
      transition: background 0.2s;
      border-bottom: 1px solid #eee;
    }

    .member-card:hover {
      background: #f9f9f9;
      border-radius: 4px;
      padding: 12px;
    }

    .member-card:last-child {
      border-bottom: none;
    }

    .member-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #6C63FF;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }

    .member-info {
      flex: 1;
    }

    .member-name {
      font-weight: bold;
      margin-bottom: 4px;
    }

    .member-email {
      font-size: 12px;
      color: #666;
    }

    /* Athlete Session Data Modal */
    .athlete-data-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 3000;
      align-items: center;
      justify-content: center;
    }

    .athlete-data-content {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .athlete-data-header {
      padding: 20px;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #f8f9fa;
    }

    .athlete-data-body {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-bottom: 20px;
    }

    .stats-group {
      background: #f8f9fa;
      padding: 16px;
      border-radius: 8px;
      border-left: 4px solid #6C63FF;
    }

    .stats-group h4 {
      margin: 0 0 12px 0;
      color: #333;
      font-size: 14px;
      text-transform: uppercase;
      font-weight: bold;
    }

    .stat-field {
      margin-bottom: 12px;
    }

    .stat-field:last-child {
      margin-bottom: 0;
    }

    .stat-field label {
      display: block;
      margin-bottom: 4px;
      font-weight: 500;
      font-size: 13px;
      color: #555;
    }

    .stat-field input, .stat-field select, .stat-field textarea {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }

    .stat-field input[type="number"] {
      text-align: center;
    }

    .stat-field textarea {
      min-height: 60px;
      resize: vertical;
      font-family: inherit;
    }

    .rpe-scale {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
      font-size: 12px;
      color: #666;
    }

    .modal-actions {
      padding: 20px;
      border-top: 1px solid #ddd;
      display: flex;
      gap: 12px;
      background: #f8f9fa;
    }

    .modal-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      font-size: 14px;
    }

    .modal-btn.primary {
      background: #6C63FF;
      color: white;
    }

    .modal-btn.primary:hover {
      background: #5a52d5;
    }

    .modal-btn.secondary {
      background: #e9ecef;
      color: #333;
    }

    .modal-btn.secondary:hover {
      background: #dee2e6;
    }

    .coach-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      padding: 40px;
      background: #ffffff;
    }

    .content-section {
      display: none;
      flex: 1;
      overflow-y: auto;
      padding: 0;
    }

    .content-section.active {
      display: flex;
      flex-direction: column;
    }

    .teams-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
    }

    .teams-title {
      font-size: 42px;
      font-weight: 700;
      color: #000;
      margin: 0;
      letter-spacing: 3px;
      font-family: Arial, sans-serif;
      text-transform: uppercase;
    }

    .add-circle-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: #fff;
      border: 2px solid #000;
      font-size: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      line-height: 1;
      padding: 0;
      font-weight: 300;
    }

    .add-circle-btn:hover {
      background: #000;
      color: #fff;
      transform: rotate(90deg);
    }

    .teams-search-container {
      margin-bottom: 32px;
      display: flex;
      justify-content: flex-start;
    }

    .teams-search-input {
      width: auto;
      min-width: 600px;
      padding: 12px 16px;
      border: 1px solid #ccc;
      border-radius: 20px;
      font-size: 13px;
      outline: none;
      transition: border-color 0.2s;
      background: #e8e8f0;
    }

    .teams-search-input:focus {
      border-color: #999;
      background: #fff;
    }

    .teams-search-input::placeholder {
      color: #999;
    }

    .teams-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .team-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      background: #fff;
      border: 2px solid #000;
      border-radius: 16px;
      transition: all 0.2s;
      cursor: pointer;
    }

    .team-item:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transform: translateY(-2px);
    }

    .team-item-image {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      object-fit: cover;
      background: #f5f5f5;
      flex-shrink: 0;
    }

    .team-item-content {
      flex: 1;
    }

    .team-item-name {
      font-size: 18px;
      font-weight: 700;
      color: #000;
      margin-bottom: 4px;
      letter-spacing: 1px;
      font-family: Arial, sans-serif;
      text-transform: uppercase;
    }

    .team-item-participants {
      font-size: 13px;
      color: #666;
      font-weight: 400;
      font-family: Arial, sans-serif;
      text-transform: uppercase;
    }

    .team-item-actions {
      display: flex;
      gap: 12px;
    }

    .team-action-btn {
      width: 40px;
      height: 40px;
      border: 2px solid #000;
      background: #fff;
      border-radius: 8px;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      padding: 0;
    }

    .team-action-btn:hover {
      background: #f5f5f5;
      transform: scale(1.08);
    }

    .training-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .training-title {
      font-size: 18px;
      font-weight: bold;
      text-transform: uppercase;
      margin: 0;
      font-family: Arial, sans-serif;
    }

    .training-controls {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .training-search-input {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    .training-toggle-btn {
      padding: 8px 16px;
      background: #6C63FF;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      font-size: 12px;
      text-transform: uppercase;
    }

    .training-toggle-btn:hover {
      background: #5a52d5;
    }

    .training-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 16px;
      margin-bottom: 30px;
    }

    .training-card {
      background: white;
      border: 2px solid #f0f0f0;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }
    
    .training-card:hover {
      border-color: #FF6B35;
      box-shadow: 0 8px 24px rgba(255, 107, 53, 0.15);
      transform: translateY(-2px);
    }
    
    .training-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #FF6B35, #F7931E);
    }

    .training-card-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 12px;
      color: #333;
    }

    .training-card-info {
      font-size: 14px;
      color: #666;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .training-card-info strong {
      color: #333;
      min-width: 60px;
      font-weight: 500;
    }

    .training-card-actions {
      display: flex;
      gap: 10px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #f0f0f0;
    }

    .training-card-btn {
      flex: 1;
      padding: 10px 16px;
      border: 2px solid #e0e0e0;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }

    .training-card-btn:hover {
      background: #f8f9fa;
      border-color: #FF6B35;
      color: #FF6B35;
    }
    
    .training-card-btn.view {
      background: #FF6B35;
      border-color: #FF6B35;
      color: white;
    }
    
    .training-card-btn.view:hover {
      background: #e55a2b;
      border-color: #e55a2b;
      color: white;
    }

    .training-card-btn.delete {
      background: #dc3545;
      color: white;
      border-color: #dc3545;
    }

    .training-card-btn.delete:hover {
      background: #c82333;
      border-color: #c82333;
    }

    .training-form {
      background: white;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 4px;
      max-width: 600px;
      display: none;
    }

    .training-form.active {
      display: block;
    }

    .training-form-title {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 20px;
      text-transform: uppercase;
      font-family: Arial, sans-serif;
    }

    .form-group {
      margin-bottom: 20px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .form-label {
      font-size: 12px;
      font-weight: bold;
      text-transform: uppercase;
      font-family: Arial, sans-serif;
      color: #333;
      text-align: left;
    }

    .form-input {
      padding: 10px;
      border: 1px solid #333;
      border-radius: 4px;
      font-size: 14px;
      font-family: inherit;
    }

    .form-input:focus {
      outline: none;
      border-color: #6C63FF;
    }

    .form-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .competition-filter {
      background: none;
      border: none;
      padding: 8px 16px;
      font-family: Arial, sans-serif;
      font-size: 14px;
      cursor: pointer;
      color: #666;
      border-bottom: 2px solid transparent;
    }

    .competition-filter.active {
      color: #000;
      border-bottom: 2px solid #000;
      font-weight: bold;
    }

    .competition-card {
      border: 1px solid #333;
      border-radius: 12px;
      padding: 24px;
      display: flex;
      align-items: center;
      gap: 32px;
      position: relative;
    }

    .competition-team {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    .competition-team-avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 20px;
    }

    .competition-team-name {
      font-family: Arial, sans-serif;
      font-weight: bold;
      font-size: 16px;
    }

    .competition-details {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
      text-align: center;
    }

    .competition-name {
      font-family: Arial, sans-serif;
      font-weight: bold;
      font-size: 20px;
      text-transform: uppercase;
    }

    .competition-info {
      font-family: Arial, sans-serif;
      font-size: 14px;
      color: #666;
    }

    .competition-actions {
      position: absolute;
      top: 16px;
      right: 16px;
      display: flex;
      gap: 8px;
    }

    .competition-action-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 18px;
      padding: 4px 8px;
      color: #666;
    }

    .competition-action-btn:hover {
      color: #000;
    }

    .form-button {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      text-transform: uppercase;
      font-size: 12px;
    }

    .form-button.save {
      background: #6C63FF;
      color: white;
      border-color: #6C63FF;
    }

    .form-button.save:hover {
      background: #5a52d5;
    }

    .form-button.cancel {
      background: #f0f0f0;
    }

    .form-button.cancel:hover {
      background: #e0e0e0;
    }

    .member-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      margin: 10px 0;
    }

    .member-option {
      padding: 10px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 4px;
      text-align: center;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }

    .member-option:hover {
      border-color: #6C63FF;
      background: #f0f0ff;
    }

    .member-option.selected {
      background: #6C63FF;
      color: white;
      border-color: #6C63FF;
    }

    .team-card {
      background: white;
      border: 1px solid #ddd;
      padding: 16px;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .team-card:hover {
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .team-card-title {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 8px;
    }

    .team-card-count {
      font-size: 13px;
      color: #666;
    }

    .modal-backdrop {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-backdrop.active {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 4px;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
    }

    .modal-close-btn {
      float: right;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
    }

    .modal-close-btn:hover {
      color: #000;
    }

    .modal-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 20px;
      text-transform: uppercase;
      font-family: Arial, sans-serif;
      clear: both;
    }

    .schedule-title {
      font-size: 42px;
      font-weight: 700;
      color: #000;
      margin: 0 0 20px 0;
      letter-spacing: 3px;
      text-transform: uppercase;
      font-family: Arial, sans-serif;
    }

    .schedule-container {
      flex: 1;
      overflow-y: visible;
    }

    .calendar {
      width: 100%;
      border-collapse: collapse;
    }

    .calendar th,
    .calendar td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
    }

    .calendar td.today {
      background: #6C63FF;
      color: white;
      font-weight: bold;
    }

    /* Statistics Styles */
    #statistics.content-section {
      background: transparent;
      padding: 0;
    }
    
    #statistics .schedule-container {
      background: transparent;
      padding: 40px;
      margin: 0;
      border: none;
      box-shadow: none;
    }
    
    .stats-date-filter {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 30px;
    }

    .date-range-btn {
      background: #e8e8e8;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      font-family: Arial, sans-serif;
      font-size: 12px;
      font-weight: bold;
      text-transform: uppercase;
      cursor: pointer;
      color: #333;
    }

    .date-range-btn:hover {
      background: #ddd;
    }

    .simple-teams-list {
      display: flex;
      flex-direction: column;
      gap: 20px;
      max-width: 600px;
      margin: 0 auto;
    }

    .simple-team-item {
      display: flex;
      align-items: center;
      gap: 20px;
      padding: 20px;
      background: #fff;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .simple-team-item:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transform: translateY(-2px);
    }

    .simple-team-avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      overflow: hidden;
      flex-shrink: 0;
      background: #f0f0f0;
    }

    .simple-team-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .simple-team-avatar.no-image {
      background: linear-gradient(135deg, #FF6B6B, #FFE66D);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: white;
      font-weight: bold;
    }

    .simple-team-info {
      flex: 1;
    }

    .simple-team-name {
      font-size: 18px;
      font-weight: bold;
      color: #000;
      margin-bottom: 4px;
      font-family: Arial, sans-serif;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .simple-team-members {
      font-size: 14px;
      color: #666;
      font-family: Arial, sans-serif;
      text-transform: uppercase;
    }

    /* Team Detail View Styles */
    .team-detail-header {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid #ddd;
    }

    .player-detail-header {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid #ddd;
    }

    .stats-back-btn {
      background: none;
      border: none;
      font-size: 14px;
      color: #666;
      cursor: pointer;
      padding: 8px 12px;
      border-radius: 4px;
      font-family: Arial, sans-serif;
      font-weight: bold;
      text-transform: uppercase;
    }

    .stats-back-btn:hover {
      background: #f5f5f5;
      color: #000;
    }

    .team-detail-header h2,
    .player-detail-header h2 {
      margin: 0;
      font-size: 28px;
      font-weight: bold;
      color: #000;
      font-family: Arial, sans-serif;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .player-basic-info {
      display: flex;
      gap: 20px;
      font-size: 14px;
      color: #666;
      font-family: Arial, sans-serif;
    }

    /* Graphs Section */
    .team-graphs-section,
    .player-graphs-section {
      margin-bottom: 40px;
    }

    .graphs-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-bottom: 20px;
    }

    .graph-container {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .graph-container h3 {
      font-size: 16px;
      font-weight: bold;
      color: #000;
      margin-bottom: 15px;
      font-family: Arial, sans-serif;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .graph-placeholder {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 200px;
      color: #666;
      font-size: 14px;
      background: #f9f9f9;
      border-radius: 8px;
      font-family: Arial, sans-serif;
    }

    /* Members Stats Table */
    .team-members-stats-section h3,
    .player-stats-table-section h3 {
      font-size: 18px;
      font-weight: bold;
      color: #000;
      margin-bottom: 20px;
      font-family: Arial, sans-serif;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .members-stats-table,
    .player-stats-table {
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .members-stats-header,
    .player-stats-header {
      display: grid;
      background: #f5f5f5;
      padding: 15px 20px;
      font-weight: bold;
      color: #333;
      font-size: 12px;
      text-transform: uppercase;
      font-family: Arial, sans-serif;
      letter-spacing: 0.5px;
    }

    .members-stats-header {
      grid-template-columns: 2fr 1.5fr 1fr 1fr;
    }

    .player-stats-header {
      grid-template-columns: 1fr 1.5fr 0.8fr 0.8fr 0.8fr 0.8fr 0.8fr 2fr;
    }

    .member-col,
    .stat-col {
      padding: 0 10px;
    }

    .members-stats-body,
    .player-stats-body {
      max-height: 400px;
      overflow-y: auto;
    }

    .member-stats-row,
    .player-stats-row {
      display: grid;
      padding: 15px 20px;
      border-bottom: 1px solid #f0f0f0;
      transition: background 0.2s;
      cursor: pointer;
      font-size: 14px;
      font-family: Arial, sans-serif;
    }

    .member-stats-row {
      grid-template-columns: 2fr 1.5fr 1fr 1fr;
    }

    .player-stats-row {
      grid-template-columns: 1fr 1.5fr 0.8fr 0.8fr 0.8fr 0.8fr 0.8fr 2fr;
      cursor: default;
    }

    .member-stats-row:hover {
      background: #f9f9f9;
    }

    .member-stats-row:last-child,
    .player-stats-row:last-child {
      border-bottom: none;
    }

    .view-btn {
      background: #6C63FF;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: bold;
      text-transform: uppercase;
      cursor: pointer;
      font-family: Arial, sans-serif;
    }

    .view-btn:hover {
      background: #5a52d5;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .graphs-row {
        grid-template-columns: 1fr;
      }
      
      .members-stats-header,
      .member-stats-row {
        grid-template-columns: 1fr;
        text-align: center;
      }
      
      .player-stats-header,
      .player-stats-row {
        font-size: 12px;
        grid-template-columns: repeat(8, 1fr);
      }
    }
    /* Member Stats Cards */
    .members-stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      padding: 20px;
    }
    
    .member-stats-card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      cursor: pointer;
      border: 2px solid transparent;
    }
    
    .member-stats-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
      border-color: #FF6B35;
    }
    
    .member-stats-header {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .member-stats-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #FF6B35, #F7931E);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 16px;
      margin-right: 12px;
    }
    
    .member-stats-info h4 {
      margin: 0;
      font-size: 16px;
      color: #333;
      font-weight: 600;
    }
    
    .member-stats-info .member-status {
      font-size: 12px;
      color: #666;
      margin: 2px 0 0 0;
    }
    
    .stats-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 8px;
    }
    
    .stat-item {
      text-align: center;
      padding: 6px;
      background: #f8f9fa;
      border-radius: 6px;
    }
    
    .stat-label {
      font-size: 10px;
      color: #666;
      text-transform: uppercase;
      font-weight: 600;
      margin-bottom: 2px;
    }
    
    .stat-value {
      font-size: 16px;
      font-weight: bold;
      color: #333;
    }
    
    .no-data-card {
      background: #f8f9fa;
      border: 2px dashed #ddd;
      color: #666;
      text-align: center;
      padding: 20px;
    }
    
    @media (max-width: 1200px) {
      .members-stats-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    
    @media (max-width: 900px) {
      .members-stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (max-width: 600px) {
      .members-stats-grid {
        grid-template-columns: 1fr;
      }
    }

  </style>
</head>
<body>
  <div class="coach-dashboard">
    <!-- Sidebar -->
    <div class="coach-sidebar">
      <!-- Profile Section -->
      <div class="coach-profile" id="profileSection" style="display: none;">
        <div class="coach-avatar" id="coachAvatar">
          <img id="avatarImage" style="display: none; width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" />
          <span id="avatarFallback">üë®‚Äçüè´</span>
        </div>
        <div class="coach-name" id="coachName">COACH NAME</div>
        <div class="coach-sport" id="coachSport">SPORT</div>
        <button class="manage-account-btn" onclick="window.location.href='manage-profile.html'">Manage Account</button>
      </div>

      <!-- Navigation -->
      <nav class="coach-nav">
        <div class="nav-section">
          <div class="nav-item active" data-section="home">Home</div>
          <div class="nav-item" data-section="teams">Teams</div>
          <div class="nav-item" data-section="training">Training</div>
          <div class="nav-item" data-section="competition">Competition</div>
          <div class="nav-item" data-section="statistics">Statistics</div>
        </div>
      </nav>

      <!-- Sign Out -->
      <button class="sign-out-btn" id="signOutBtn">Sign Out</button>
    </div>

    <!-- Main Content -->
    <div class="coach-content">
      <!-- Home Section -->
      <div class="content-section active" id="home">
        <div class="schedule-title">SCHEDULE</div>
        
        <div class="schedule-container">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
            <button id="prevMonthBtn" style="background:none; border:none; font-size:24px; cursor:pointer; padding:8px;">‚Äπ</button>
            <div class="month-header" id="monthHeader">November 2025</div>
            <button id="nextMonthBtn" style="background:none; border:none; font-size:24px; cursor:pointer; padding:8px;">‚Ä∫</button>
          </div>
          <table class="calendar" id="calendar">
            <thead>
              <tr>
                <th>Sun</th>
                <th>Mon</th>
                <th>Tue</th>
                <th>Wed</th>
                <th>Thu</th>
                <th>Fri</th>
                <th>Sat</th>
              </tr>
            </thead>
            <tbody id="calendarBody"></tbody>
          </table>
          
          <div id="selectedDateEvents" style="margin-top:20px; padding:16px; background:#f9f9f9; border-radius:8px; display:none;">
            <h3 style="margin:0 0 12px 0; font-size:16px;">Events on <span id="selectedDateTitle"></span></h3>
            <div id="selectedDateEventsList"></div>
          </div>
        </div>

        <div class="reminders-title">Reminders</div>
        <div class="reminders-box" id="remindersBox">
          <div id="remindersList" class="reminders-list"></div>
          <button class="add-reminder-btn" id="addReminderBtn">Add Reminder</button>
        </div>
      </div>

      <!-- Teams Section -->
      <div id="teams" class="content-section">
        <div class="teams-header">
          <h1 class="teams-title">TEAMS</h1>
          <button class="add-circle-btn" id="addTeamCircleBtn" title="Add New Team">‚äï</button>
        </div>
        
        <div class="teams-search-container">
          <input type="text" class="teams-search-input" placeholder="Search Team Name" id="teamsSearchInput" />
        </div>
        
        <div class="teams-list" id="teamsList">
          <!-- Teams will be loaded dynamically -->
        </div>
      </div>

      <!-- Add Team Section (Create New Team) -->
      <div id="addTeam" class="content-section">
        <div style="display:flex; align-items:center; margin-bottom:20px;">
          <button id="backToTeamsFromAddBtn" style="background:none; border:none; font-size:24px; cursor:pointer; padding:0; margin-right:12px;">‚Üê</button>
          <h2 class="add-team-title" style="margin:0;">Make A New Team!</h2>
        </div>
        
        <div class="add-team-container">
          <div class="add-team-form">
            <div class="add-team-layout">
              <div class="add-team-left">
                <div class="form-group">
                  <label class="form-label">Name</label>
                  <input type="text" id="teamNameInput" class="form-input" placeholder="Enter team name" />
                </div>
                
                <div class="form-group">
                  <label class="form-label">Add Members</label>
                  <div class="member-search-container">
                    <input type="text" id="memberSearchInput" class="member-search-input" placeholder="Search By Name" />
                  </div>
                  
                  <div class="members-grid" id="membersGrid">
                    <!-- Athletes will be loaded dynamically -->
                  </div>
                </div>
              </div>
              
              <div class="add-team-right">
                <div class="team-image-upload">
                  <input type="file" id="teamImageInput" accept="image/*" style="display:none;" />
                  <div class="upload-circle" id="uploadCircle">
                    <img id="teamPreviewImage" style="display:none; width:100%; height:100%; border-radius:50%; object-fit:cover;" />
                    <span class="upload-icon" id="uploadIcon">üë§</span>
                  </div>
                </div>
              </div>
            </div>
            
            <button class="upload-btn" id="createTeamBtn">Upload</button>
          </div>
        </div>
      </div>

        <!-- Team Details Section (Edit Existing Team) -->
        <div id="teamDetails" class="content-section">
          <div style="display:flex; align-items:center; margin-bottom:20px;">
            <button id="backToTeamsBtn" style="background:none; border:none; font-size:24px; cursor:pointer; padding:0; margin-right:12px;">‚Üê</button>
            <h2 class="add-team-title" id="teamDetailsTitle" style="margin:0;">Team Details</h2>
          </div>
          
          <div class="add-team-container">
            <div class="add-team-form">
              <div class="add-team-layout">
                <div class="add-team-left">
                  <div class="form-group">
                    <label class="form-label">Name</label>
                    <input type="text" id="teamDetailsNameInput" class="form-input" placeholder="Enter team name" />
                  </div>
                  
                  <div class="form-group">
                    <label class="form-label">Add Members</label>
                    <div class="member-search-container">
                      <input type="text" id="teamDetailsMemberSearch" class="member-search-input" placeholder="Search By Name" />
                    </div>
                    
                    <div class="members-grid" id="teamDetailsMembersGrid">
                      <!-- Athletes will be loaded dynamically -->
                    </div>
                  </div>
                </div>
                
                <div class="add-team-right">
                  <div class="team-image-upload">
                    <input type="file" id="teamDetailsImageInput" accept="image/*" style="display:none;" />
                    <div class="upload-circle" id="teamDetailsUploadCircle">
                      <img id="teamDetailsPreviewImage" style="display:none; width:100%; height:100%; border-radius:50%; object-fit:cover;" />
                      <span class="upload-icon" id="teamDetailsUploadIcon">üë§</span>
                    </div>
                  </div>
                </div>
              </div>
              
              <div style="display:flex; gap:12px; justify-content:flex-end; margin-top:20px;">
                <button class="upload-btn" id="teamDetailsDeleteBtn" style="background:#dc3545;">Delete Team</button>
                <button class="upload-btn" id="teamDetailsUpdateBtn">Update</button>
              </div>
            </div>
          </div>
        </div>

      <!-- Add Team Section -->
      <!-- Training Section -->
      <div id="training" class="content-section">
        
        <!-- Session Members Section -->
        <div id="sessionMembersSection" class="session-members-section">
          <div class="session-members-header">
            <h3 id="sessionMembersTitle" class="session-members-title">Training Session Members</h3>
            <button id="backToSessionsBtn" class="back-to-sessions-btn">‚Üê Back to Sessions</button>
          </div>
          <div id="sessionMembersList">
            <!-- Members will be loaded here -->
          </div>
        </div>

        <!-- Training List View -->
        <div id="trainingListView" class="schedule-container">
          <div class="schedule-title">TRAINING SESSION</div>
          
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; padding-bottom:16px; border-bottom:2px solid #1e1e1e;">
            <div style="display:flex; gap:20px; font-size:14px;">
              <span class="training-filter-btn active" data-filter="all" style="cursor:pointer; font-weight:600;">All</span>
              <span style="cursor:default;">|</span>
              <span class="training-filter-btn" data-filter="upcoming" style="cursor:pointer;">Upcoming</span>
              <span style="cursor:default;">|</span>
              <span class="training-filter-btn" data-filter="completed" style="cursor:pointer;">Completed</span>
              <span style="cursor:default;">|</span>
              <span class="training-filter-btn" data-filter="in-progress" style="cursor:pointer;">In Progress</span>
            </div>
            <button id="addTrainingSessionBtn" style="background:none; border:none; font-size:32px; cursor:pointer; padding:0; color:#333;">‚äï</button>
          </div>

          <div style="display:flex; gap:16px; margin-bottom:24px; align-items:center;">
            <span style="font-size:14px;">Sort By</span>
            <input type="text" id="sessionSearchInput" placeholder="Search Session Name" style="padding:8px 12px; border:1px solid #ddd; border-radius:4px; font-size:14px; flex:1; max-width:300px;" />
          </div>

          <div id="trainingSessionsList" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(260px, 1fr)); gap:20px; margin-top:20px;">
            <!-- Training sessions will load here -->
          </div>
        </div>

        <!-- Add Training Session Form -->
        <div id="addTrainingView" style="display:none;">
          <div style="display:flex; align-items:center; gap:12px; margin-bottom:24px;">
            <button id="backToTrainingListBtn" style="background:none; border:none; font-size:24px; cursor:pointer; padding:8px;">‚Üê</button>
            <h2 class="teams-title">CREATE TRAINING SESSION</h2>
          </div>
          
          <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:32px;">
            <div class="form-group">
              <label class="form-label">Session Name</label>
              <input type="text" id="sessionNameInput" class="form-input" placeholder="e.g., Strength Training" />
            </div>

            <div class="form-group">
              <label class="form-label">Date</label>
              <input type="date" id="sessionDateInput" class="form-input" />
            </div>

            <div class="form-group">
              <label class="form-label">Time</label>
              <input type="time" id="sessionTimeInput" class="form-input" />
            </div>

            <div class="form-group">
              <label class="form-label">Duration (minutes)</label>
              <input type="number" id="sessionDurationInput" class="form-input" placeholder="60" />
            </div>

            <div class="form-group" style="grid-column:1 / -1;">
              <label class="form-label">Location</label>
              <div style="display:flex; gap:8px;">
                <input type="text" id="sessionLocationInput" class="form-input" placeholder="e.g., Main Field or search for a place..." style="flex:1;" />
                <button type="button" id="openMapBtn" style="background:#6C63FF; color:white; border:none; padding:0 20px; border-radius:8px; cursor:pointer; font-weight:bold; white-space:nowrap;">üìç Map</button>
              </div>
              <input type="hidden" id="sessionLocationLat" />
              <input type="hidden" id="sessionLocationLng" />
            </div>

            <div class="form-group">
              <label class="form-label">Select Team</label>
              <select id="sessionTeamSelect" class="form-input">
                <option value="">Choose a team...</option>
                <!-- Teams will load here -->
              </select>
            </div>

            <div class="form-group" style="grid-column:1 / -1;">
              <label class="form-label">Description</label>
              <textarea id="sessionDescriptionInput" class="form-input" placeholder="Training details..." style="min-height:100px; width:calc(50% - 6px); resize:none; font-family:inherit;"></textarea>
            </div>

            <div style="display:flex; gap:12px; grid-column:1 / -1;">
              <button id="saveSessionBtn" style="flex:1; background-color:#6C63FF; color:white; border:none; padding:12px; border-radius:8px; cursor:pointer; font-weight:bold;">SAVE SESSION</button>
              <button id="cancelSessionBtn" style="flex:1; background-color:#ddd; color:#333; border:none; padding:12px; border-radius:8px; cursor:pointer; font-weight:bold;">CANCEL</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Map Modal -->
      <div id="mapModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:2000; align-items:center; justify-content:center;">
        <div style="background:white; border-radius:12px; width:90%; max-width:800px; max-height:90vh; display:flex; flex-direction:column;">
          <div style="padding:20px; border-bottom:1px solid #ddd; display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0;">Select Location on Map</h3>
            <button id="closeMapBtn" style="background:none; border:none; font-size:28px; cursor:pointer; color:#666;">&times;</button>
          </div>
          <div style="padding:16px;">
            <input type="text" id="mapSearchInput" placeholder="Search for a location..." style="width:100%; padding:12px; border:1px solid #ddd; border-radius:6px; font-size:14px; margin-bottom:12px;" />
          </div>
          <div id="map" style="flex:1; min-height:400px;"></div>
          <div style="padding:16px; border-top:1px solid #ddd; display:flex; gap:12px;">
            <button id="confirmLocationBtn" style="flex:1; background:#6C63FF; color:white; border:none; padding:12px; border-radius:6px; font-weight:600; cursor:pointer;">CONFIRM LOCATION</button>
            <button id="cancelMapBtn" style="flex:1; background:#ddd; color:#333; border:none; padding:12px; border-radius:6px; font-weight:600; cursor:pointer;">CANCEL</button>
          </div>
        </div>
      </div>

      <!-- Athlete Session Data Modal -->
      <div id="athleteDataModal" class="athlete-data-modal">
        <div class="athlete-data-content">
          <div class="athlete-data-header">
            <div>
              <h3 id="athleteDataTitle" style="margin: 0; font-size: 18px;">Athlete Session Data</h3>
              <p id="athleteDataSubtitle" style="margin: 4px 0 0 0; font-size: 14px; color: #666;">Enter performance data for this training session</p>
            </div>
            <button class="modal-close" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
          </div>
          
          <div class="athlete-data-body">
            <form id="athleteDataForm">
              <div class="stats-grid">
                <!-- Performance Stats -->
                <div class="stats-group">
                  <h4>Performance Stats</h4>
                  <div class="stat-field">
                    <label for="points">Points Scored</label>
                    <input type="number" id="points" name="points" min="0" placeholder="0">
                  </div>
                  <div class="stat-field">
                    <label for="rebounds">Rebounds</label>
                    <input type="number" id="rebounds" name="rebounds" min="0" placeholder="0">
                  </div>
                  <div class="stat-field">
                    <label for="assists">Assists</label>
                    <input type="number" id="assists" name="assists" min="0" placeholder="0">
                  </div>
                  <div class="stat-field">
                    <label for="turnovers">Turnovers</label>
                    <input type="number" id="turnovers" name="turnovers" min="0" placeholder="0">
                  </div>
                  <div class="stat-field">
                    <label for="fouls">Fouls</label>
                    <input type="number" id="fouls" name="fouls" min="0" placeholder="0">
                  </div>
                </div>

                <!-- Session Data -->
                <div class="stats-group">
                  <h4>Session Data</h4>
                  <div class="stat-field">
                    <label for="rpe">RPE (Rating of Perceived Exertion)</label>
                    <input type="number" id="rpe" name="rpe" min="1" max="10" placeholder="5">
                    <div class="rpe-scale">
                      <span>1 - Very Easy</span>
                      <span>5 - Moderate</span>
                      <span>10 - Maximum</span>
                    </div>
                  </div>
                  <div class="stat-field">
                    <label for="attendance">Attendance Status</label>
                    <select id="attendance" name="attendance">
                      <option value="Present">Present</option>
                      <option value="Absent">Absent</option>
                      <option value="Injured">Injured</option>
                      <option value="Late">Late</option>
                      <option value="Left Early">Left Early</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- Coach Notes -->
              <div class="stats-group" style="grid-column: 1 / -1;">
                <h4>Coach's Notes</h4>
                <div class="stat-field">
                  <label for="notes">Performance Notes & Feedback</label>
                  <textarea id="notes" name="notes" placeholder="Add specific notes about this athlete's performance, areas for improvement, highlights, etc."></textarea>
                </div>
              </div>
            </form>
          </div>

          <div class="modal-actions">
            <button id="saveAthleteData" class="modal-btn primary">Save Session Data</button>
            <button id="cancelAthleteData" class="modal-btn secondary">Cancel</button>
          </div>
        </div>
      </div>

      <!-- Competition Section -->
      <div id="competition" class="content-section">
        <div id="competitionListView">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
            <h2 class="teams-title">COMPETITIONS</h2>
            <button id="addCompetitionBtn" style="background-color:#6C63FF; color:white; border:none; padding:12px 24px; border-radius:8px; cursor:pointer; font-weight:bold;">+ ADD COMPETITION</button>
          </div>

          <div style="display:flex; gap:16px; margin-bottom:24px;">
            <button class="competition-filter active" data-filter="all">All</button>
            <button class="competition-filter" data-filter="upcoming">Upcoming</button>
            <button class="competition-filter" data-filter="completed">Completed</button>
          </div>

          <div id="competitionsList" style="display:flex; flex-direction:column; gap:16px;">
            <!-- Competitions will load here -->
          </div>
        </div>

        <!-- Add Competition Form -->
        <div id="addCompetitionView" style="display:none;">
          <div style="display:flex; align-items:center; gap:12px; margin-bottom:24px;">
            <button id="backToCompetitionListBtn" style="background:none; border:none; font-size:24px; cursor:pointer; padding:8px;">‚Üê</button>
            <h2 class="teams-title">CREATE COMPETITION</h2>
          </div>
          
          <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:32px;">
            <div class="form-group">
              <label class="form-label">Competition Name</label>
              <input type="text" id="compNameInput" class="form-input" placeholder="e.g., Final Match" />
            </div>

            <div class="form-group">
              <label class="form-label">Date</label>
              <input type="date" id="compDateInput" class="form-input" />
            </div>

            <div class="form-group">
              <label class="form-label">Time</label>
              <input type="time" id="compTimeInput" class="form-input" />
            </div>

            <div class="form-group">
              <label class="form-label">Location</label>
              <input type="text" id="compLocationInput" class="form-input" placeholder="e.g., Da'an Sport Center" />
            </div>

            <div class="form-group">
              <label class="form-label">Team 1 (Your Team)</label>
              <select id="compTeam1Input" class="form-input">
                <option value="">Select your team...</option>
                <!-- Teams will load here -->
              </select>
            </div>

            <div class="form-group">
              <label class="form-label">Team 2 (Opponent)</label>
              <input type="text" id="compTeam2Input" class="form-input" placeholder="e.g., Opponent Team Name" />
            </div>
          </div>

          <div style="display:flex; gap:12px; margin-top:32px;">
            <button id="saveCompetitionBtn" style="flex:1; background-color:#6C63FF; color:white; border:none; padding:12px; border-radius:8px; cursor:pointer; font-weight:bold;">SAVE COMPETITION</button>
            <button id="cancelCompetitionBtn" style="flex:1; background-color:#ddd; color:#333; border:none; padding:12px; border-radius:8px; cursor:pointer; font-weight:bold;">CANCEL</button>
          </div>
        </div>
      </div>

      <!-- Statistics Section -->
      <div id="statistics" class="content-section">
        <div class="schedule-title">Statistics</div>
        <div class="schedule-container">
          <!-- Date Range Filter -->
          <div class="stats-date-filter">
            <button class="date-range-btn">Date Range</button>
          </div>

          <!-- Teams List View -->
          <div id="teams-overview-view" class="stats-view">
            <div class="simple-teams-list" id="simpleTeamsList">
              <!-- Teams will be populated here -->
            </div>
          </div>

          <!-- Team Detail View -->
          <div id="team-stats-detail-view" class="stats-view" style="display: none;">
            <div class="team-detail-header">
              <button class="stats-back-btn" onclick="backToTeamsOverview()">‚Üê Back to Teams</button>
              <h2 id="teamDetailTitle">Team Name</h2>
            </div>
            
            <!-- Team Graphs Section -->
            <div class="team-graphs-section">
              <div class="graphs-row">
                <div class="graph-container">
                  <h3>Average Points Per Player</h3>
                  <canvas id="avgPointsChart" width="400" height="200"></canvas>
                  <div id="avgPointsPlaceholder" class="graph-placeholder">No training data available yet</div>
                </div>
                <div class="graph-container">
                  <h3>Team Performance Trend</h3>
                  <canvas id="teamTrendChart" width="400" height="200"></canvas>
                  <div id="teamTrendPlaceholder" class="graph-placeholder">No training data available yet</div>
                </div>
              </div>
            </div>

            <!-- Team Members Section -->
            <div class="team-members-stats-section">
              <h3>Team Members</h3>
              <div class="members-stats-table">
                <div class="members-stats-header">
                  <div class="member-col">Player Name</div>
                  <div class="member-col">Student ID</div>
                  <div class="member-col">Position</div>
                  <div class="member-col">Action</div>
                </div>
                <div id="teamMembersStatsList" class="members-stats-body">
                  <!-- Members will be populated here -->
                </div>
              </div>
            </div>
          </div>

          <!-- Player Detail View -->
          <div id="player-stats-detail-view" class="stats-view" style="display: none;">
            <div class="player-detail-header">
              <button class="stats-back-btn" onclick="backToTeamDetail()">‚Üê Back to Team</button>
              <h2 id="playerDetailTitle">Player Name</h2>
              <div class="player-basic-info" id="playerBasicInfo">
                <!-- Player basic info will be populated here -->
              </div>
            </div>
            
            <!-- Player Graphs Section -->
            <div class="player-graphs-section">
              <div class="graphs-row">
                <div class="graph-container">
                  <h3>Points Over Time</h3>
                  <canvas id="playerPointsChart" width="400" height="200"></canvas>
                  <div id="playerPointsPlaceholder" class="graph-placeholder">No training data available yet</div>
                </div>
                <div class="graph-container">
                  <h3>Average Stats</h3>
                  <canvas id="playerAvgChart" width="400" height="200"></canvas>
                  <div id="playerAvgPlaceholder" class="graph-placeholder">No training data available yet</div>
                </div>
              </div>
            </div>

            <!-- Player Stats Table -->
            <div class="player-stats-table-section">
              <h3>Training Sessions History</h3>
              <div class="player-stats-table">
                <div class="player-stats-header">
                  <div class="stat-col">Date</div>
                  <div class="stat-col">Session Type</div>
                  <div class="stat-col">Points</div>
                  <div class="stat-col">Rebounds</div>
                  <div class="stat-col">Assists</div>
                  <div class="stat-col">Turnovers</div>
                  <div class="stat-col">RPE</div>
                  <div class="stat-col">Notes</div>
                </div>
                <div id="playerStatsTableBody" class="player-stats-body">
                  <!-- Player stats will be populated here -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Leaflet (OpenStreetMap) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- ES Module Scripts -->
  <script type="module">
    import { requireAuth, logout, getUserProfile } from './script.js';
    import { auth, db } from './firebase-config.js';
    import { doc, getDoc, updateDoc, collection, getDocs, query, where, setDoc, deleteDoc, arrayUnion, arrayRemove, addDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    // Protect this page for coaches only
    requireAuth('coach');

    let currentUser = null;
    let reminders = [];
    let athletes = [];
    let teams = [];

    // Get current user and populate profile
    
    // Helper function to display profile
    function displayCoachProfile(profile) {
      if (!profile) return;
      document.getElementById('profileSection').style.display = 'block';
      document.getElementById('coachName').textContent = profile.name || 'COACH NAME';
      
      // Capitalize sport name
      const sport = profile.sport ? profile.sport.charAt(0).toUpperCase() + profile.sport.slice(1) : 'SPORT';
      document.getElementById('coachSport').textContent = sport;
      
      const avatarImage = document.getElementById('avatarImage');
      const avatarFallback = document.getElementById('avatarFallback');
      
      if (profile.avatar) {
        avatarImage.src = profile.avatar;
        avatarImage.style.display = 'block';
        avatarFallback.style.display = 'none';
      } else {
        avatarImage.style.display = 'none';
        avatarFallback.style.display = 'block';
      }
      
      reminders = Array.isArray(profile.reminders) ? profile.reminders.slice() : [];
      renderReminders();
    }
    
    // Try to load cached profile for immediate display
    const cachedUID = Object.keys(localStorage).find(key => key.startsWith('profile_'));
    if (cachedUID) {
      try {
        const cached = JSON.parse(localStorage.getItem(cachedUID));
        displayCoachProfile(cached);
      } catch (e) {
        console.log('Cache load error:', e);
      }
    }
    
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        currentUser = user;
        const profile = await getUserProfile(user.uid);
        displayCoachProfile(profile);
        
        // Load initial data
        if (profile) {
          await loadTeams();
          await loadTrainingSessions();
          await generateCalendar(); // Refresh calendar with events
          
          // Auto-refresh training sessions every minute to update statuses
          setInterval(() => {
            if (trainingSessions.length > 0) {
              renderTrainingSessions();
            }
            generateCalendar(); // Also refresh calendar
          }, 60000); // Refresh every 60 seconds
        }
      }
    });

    // Load teams from Firebase
    async function loadTeams() {
      if (!currentUser) return;
      
      try {
        const teamsRef = collection(db, 'teams');
        const q = query(teamsRef, where('coachId', '==', currentUser.uid));
        const querySnapshot = await getDocs(q);
        
        teams = [];
        querySnapshot.forEach((doc) => {
          teams.push({
            id: doc.id,
            ...doc.data()
          });
        });
        
        renderTeams();
      } catch (error) {
        console.error('Error loading teams:', error);
      }
    }

    // Render teams list
    function renderTeams() {
      const teamsList = document.getElementById('teamsList');
      if (!teamsList) return;
      
      // Keep only the dynamically added teams
      teamsList.innerHTML = '';
      
      teams.forEach(team => {
        const teamItem = document.createElement('div');
        teamItem.className = 'team-item';
        teamItem.dataset.teamId = team.id;
        teamItem.style.cursor = 'pointer';
        teamItem.innerHTML = `
          <img src="${team.image || 'assets/coach.png'}" alt="Team" class="team-item-image" />
          <div class="team-item-content">
            <div class="team-item-name">${team.name}</div>
            <div class="team-item-participants">${team.memberIds?.length || 0} Members</div>
          </div>
        `;
        teamsList.appendChild(teamItem);
      });
    }

    // Delete team
    async function deleteTeam(teamId) {
      if (!confirm('Are you sure you want to delete this team?')) return;
      
      try {
        await deleteDoc(doc(db, 'teams', teamId));
        teams = teams.filter(t => t.id !== teamId);
        renderTeams();
      } catch (error) {
        console.error('Error deleting team:', error);
        alert('Failed to delete team. Please try again.');
      }
    }

    // Edit team
    let editingTeamId = null;
    
    async function editTeam(teamId) {
      const team = teams.find(t => t.id === teamId);
      if (!team) return;
      
      editingTeamId = teamId;
      
      // Load athletes
      await fetchAthletes();
      
      // Populate form with team data
      document.getElementById('teamNameInput').value = team.name;
      
      // Show team image if exists
      if (team.image && team.image !== 'assets/coach.png') {
        teamImageData = team.image;
        teamPreviewImage.src = team.image;
        teamPreviewImage.style.display = 'block';
        uploadIcon.style.display = 'none';
      }
      
      // Select members that are in the team
      setTimeout(() => {
        const memberCards = document.querySelectorAll('.member-card');
        memberCards.forEach(card => {
          const athleteId = card.dataset.athleteId;
          const btn = card.querySelector('.member-add-btn');
          if (team.memberIds && team.memberIds.includes(athleteId)) {
            btn.classList.add('selected');
            btn.textContent = '‚úì';
          }
        });
      }, 100);
      
      // Change button text to "Update"
      createTeamBtn.textContent = 'Update';
      
      // Navigate to add team page
      document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
      document.getElementById('addTeam').classList.add('active');
      document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
    }

    // Team list click handler - view team details on click
    const teamsList = document.getElementById('teamsList');
    if (teamsList) {
      teamsList.addEventListener('click', (e) => {
        const teamItem = e.target.closest('.team-item');
        if (teamItem) {
          const teamId = teamItem.dataset.teamId;
          if (teamId) {
            viewTeamDetails(teamId);
          }
        }
      });
    }

    // Store current viewing team
    let currentViewingTeamId = null;
    let teamDetailsImageData = null;

    // Show team details section (edit view)
    window.viewTeamDetails = async function(teamId) {
      const team = teams.find(t => t.id === teamId);
      if (!team) return;
      window.teams = teams;
      currentViewingTeamId = teamId;
      
      // Load all athletes if not already loaded
      if (athletes.length === 0) {
        await fetchAthletes();
      }
      
      // Populate team name
      document.getElementById('teamDetailsNameInput').value = team.name;
      
      // Populate team image
      const previewImg = document.getElementById('teamDetailsPreviewImage');
      const uploadIcon = document.getElementById('teamDetailsUploadIcon');
      if (team.image && team.image !== 'assets/coach.png') {
        teamDetailsImageData = team.image;
        previewImg.src = team.image;
        previewImg.style.display = 'block';
        uploadIcon.style.display = 'none';
      } else {
        teamDetailsImageData = null;
        previewImg.style.display = 'none';
        previewImg.src = '';
        uploadIcon.style.display = 'block';
      }
      
      // Render athletes grid with selected members
      renderTeamDetailsMembers(team.memberIds || []);
      
      // Clear search
      document.getElementById('teamDetailsMemberSearch').value = '';
      
      // Show section
      document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
      document.getElementById('teamDetails').classList.add('active');
    }

    // Back button to return to teams page
    document.getElementById('backToTeamsBtn')?.addEventListener('click', () => {
      document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
      document.getElementById('teams').classList.add('active');
      currentViewingTeamId = null;
    });

    // Render team details members grid
    function renderTeamDetailsMembers(selectedMemberIds) {
      const membersGrid = document.getElementById('teamDetailsMembersGrid');
      if (!membersGrid) return;
      
      membersGrid.innerHTML = '';
      
      if (athletes.length === 0) {
        membersGrid.innerHTML = '<div style="grid-column: 1/-1; text-align:center; color:#666;">No athletes found</div>';
        return;
      }
      
      athletes.forEach(athlete => {
        const memberCard = document.createElement('div');
        memberCard.className = 'member-card';
        memberCard.dataset.athleteId = athlete.id;
        
        const isSelected = selectedMemberIds.includes(athlete.id);
        if (isSelected) {
          memberCard.style.background = '#e6d5f5';
          memberCard.style.border = '2px solid #9b59b6';
        }
        
        memberCard.innerHTML = `
          <img src="${athlete.avatar}" alt="${athlete.name}" class="member-avatar" />
          <span class="member-name">${athlete.name}</span>
          <button class="member-add-btn${isSelected ? ' selected' : ''}">${isSelected ? '‚úì' : '‚äï'}</button>
        `;
        membersGrid.appendChild(memberCard);
      });
    }

    // Team details image upload
    const teamDetailsUploadCircle = document.getElementById('teamDetailsUploadCircle');
    const teamDetailsImageInput = document.getElementById('teamDetailsImageInput');
    const teamDetailsPreviewImage = document.getElementById('teamDetailsPreviewImage');
    const teamDetailsUploadIcon = document.getElementById('teamDetailsUploadIcon');
    
    if (teamDetailsUploadCircle && teamDetailsImageInput) {
      teamDetailsUploadCircle.addEventListener('click', () => {
        teamDetailsImageInput.click();
      });
      
      teamDetailsImageInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            teamDetailsImageData = event.target.result;
            teamDetailsPreviewImage.src = teamDetailsImageData;
            teamDetailsPreviewImage.style.display = 'block';
            teamDetailsUploadIcon.style.display = 'none';
          };
          reader.readAsDataURL(file);
        }
      });
    }

    // Toggle member selection in team details
    const teamDetailsMembersGrid = document.getElementById('teamDetailsMembersGrid');
    if (teamDetailsMembersGrid) {
      teamDetailsMembersGrid.addEventListener('click', (e) => {
        const btn = e.target.closest('.member-add-btn');
        if (!btn) return;
        
        const card = btn.closest('.member-card');
        if (btn.classList.contains('selected')) {
          btn.classList.remove('selected');
          btn.textContent = '‚äï';
          card.style.background = '#fff';
          card.style.border = '1px solid #888';
        } else {
          btn.classList.add('selected');
          btn.textContent = '‚úì';
          card.style.background = '#e6d5f5';
          card.style.border = '2px solid #9b59b6';
        }
      });
    }

    // Search functionality for team details members
    const teamDetailsMemberSearch = document.getElementById('teamDetailsMemberSearch');
    if (teamDetailsMemberSearch) {
      teamDetailsMemberSearch.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const memberCards = document.querySelectorAll('#teamDetailsMembersGrid .member-card');
        
        memberCards.forEach(card => {
          const name = card.querySelector('.member-name').textContent.toLowerCase();
          if (name.includes(searchTerm)) {
            card.style.display = 'flex';
          } else {
            card.style.display = 'none';
          }
        });
      });
    }

    // Update team button
    const teamDetailsUpdateBtn = document.getElementById('teamDetailsUpdateBtn');
    if (teamDetailsUpdateBtn) {
      teamDetailsUpdateBtn.addEventListener('click', async () => {
        if (!currentViewingTeamId) return;
        
        const teamName = document.getElementById('teamDetailsNameInput').value;
        if (!teamName.trim()) {
          alert('Please enter a team name');
          return;
        }
        
        // Get selected member IDs
        const selectedMemberCards = document.querySelectorAll('#teamDetailsMembersGrid .member-add-btn.selected');
        const selectedMemberIds = Array.from(selectedMemberCards).map(btn => {
          return btn.closest('.member-card')?.dataset.athleteId;
        }).filter(id => id);
        
        // Use uploaded image or existing
        const team = teams.find(t => t.id === currentViewingTeamId);
        const imageUrl = teamDetailsImageData || team.image || 'assets/coach.png';
        
        // Update team object
        const teamData = {
          name: teamName,
          image: imageUrl,
          coachId: currentUser.uid,
          memberIds: selectedMemberIds,
          updatedAt: new Date().toISOString()
        };
        
        try {
          await setDoc(doc(db, 'teams', currentViewingTeamId), teamData, { merge: true });
          
          // Update local teams array
          const teamIndex = teams.findIndex(t => t.id === currentViewingTeamId);
          if (teamIndex !== -1) {
            teams[teamIndex] = {
              id: currentViewingTeamId,
              ...teamData
            };
          }
          
          alert('Team updated successfully!');
          renderTeams();
          
          // Go back to teams list
          document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
          document.getElementById('teams').classList.add('active');
          currentViewingTeamId = null;
        } catch (error) {
          console.error('Error updating team:', error);
          alert('Failed to update team: ' + error.message);
        }
      });
    }

    // Delete team button
    const teamDetailsDeleteBtn = document.getElementById('teamDetailsDeleteBtn');
    if (teamDetailsDeleteBtn) {
      teamDetailsDeleteBtn.addEventListener('click', async () => {
        if (!currentViewingTeamId) return;
        
        if (!confirm('Are you sure you want to delete this team?')) return;
        
        try {
          await deleteDoc(doc(db, 'teams', currentViewingTeamId));
          teams = teams.filter(t => t.id !== currentViewingTeamId);
          renderTeams();
          
          // Go back to teams list
          document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
          document.getElementById('teams').classList.add('active');
          currentViewingTeamId = null;
          
          alert('Team deleted successfully!');
        } catch (error) {
          console.error('Error deleting team:', error);
          alert('Failed to delete team.');
        }
      });
    }

    // Calendar state
    let currentCalendarMonth = new Date().getMonth();
    let currentCalendarYear = new Date().getFullYear();
    let calendarEvents = [];

    // Initialize calendar
    async function generateCalendar() {
      const firstDay = new Date(currentCalendarYear, currentCalendarMonth, 1).getDay();
      const daysInMonth = new Date(currentCalendarYear, currentCalendarMonth + 1, 0).getDate();
      const today = new Date();
      
      // Update month header
      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      document.getElementById('monthHeader').textContent = `${monthNames[currentCalendarMonth]} ${currentCalendarYear}`;
      
      const calendarBody = document.getElementById('calendarBody');
      calendarBody.innerHTML = '';
      
      // Load events for current month
      await loadCalendarEvents();
      console.log('Rendering calendar with events:', calendarEvents.length);
      
      let date = 1;
      for (let i = 0; i < 6; i++) {
        const row = document.createElement('tr');
        for (let j = 0; j < 7; j++) {
          const cell = document.createElement('td');
          if (i === 0 && j < firstDay) {
            cell.textContent = '';
          } else if (date > daysInMonth) {
            cell.textContent = '';
          } else {
            const currentDate = date;
            const dateString = `${currentCalendarYear}-${String(currentCalendarMonth + 1).padStart(2, '0')}-${String(currentDate).padStart(2, '0')}`;
            
            cell.textContent = currentDate;
            cell.style.cursor = 'pointer';
            cell.style.position = 'relative';
            
            // Highlight today
            if (currentDate === today.getDate() && 
                currentCalendarMonth === today.getMonth() && 
                currentCalendarYear === today.getFullYear()) {
              cell.classList.add('today');
            }
            
            // Check for events on this date
            const eventsOnDate = calendarEvents.filter(e => e.date === dateString);
            if (eventsOnDate.length > 0) {
              cell.style.fontWeight = 'bold';
              const indicator = document.createElement('div');
              indicator.style.cssText = 'position:absolute; bottom:4px; left:50%; transform:translateX(-50%); display:flex; gap:3px; justify-content:center;';
              eventsOnDate.slice(0, 3).forEach(event => {
                const dot = document.createElement('div');
                dot.style.cssText = `width:6px; height:6px; border-radius:50%; background:${
                  event.type === 'training' ? '#6C63FF' : 
                  event.type === 'competition' ? '#ff6b6b' : '#ffa500'
                }; box-shadow: 0 1px 3px rgba(0,0,0,0.3);`;
                dot.title = event.type === 'training' ? 'Training Session' : 'Competition';
                indicator.appendChild(dot);
              });
              cell.appendChild(indicator);
            }
            
            // Click handler
            cell.addEventListener('click', () => showEventsForDate(dateString, currentDate));
            
            date++;
          }
          row.appendChild(cell);
        }
        calendarBody.appendChild(row);
      }
    }

    // Load calendar events (training sessions and competitions)
    async function loadCalendarEvents() {
      if (!currentUser) {
        console.log('No current user for calendar events');
        return;
      }
      
      calendarEvents = [];
      console.log('Loading calendar events for user:', currentUser.uid);
      
      try {
        // Load training sessions
        const sessionsQuery = query(
          collection(db, 'trainingSessions'),
          where('coachId', '==', currentUser.uid)
        );
        const sessionsSnapshot = await getDocs(sessionsQuery);
        console.log('Training sessions found:', sessionsSnapshot.size);
        sessionsSnapshot.forEach(doc => {
          const data = doc.data();
          console.log('Training session date:', data.date);
          calendarEvents.push({
            id: doc.id,
            type: 'training',
            date: data.date,
            time: data.time,
            title: data.sessionName,
            details: `Team: ${data.teamName || 'N/A'}`,
            location: data.location
          });
        });
        
        // Load competitions
        const competitionsQuery = query(
          collection(db, 'competitions'),
          where('coachId', '==', currentUser.uid)
        );
        const competitionsSnapshot = await getDocs(competitionsQuery);
        console.log('Competitions found:', competitionsSnapshot.size);
        competitionsSnapshot.forEach(doc => {
          const data = doc.data();
          console.log('Competition date:', data.date);
          calendarEvents.push({
            id: doc.id,
            type: 'competition',
            date: data.date,
            time: data.time,
            title: data.competitionName,
            details: `${data.opponentName || 'TBD'}`,
            location: data.location
          });
        });
        
        console.log('Total calendar events loaded:', calendarEvents.length);
        console.log('Events:', calendarEvents);
      } catch (error) {
        console.error('Error loading calendar events:', error);
      }
    }

    // Show events for selected date
    function showEventsForDate(dateString, day) {
      const eventsOnDate = calendarEvents.filter(e => e.date === dateString);
      const eventDisplay = document.getElementById('selectedDateEvents');
      const eventsList = document.getElementById('selectedDateEventsList');
      const dateTitle = document.getElementById('selectedDateTitle');
      
      if (eventsOnDate.length === 0) {
        eventDisplay.style.display = 'none';
        return;
      }
      
      const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      dateTitle.textContent = `${monthNames[currentCalendarMonth]} ${day}, ${currentCalendarYear}`;
      
      eventsList.innerHTML = '';
      eventsOnDate.forEach(event => {
        const eventItem = document.createElement('div');
        eventItem.style.cssText = 'padding:12px; margin-bottom:8px; background:white; border-radius:6px; border-left:4px solid ' + 
          (event.type === 'training' ? '#6C63FF' : '#ff6b6b');
        eventItem.innerHTML = `
          <div style="font-weight:600; margin-bottom:4px;">${event.title}</div>
          <div style="font-size:12px; color:#666; margin-bottom:2px;">
            <span style="text-transform:capitalize;">${event.type}</span> ‚Ä¢ ${event.time || 'No time set'}
          </div>
          <div style="font-size:12px; color:#666;">${event.details}</div>
          ${event.location ? `<div style="font-size:12px; color:#666; margin-top:4px;">üìç ${event.location}</div>` : ''}
        `;
        eventsList.appendChild(eventItem);
      });
      
      eventDisplay.style.display = 'block';
    }

    // Calendar navigation
    document.getElementById('prevMonthBtn')?.addEventListener('click', () => {
      currentCalendarMonth--;
      if (currentCalendarMonth < 0) {
        currentCalendarMonth = 11;
        currentCalendarYear--;
      }
      generateCalendar();
    });

    document.getElementById('nextMonthBtn')?.addEventListener('click', () => {
      currentCalendarMonth++;
      if (currentCalendarMonth > 11) {
        currentCalendarMonth = 0;
        currentCalendarYear++;
      }
      generateCalendar();
    });

    generateCalendar();

    // Navigation
    function showSection(sectionId) {
      document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
      document.querySelectorAll('.content-section').forEach(sectionEl => sectionEl.classList.remove('active'));
      
      const navItem = document.querySelector(`[data-section="${sectionId}"]`);
      if (navItem) {
        navItem.classList.add('active');
      }
      const section = document.getElementById(sectionId);
      if (section) {
        section.classList.add('active');
      }
    }
    
    // Check URL hash on page load
    if (window.location.hash) {
      const sectionId = window.location.hash.substring(1); // Remove the '#'
      if (document.getElementById(sectionId)) {
        showSection(sectionId);
        // Load teams if teams section is requested on page load
        if (sectionId === 'teams' && teams.length === 0) {
          loadTeams();
        }
      }
    }
    
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', () => {
        const section = item.getAttribute('data-section');

        window.location.hash = section; // Update URL hash
        showSection(section);
        
        // Load teams if teams section is clicked
        if (section === 'teams' && teams.length === 0) {
          loadTeams();
        }

        // Load training sessions if training section is clicked
        if (section === 'training') {
          loadTrainingSessions();
        }
      });
    });

    // Sign Out
    document.getElementById('signOutBtn').addEventListener('click', async (e) => {
      e.preventDefault();
      await logout();
    });

    // Reminder helpers
    const remindersListEl = document.getElementById('remindersList');

    function renderReminders() {
      if (!remindersListEl) return;
      remindersListEl.innerHTML = '';

      if (!reminders.length) {
        const empty = document.createElement('div');
        empty.className = 'reminder-empty';
        empty.textContent = 'No reminders yet.';
        remindersListEl.appendChild(empty);
        return;
      }

      reminders.forEach((text, index) => {
        const item = document.createElement('div');
        item.className = 'reminder-item';
        item.innerHTML = `
          <div class="reminder-item-row">
            <span class="reminder-text">${text}</span>
            <button class="reminder-delete-btn" data-index="${index}" aria-label="Delete reminder">
              Delete
            </button>
          </div>
        `;
        remindersListEl.appendChild(item);
      });
    }

    async function persistReminders(nextReminders) {
      if (!currentUser) return;
      await updateDoc(doc(db, 'profiles', currentUser.uid), { reminders: nextReminders });
    }

    async function addReminder() {
      const reminder = prompt('Enter new reminder:');
      if (!reminder) return;
      const trimmed = reminder.trim();
      if (!trimmed) return;

      const next = [...reminders, trimmed];
      reminders = next;
      renderReminders();
      try {
        await persistReminders(next);
      } catch (err) {
        console.error('Failed to save reminder', err);
        alert('Could not save reminder. Please try again.');
        reminders = reminders.filter((_, idx) => idx !== next.length - 1);
        renderReminders();
      }
    }

    async function deleteReminder(index) {
      if (index < 0 || index >= reminders.length) return;
      const next = reminders.filter((_, i) => i !== index);
      const previous = reminders;
      reminders = next;
      renderReminders();
      try {
        await persistReminders(next);
      } catch (err) {
        console.error('Failed to delete reminder', err);
        alert('Could not delete reminder. Please try again.');
        reminders = previous;
        renderReminders();
      }
    }

    document.getElementById('addReminderBtn').addEventListener('click', addReminder);
    remindersListEl.addEventListener('click', (e) => {
      const btn = e.target.closest('.reminder-delete-btn');
      if (!btn) return;
      const index = Number(btn.dataset.index);
      deleteReminder(index);
    });

    // Fetch athletes from database
    async function fetchAthletes() {
      const membersGrid = document.getElementById('membersGrid');
      
      try {
        console.log('Starting to fetch athletes...');
        
        // For now, use sample data if we don't have permission
        // You'll need to update Firebase rules to allow coaches to read athlete profiles
        athletes = [
          { id: '1', name: 'Sample Athlete 1', avatar: 'assets/athlete.png', sport: '' },
          { id: '2', name: 'Sample Athlete 2', avatar: 'assets/athlete.png', sport: '' },
          { id: '3', name: 'Sample Athlete 3', avatar: 'assets/athlete.png', sport: '' },
          { id: '4', name: 'Sample Athlete 4', avatar: 'assets/athlete.png', sport: '' }
        ];
        
        // Try to fetch real athletes
        if (db && currentUser) {
          try {
            const profilesRef = collection(db, 'profiles');
            const querySnapshot = await getDocs(profilesRef);
            
            const fetchedAthletes = [];
            querySnapshot.forEach((doc) => {
              const data = doc.data();
              // Only include athletes, exclude the current coach
              if (doc.id !== currentUser.uid && (!data.role || data.role === 'athlete')) {
                fetchedAthletes.push({
                  id: doc.id,
                  name: data.name || data.email || 'Unknown',
                  avatar: data.avatar || 'assets/athlete.png',
                  sport: data.sport || ''
                });
              }
            });
            
            if (fetchedAthletes.length > 0) {
              athletes = fetchedAthletes;
              console.log('Successfully loaded athletes from database:', athletes.length);
            }
          } catch (dbError) {
            console.warn('Could not fetch from database, using sample data:', dbError.message);
            if (membersGrid) {
              const warningDiv = document.createElement('div');
              warningDiv.style.cssText = 'grid-column: 1/-1; padding:10px; background:#fff3cd; border:1px solid #ffc107; border-radius:8px; margin-bottom:12px; font-size:12px;';
              warningDiv.textContent = 'Note: Using sample data. Update Firebase rules to see real athletes.';
              membersGrid.parentElement.insertBefore(warningDiv, membersGrid);
            }
          }
        }
        
        console.log('Athletes to display:', athletes.length);
        renderMemberGrid();
      } catch (error) {
        console.error('Error in fetchAthletes:', error);
        
        if (membersGrid) {
          membersGrid.innerHTML = `<div style="grid-column: 1/-1; text-align:center; color:#666;">
            <p>Unable to load athletes.</p>
            <p style="font-size:12px;">Firebase permissions may need to be updated.</p>
          </div>`;
        }
      }
    }

    // Render member grid with fetched athletes
    function renderMemberGrid() {
      const membersGrid = document.getElementById('membersGrid');
      if (!membersGrid) return;
      
      membersGrid.innerHTML = '';
      
      if (athletes.length === 0) {
        membersGrid.innerHTML = '<div style="grid-column: 1/-1; text-align:center; color:#666;">No athletes found</div>';
        return;
      }
      
      athletes.forEach(athlete => {
        const memberCard = document.createElement('div');
        memberCard.className = 'member-card';
        memberCard.dataset.athleteId = athlete.id;
        memberCard.innerHTML = `
          <img src="${athlete.avatar}" alt="${athlete.name}" class="member-avatar" />
          <span class="member-name">${athlete.name}</span>
          <button class="member-add-btn">‚äï</button>
        `;
        membersGrid.appendChild(memberCard);
      });
    }

    // Search functionality for members
    const memberSearchInput = document.getElementById('memberSearchInput');
    if (memberSearchInput) {
      memberSearchInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const memberCards = document.querySelectorAll('.member-card');
        
        memberCards.forEach(card => {
          const name = card.querySelector('.member-name').textContent.toLowerCase();
          if (name.includes(searchTerm)) {
            card.style.display = 'flex';
          } else {
            card.style.display = 'none';
          }
        });
      });
    }

    // Add team button - navigate to add team section
    const addTeamCircleBtn = document.getElementById('addTeamCircleBtn');
    if (addTeamCircleBtn) {
      addTeamCircleBtn.addEventListener('click', async () => {
        // Reset editing mode
        editingTeamId = null;
        createTeamBtn.textContent = 'Upload';
        
        // Reset form
        document.getElementById('teamNameInput').value = '';
        teamImageData = null;
        if (teamPreviewImage) {
          teamPreviewImage.style.display = 'none';
          teamPreviewImage.src = '';
        }
        if (uploadIcon) uploadIcon.style.display = 'block';
        if (teamImageInput) teamImageInput.value = '';
        
        // Fetch athletes when navigating to add team page
        await fetchAthletes();
        
        // Switch to add team section
        document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
        document.getElementById('addTeam').classList.add('active');
        
        // Update nav items
        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
      });
    }

    // Back button from add team page
    document.getElementById('backToTeamsFromAddBtn')?.addEventListener('click', () => {
      document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
      document.getElementById('teams').classList.add('active');
    });
    
    // Team image upload
    let teamImageData = null;
    const uploadCircle = document.getElementById('uploadCircle');
    const teamImageInput = document.getElementById('teamImageInput');
    const teamPreviewImage = document.getElementById('teamPreviewImage');
    const uploadIcon = document.getElementById('uploadIcon');
    
    if (uploadCircle && teamImageInput) {
      uploadCircle.addEventListener('click', () => {
        teamImageInput.click();
      });
      
      teamImageInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            teamImageData = event.target.result;
            teamPreviewImage.src = teamImageData;
            teamPreviewImage.style.display = 'block';
            uploadIcon.style.display = 'none';
          };
          reader.readAsDataURL(file);
        }
      });
    }
    
    // Toggle member selection
    const membersGrid = document.getElementById('membersGrid');
    if (membersGrid) {
      membersGrid.addEventListener('click', (e) => {
        const btn = e.target.closest('.member-add-btn');
        if (!btn) return;
        
        if (btn.classList.contains('selected')) {
          btn.classList.remove('selected');
          btn.textContent = '‚äï';
        } else {
          btn.classList.add('selected');
          btn.textContent = '‚úì';
        }
      });
    }
    
    // Create/Update team button
    const createTeamBtn = document.getElementById('createTeamBtn');
    if (createTeamBtn) {
      createTeamBtn.addEventListener('click', async () => {
        const teamName = document.getElementById('teamNameInput').value;
        if (!teamName.trim()) {
          alert('Please enter a team name');
          return;
        }
        
        // Get selected member IDs
        const selectedMemberCards = document.querySelectorAll('.member-add-btn.selected');
        const selectedMemberIds = Array.from(selectedMemberCards).map(btn => {
          return btn.closest('.member-card')?.dataset.athleteId;
        }).filter(id => id);
        
        // Use uploaded image or default
        const imageUrl = teamImageData || 'assets/coach.png';
        
        // Create team object
        const teamData = {
          name: teamName,
          image: imageUrl,
          coachId: currentUser.uid,
          memberIds: selectedMemberIds,
          updatedAt: new Date().toISOString()
        };
        
        try {
          if (editingTeamId) {
            // Update existing team
            try {
              await setDoc(doc(db, 'teams', editingTeamId), teamData, { merge: true });
              console.log('Team updated in Firebase successfully');
            } catch (firebaseError) {
              console.warn('Could not update in Firebase:', firebaseError.message);
            }
            
            // Update local teams array
            const teamIndex = teams.findIndex(t => t.id === editingTeamId);
            if (teamIndex !== -1) {
              teams[teamIndex] = {
                id: editingTeamId,
                ...teamData
              };
            }
            
            alert('Team updated successfully!');
            editingTeamId = null;
            createTeamBtn.textContent = 'Upload';
          } else {
            // Create new team
            teamData.createdAt = new Date().toISOString();
            const teamsRef = collection(db, 'teams');
            const newTeamRef = doc(teamsRef);
            
            try {
              await setDoc(newTeamRef, teamData);
              console.log('Team saved to Firebase successfully');
            } catch (firebaseError) {
              console.warn('Could not save to Firebase:', firebaseError.message);
            }
            
            // Add to local teams array
            teams.push({
              id: newTeamRef.id,
              ...teamData
            });
            
            alert('Team created successfully!');
          }
          
          // Render teams
          renderTeams();
          
          // Reset form
          document.getElementById('teamNameInput').value = '';
          teamImageData = null;
          if (teamPreviewImage) {
            teamPreviewImage.style.display = 'none';
            teamPreviewImage.src = '';
          }
          if (uploadIcon) uploadIcon.style.display = 'block';
          if (teamImageInput) teamImageInput.value = '';
          document.querySelectorAll('.member-add-btn.selected').forEach(btn => {
            btn.classList.remove('selected');
            btn.textContent = '‚äï';
          });
          
          // Navigate back to teams section
          document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
          document.getElementById('teams').classList.add('active');
          
          // Update nav items
          document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
          document.querySelector('[data-section="teams"]').classList.add('active');
        } catch (error) {
          console.error('Error saving team:', error);
          console.error('Error details:', error.message, error.code);
          alert('Failed to save team: ' + error.message);
        }
      });
    }

    // ===== TRAINING SESSION FUNCTIONS =====
    let trainingSessions = [];
    let currentTrainingFilter = 'all';

    // Calculate status based on date and time (respects manual override)
    function calculateSessionStatus(session) {
      // If coach manually set status, use that (unless it's currently in-progress)
      if (session.manualStatus) {
        const now = new Date();
        const sessionDateTime = new Date(`${session.date}T${session.time}`);
        const sessionEndTime = new Date(sessionDateTime.getTime() + (session.duration || 60) * 60000);
        
        // Override manual status if session is currently in progress
        if (now >= sessionDateTime && now < sessionEndTime) {
          return 'in-progress';
        }
        
        return session.manualStatus;
      }
      
      // Auto-calculate status
      const now = new Date();
      const sessionDateTime = new Date(`${session.date}T${session.time}`);
      const sessionEndTime = new Date(sessionDateTime.getTime() + (session.duration || 60) * 60000);
      
      if (now < sessionDateTime) {
        return 'upcoming';
      } else if (now >= sessionDateTime && now < sessionEndTime) {
        return 'in-progress';
      } else {
        return 'completed';
      }
    }

    // Load training sessions from Firebase
    async function loadTrainingSessions() {
      try {
        const userId = currentUser.uid;
        const sessionsQuery = query(
          collection(db, 'trainingSessions'),
          where('coachId', '==', userId)
        );
        
        const querySnapshot = await getDocs(sessionsQuery);
        trainingSessions = [];
        
        querySnapshot.forEach((doc) => {
          trainingSessions.push({
            id: doc.id,
            ...doc.data()
          });
        });
        
        renderTrainingSessions();
      } catch (error) {
        console.error('Error loading training sessions:', error);
      }
    }

    // Render training sessions list
    function renderTrainingSessions() {
      const sessionsList = document.getElementById('trainingSessionsList');
      if (!sessionsList) return;

      if (trainingSessions.length === 0) {
        sessionsList.innerHTML = '<div style="text-align:center; color:#999; padding:40px; grid-column: 1/-1;">No training sessions yet. Create one to get started!</div>';
        return;
      }

      // Calculate current status for each session
      const sessionsWithStatus = trainingSessions.map(session => ({
        ...session,
        status: calculateSessionStatus(session)
      }));

      // Filter sessions based on current filter
      let filteredSessions = sessionsWithStatus;
      if (currentTrainingFilter !== 'all') {
        filteredSessions = sessionsWithStatus.filter(session => session.status === currentTrainingFilter);
      }

      // Sort by date (newest first)
      filteredSessions.sort((a, b) => {
        const dateA = new Date(`${a.date}T${a.time}`);
        const dateB = new Date(`${b.date}T${b.time}`);
        return dateB - dateA;
      });

      // Display filtered sessions
      if (filteredSessions.length === 0) {
        sessionsList.innerHTML = `<div style="text-align:center; color:#999; padding:40px; grid-column: 1/-1;">No ${currentTrainingFilter} sessions found.</div>`;
        return;
      }

      sessionsList.innerHTML = '';
      filteredSessions.forEach(session => {
        const sessionCard = document.createElement('div');
        sessionCard.className = 'training-card';
        
        sessionCard.innerHTML = `
          <div class="training-card-title" onclick="showSessionMembers('${session.id}')">
            ${session.sessionName}
          </div>
          
          <div class="training-card-info" onclick="showSessionMembers('${session.id}')">
            <strong>Date:</strong>
            <span>${new Date(session.date).toLocaleDateString()}</span>
          </div>
          
          <div class="training-card-info" onclick="showSessionMembers('${session.id}')">
            <strong>Time:</strong>
            <span>${session.time || 'Not set'}</span>
          </div>
          
          <div class="training-card-info" onclick="showSessionMembers('${session.id}')">
            <strong>Team:</strong>
            <span>${session.teamName || 'Not assigned'}</span>
          </div>
          
          <div class="training-card-info">
            <strong>Status:</strong>
            <select onchange="updateSessionStatus('${session.id}', this.value)" style="
              font-size: 12px; 
              font-weight: 600; 
              padding: 4px 8px; 
              border: 2px solid ${
                session.status === 'completed' ? '#28a745' : 
                session.status === 'in-progress' ? '#dc3545' : 
                '#ffa500'
              }; 
              border-radius: 6px; 
              background: white; 
              color: ${
                session.status === 'completed' ? '#28a745' : 
                session.status === 'in-progress' ? '#dc3545' : 
                '#ffa500'
              }; 
              cursor: pointer;
              margin-left: auto;
            ">
              <option value="upcoming" ${session.status === 'upcoming' ? 'selected' : ''}>Upcoming</option>
              <option value="in-progress" ${session.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
              <option value="completed" ${session.status === 'completed' ? 'selected' : ''}>Completed</option>
            </select>
          </div>
          
          <div class="training-card-actions">
            <button class="training-card-btn view" onclick="showSessionMembers('${session.id}')">
              View Team
            </button>
            <button class="training-card-btn" onclick="event.stopPropagation(); editTrainingSession('${session.id}')">
              Edit
            </button>
            <button class="training-card-btn delete" onclick="event.stopPropagation(); deleteTrainingSession('${session.id}')">
              Delete
            </button>
          </div>
        `;
        
        sessionsList.appendChild(sessionCard);
      });
    }

    // Delete training session
    window.deleteTrainingSession = async function(sessionId) {
      if (!confirm('Are you sure you want to delete this training session?')) return;

      try {
        await deleteDoc(doc(db, 'trainingSessions', sessionId));
        trainingSessions = trainingSessions.filter(s => s.id !== sessionId);
        renderTrainingSessions();
        alert('Training session deleted successfully!');
      } catch (error) {
        console.error('Error deleting training session:', error);
        alert('Failed to delete training session: ' + error.message);
      }
    };

    // Update session status
    window.updateSessionStatus = async function(sessionId, newStatus) {
      try {
        await updateDoc(doc(db, 'trainingSessions', sessionId), {
          manualStatus: newStatus,
          statusUpdatedAt: new Date()
        });
        
        // Update local array
        const session = trainingSessions.find(s => s.id === sessionId);
        if (session) {
          session.manualStatus = newStatus;
          session.statusUpdatedAt = new Date();
        }
        
        renderTrainingSessions();
      } catch (error) {
        console.error('Error updating status:', error);
        alert('Failed to update status: ' + error.message);
      }
    };

    // Training session filter buttons
    document.querySelectorAll('.training-filter-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        // Update active state
        document.querySelectorAll('.training-filter-btn').forEach(b => {
          b.classList.remove('active');
          b.style.fontWeight = 'normal';
        });
        this.classList.add('active');
        this.style.fontWeight = '600';
        
        // Update filter and re-render
        currentTrainingFilter = this.dataset.filter;
        renderTrainingSessions();
      });
    });

    // Delete training session
    window.deleteTrainingSession = async function(sessionId) {
      if (!confirm('Are you sure you want to delete this training session?')) return;

      try {
        await deleteDoc(doc(db, 'trainingSessions', sessionId));
        trainingSessions = trainingSessions.filter(s => s.id !== sessionId);
        renderTrainingSessions();
        alert('Training session deleted successfully!');
      } catch (error) {
        console.error('Error deleting training session:', error);
        alert('Failed to delete training session');
      }
    };

    // Edit training session
    window.editTrainingSession = async function(sessionId) {
      const session = trainingSessions.find(s => s.id === sessionId);
      if (!session) return;

      // Make sure teams are loaded
      if (teams.length === 0) {
        await loadTeams();
      }

      // Populate team select dropdown
      const teamSelect = document.getElementById('sessionTeamSelect');
      teamSelect.innerHTML = '<option value="">Choose a team...</option>';
      if (teams.length === 0) {
        teamSelect.innerHTML += '<option disabled>No teams available</option>';
      } else {
        teams.forEach(team => {
          const option = document.createElement('option');
          option.value = team.id;
          option.textContent = team.name;
          teamSelect.appendChild(option);
        });
      }

      // Populate form with session data
      document.getElementById('sessionNameInput').value = session.sessionName || '';
      document.getElementById('sessionDateInput').value = session.date || '';
      document.getElementById('sessionTimeInput').value = session.time || '';
      document.getElementById('sessionDurationInput').value = session.duration || '';
      document.getElementById('sessionLocationInput').value = session.location || '';
      document.getElementById('sessionDescriptionInput').value = session.description || '';
      document.getElementById('sessionTeamSelect').value = session.teamId || '';

      // Store the ID being edited
      window.currentEditingSessionId = sessionId;
      window.isEditingSession = true;

      // Switch to add training view
      document.getElementById('trainingListView').style.display = 'none';
      document.getElementById('addTrainingView').style.display = 'block';
    };
    // Global variables for athlete data modal
    let currentSessionData = null;

    // Show session members section
    window.showSessionMembers = async function(sessionId) {
      const session = trainingSessions.find(s => s.id === sessionId);
      if (!session) {
        alert('Session not found');
        return;
      }

      if (!session.teamId) {
        alert('No team assigned to this session');
        return;
      }

      // Store session data globally for modal access
      currentSessionData = session;

      // Test Firebase rules first
      console.log('Testing Firebase rules...');
      try {
        const testDoc = await getDoc(doc(db, 'profiles', currentUser.uid));
        console.log('Firebase rules test - can read own profile:', testDoc.exists());
      } catch (error) {
        console.error('Firebase rules test failed:', error);
      }

      // Make sure teams are loaded with complete data
      if (teams.length === 0) {
        await loadTeams();
      }

      // Find the team
      let team = teams.find(t => t.id === session.teamId);
      if (!team) {
        // Try to reload teams and find again
        await loadTeams();
        team = teams.find(t => t.id === session.teamId);
        if (!team) {
          alert('Team not found');
          return;
        }
      }

      console.log('Team found:', team);
      console.log('Team memberIds:', team.memberIds);

      // Update section title
      document.getElementById('sessionMembersTitle').textContent = `${session.sessionName} - Team Members`;

      // Hide training list and show members section
      document.getElementById('trainingListView').style.display = 'none';
      document.getElementById('sessionMembersSection').style.display = 'block';

      // Load and display team members
      await loadSessionMembers(team, session);
    };

    // Load member session stats
    async function loadMemberSessionStats(athleteId, sessionId) {
      try {
        const dataId = `${athleteId}_${sessionId}`;
        const docRef = doc(db, 'athleteSessionData', dataId);
        const docSnap = await getDoc(docRef);
        
        if (docSnap.exists()) {
          return docSnap.data();
        }
        return null;
      } catch (error) {
        console.error('Error loading member stats:', error);
        return null;
      }
    }

    // Load session members
    async function loadSessionMembers(team, session) {
      const membersList = document.getElementById('sessionMembersList');
      
      console.log('Loading members for team:', team);
      console.log('Team memberIds:', team.memberIds);
      console.log('All team properties:', Object.keys(team));
      
      // Check both memberIds and members fields
      const memberIds = team.memberIds || team.members || [];
      
      if (!memberIds || memberIds.length === 0) {
        membersList.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">No members assigned to this team yet.</div>';
        return;
      }

      membersList.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">Loading team members...</div>';

      try {
        const memberDetails = [];
        
        console.log('Fetching details for memberIds:', memberIds);
        
        // Get member details from Firebase users collection and profiles collection
        for (const memberId of memberIds) {
          try {
            console.log('Fetching member:', memberId);
            console.log('Current user:', currentUser?.uid);
            console.log('Auth state:', currentUser ? 'authenticated' : 'not authenticated');
            
            // Try users collection first
            console.log('Attempting to fetch from users collection...');
            let memberDoc = await getDoc(doc(db, 'users', memberId));
            let memberData = null;
            
            if (memberDoc.exists()) {
              memberData = memberDoc.data();
              console.log('SUCCESS: Found in users collection:', memberData);
            } else {
              console.log('Not found in users collection, document does not exist');
              // Try profiles collection if not found in users
              console.log('Attempting to fetch from profiles collection...');
              memberDoc = await getDoc(doc(db, 'profiles', memberId));
              if (memberDoc.exists()) {
                memberData = memberDoc.data();
                console.log('SUCCESS: Found in profiles collection:', memberData);
              } else {
                console.log('Not found in profiles collection either, document does not exist');
              }
            }
            
            if (memberData) {
              memberDetails.push({
                id: memberId,
                ...memberData
              });
            } else {
              console.log('No data found for member:', memberId);
            }
          } catch (error) {
            console.error(`FIREBASE ERROR loading member ${memberId}:`, error);
            console.error('Error code:', error.code);
            console.error('Error message:', error.message);
            console.error('Error details:', error);
          }
        }

        console.log('Member details loaded:', memberDetails);

        if (memberDetails.length === 0) {
          membersList.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">No member details found. This may be due to Firebase permissions.<br><small>Checked IDs: ' + JSON.stringify(memberIds) + '<br>Tried both users and profiles collections</small></div>';
          return;
        }

        // Render member stats cards
        membersList.innerHTML = '';
        membersList.className = 'members-stats-grid';
        
        // Load stats for all members
        const membersWithStats = await Promise.all(
          memberDetails.map(async (member) => {
            const stats = await loadMemberSessionStats(member.id, session.id);
            return { ...member, stats };
          })
        );
        
        membersWithStats.forEach(member => {
          const memberCard = document.createElement('div');
          memberCard.className = member.stats ? 'member-stats-card' : 'member-stats-card no-data-card';
          
          const initials = (member.firstName && member.lastName) 
            ? `${member.firstName.charAt(0)}${member.lastName.charAt(0)}`.toUpperCase()
            : member.email ? member.email.charAt(0).toUpperCase() 
            : member.name ? member.name.charAt(0).toUpperCase()
            : '?';
          
          const displayName = (member.firstName && member.lastName) 
            ? `${member.firstName} ${member.lastName}` 
            : member.name || member.email || 'Name not set';
          
          if (member.stats) {
            memberCard.innerHTML = `
              <div class="member-stats-header">
                <div class="member-stats-avatar">${initials}</div>
                <div class="member-stats-info">
                  <h4>${displayName}</h4>
                  <div class="member-status">${member.stats.attendance || 'Present'}</div>
                </div>
              </div>
              <div class="stats-row">
                <div class="stat-item">
                  <div class="stat-label">PTS</div>
                  <div class="stat-value">${member.stats.points || 0}</div>
                </div>
                <div class="stat-item">
                  <div class="stat-label">REB</div>
                  <div class="stat-value">${member.stats.rebounds || 0}</div>
                </div>
              </div>
              <div class="stats-row">
                <div class="stat-item">
                  <div class="stat-label">AST</div>
                  <div class="stat-value">${member.stats.assists || 0}</div>
                </div>
                <div class="stat-item">
                  <div class="stat-label">TO</div>
                  <div class="stat-value">${member.stats.turnovers || 0}</div>
                </div>
              </div>
              <div class="stats-row">
                <div class="stat-item">
                  <div class="stat-label">FOULS</div>
                  <div class="stat-value">${member.stats.fouls || 0}</div>
                </div>
                <div class="stat-item">
                  <div class="stat-label">RPE</div>
                  <div class="stat-value">${member.stats.rpe || '-'}</div>
                </div>
              </div>
            `;
          } else {
            memberCard.innerHTML = `
              <div class="member-stats-header">
                <div class="member-stats-avatar">${initials}</div>
                <div class="member-stats-info">
                  <h4>${displayName}</h4>
                  <div class="member-status">No session data</div>
                </div>
              </div>
              <div style="text-align: center; color: #999; margin-top: 16px;">
                <p>Click to add session data</p>
              </div>
            `;
          }
          
          // Make member card clickable to open athlete data modal
          memberCard.addEventListener('click', () => {
            console.log('Clicked member:', member);
            console.log('Session context:', session);
            openAthleteDataModal(member, session);
          });
          
          membersList.appendChild(memberCard);
        });

      } catch (error) {
        console.error('Error loading session members:', error);
        membersList.innerHTML = '<div style="text-align:center; color:#dc3545; padding:20px;">Error loading team members. This may be due to Firebase permissions.<br>Error: ' + error.message + '</div>';
      }
    }

    // Athlete Data Modal Functions
    let currentAthleteData = null;
    let currentSessionContext = null;

    function openAthleteDataModal(athlete, session) {
      console.log('Opening athlete data modal for:', athlete.name);
      console.log('Session object received:', session);
      console.log('Session properties:', Object.keys(session));
      
      currentAthleteData = athlete;
      currentSessionContext = session;
      
      // Update modal title
      const modalTitle = document.querySelector('#athleteDataModal .modal-title');
      if (modalTitle) {
        modalTitle.textContent = `Session Data - ${athlete.name}`;
      }
      
      // Update session info
      const sessionInfo = document.querySelector('#athleteDataModal .session-info');
      if (sessionInfo) {
        sessionInfo.innerHTML = `
          <strong>Training Session:</strong> ${session.sessionName || 'Unknown Session'}<br>
          <strong>Date:</strong> ${new Date(session.date).toLocaleDateString()}<br>
          <strong>Team:</strong> ${session.teamName || 'Unknown'}<br>
          <strong>Team ID:</strong> ${session.teamId || 'Missing teamId'}
        `;
      }
      
      // Load existing data if available
      loadExistingAthleteData(athlete.id, session.id);
      
      // Store session data in hidden form fields for reliable access
      const form = document.getElementById('athleteDataForm');
      if (form) {
        // Remove existing hidden fields
        form.querySelectorAll('input[type="hidden"]').forEach(input => input.remove());
        
        // Add session data as hidden fields
        const sessionFields = [
          { name: 'sessionId', value: session.id || '' },
          { name: 'sessionName', value: session.sessionName || '' },
          { name: 'sessionDate', value: session.date || '' },
          { name: 'sessionTeamId', value: session.teamId || '' },
          { name: 'sessionTeamName', value: session.teamName || '' }
        ];
        
        sessionFields.forEach(field => {
          const hiddenInput = document.createElement('input');
          hiddenInput.type = 'hidden';
          hiddenInput.name = field.name;
          hiddenInput.value = field.value;
          form.appendChild(hiddenInput);
        });
      }
      
      // Show modal
      const modal = document.getElementById('athleteDataModal');
      if (modal) {
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden'; // Prevent background scrolling
      }
    }

    function closeAthleteDataModal() {
      const modal = document.getElementById('athleteDataModal');
      if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto'; // Restore scrolling
      }
      
      // Clear form
      clearAthleteDataForm();
      currentAthleteData = null;
      currentSessionContext = null;
    }

    function clearAthleteDataForm() {
      const form = document.getElementById('athleteDataForm');
      if (form) {
        form.reset();
      }
    }

    async function loadExistingAthleteData(athleteId, sessionId) {
      try {
        const dataId = `${athleteId}_${sessionId}`;
        const docRef = doc(db, 'athleteSessionData', dataId);
        const docSnap = await getDoc(docRef);
        
        if (docSnap.exists()) {
          const data = docSnap.data();
          console.log('Loading existing athlete data:', data);
          
          // Populate form with existing data
          const form = document.getElementById('athleteDataForm');
          if (form) {
            const fields = ['points', 'rebounds', 'assists', 'turnovers', 'fouls', 'rpe', 'attendance', 'notes'];
            fields.forEach(field => {
              const input = form.querySelector(`[name="${field}"]`);
              if (input && data[field] !== undefined) {
                input.value = data[field];
              }
            });
          }
        }
      } catch (error) {
        console.error('Error loading existing athlete data:', error);
      }
    }

    async function saveAthleteData() {
      console.log('saveAthleteData called');
      console.log('currentAthleteData:', currentAthleteData);
      console.log('currentSessionContext:', currentSessionContext);
      
      if (!currentAthleteData || !currentSessionContext) {
        console.error('Missing data - currentAthleteData:', currentAthleteData, 'currentSessionContext:', currentSessionContext);
        alert('Error: Missing athlete or session data');
        return;
      }
      
      try {
        const form = document.getElementById('athleteDataForm');
        const formData = new FormData(form);
        
        // Get session data from form (more reliable) or fallback to global variables
        const sessionId = formData.get('sessionId') || currentSessionContext?.id;
        const sessionName = formData.get('sessionName') || currentSessionContext?.sessionName || 'Unknown Session';
        const sessionDate = formData.get('sessionDate') || currentSessionContext?.date;
        const teamId = formData.get('sessionTeamId') || currentSessionContext?.teamId || 'unknown';
        const teamName = formData.get('sessionTeamName') || currentSessionContext?.teamName || 'Unknown Team';
        
        if (!sessionId) {
          alert('Error: Session information is missing');
          return;
        }
        
        // Create data object
        const athleteSessionData = {
          athleteId: currentAthleteData.id,
          athleteName: currentAthleteData.name,
          athleteEmail: currentAthleteData.email, // Add email for cross-reference
          sessionId: sessionId,
          sessionName: sessionName,
          sessionDate: sessionDate,
          teamId: teamId,
          teamName: teamName,
          // Session data
          rpe: (formData.get('attendance') === 'Absent' || formData.get('attendance') === 'Injured') ? 0 : (parseInt(formData.get('rpe')) || 1),
          attendance: formData.get('attendance') || 'Present',
          notes: formData.get('notes') || '',
          
          // Performance stats - set to 0 if absent or injured
          points: (formData.get('attendance') === 'Absent' || formData.get('attendance') === 'Injured') ? 0 : (parseInt(formData.get('points')) || 0),
          rebounds: (formData.get('attendance') === 'Absent' || formData.get('attendance') === 'Injured') ? 0 : (parseInt(formData.get('rebounds')) || 0),
          assists: (formData.get('attendance') === 'Absent' || formData.get('attendance') === 'Injured') ? 0 : (parseInt(formData.get('assists')) || 0),
          turnovers: (formData.get('attendance') === 'Absent' || formData.get('attendance') === 'Injured') ? 0 : (parseInt(formData.get('turnovers')) || 0),
          fouls: (formData.get('attendance') === 'Absent' || formData.get('attendance') === 'Injured') ? 0 : (parseInt(formData.get('fouls')) || 0),
          
          // Metadata
          updatedAt: new Date().toISOString(),
          updatedBy: currentUser?.email || 'unknown'
        };
        
        console.log('Data to save:', athleteSessionData);
        console.log('Athlete ID being saved:', currentAthleteData.id);
        console.log('Athlete email being saved:', currentAthleteData.email);
        
        // Save to Firestore - use athleteSessionData collection
        const dataId = `${currentAthleteData.id}_${sessionId}`;
        const docRef = doc(db, 'athleteSessionData', dataId);
        
        await setDoc(docRef, athleteSessionData, { merge: true });
        
        console.log('Athlete session data saved successfully');
        alert('Athlete data saved successfully!');
        
        // Close modal
        closeAthleteDataModal();
        
        // Refresh the member display to show updated stats
        const team = teams.find(t => t.id === teamId);
        if (team && sessionId) {
          // Recreate session object for refresh
          const sessionForRefresh = {
            id: sessionId,
            sessionName: sessionName,
            date: sessionDate,
            teamId: teamId,
            teamName: teamName
          };
          await loadSessionMembers(team, sessionForRefresh);
        }
        
      } catch (error) {
        console.error('Error saving athlete data:', error);
        alert('Error saving data: ' + error.message);
      }
    }

    // Modal event listeners
    document.addEventListener('DOMContentLoaded', () => {
      // Close modal when clicking outside
      const modal = document.getElementById('athleteDataModal');
      if (modal) {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            closeAthleteDataModal();
          }
        });
      }
      
      // Save button
      const saveBtn = document.getElementById('saveAthleteData');
      if (saveBtn) {
        saveBtn.addEventListener('click', saveAthleteData);
      }
      
      // Cancel button
      const cancelBtn = document.getElementById('cancelAthleteData');
      if (cancelBtn) {
        cancelBtn.addEventListener('click', closeAthleteDataModal);
      }
      
      // Close button
      const closeBtn = document.querySelector('#athleteDataModal .modal-close');
      if (closeBtn) {
        closeBtn.addEventListener('click', closeAthleteDataModal);
      }
    });

    // Show add training session form
    const addTrainingSessionBtn = document.getElementById('addTrainingSessionBtn');
    if (addTrainingSessionBtn) {
      addTrainingSessionBtn.addEventListener('click', async () => {
        // Make sure teams are loaded
        if (teams.length === 0) {
          await loadTeams();
        }

        // Reset form
        document.getElementById('sessionNameInput').value = '';
        document.getElementById('sessionDateInput').value = '';
        document.getElementById('sessionTimeInput').value = '';
        document.getElementById('sessionDurationInput').value = '';
        document.getElementById('sessionLocationInput').value = '';
        document.getElementById('sessionDescriptionInput').value = '';
        document.getElementById('sessionTeamSelect').value = '';

        // Clear editing state
        window.currentEditingSessionId = null;
        window.isEditingSession = false;

        // Populate team select
        const teamSelect = document.getElementById('sessionTeamSelect');
        teamSelect.innerHTML = '<option value="">Choose a team...</option>';
        if (teams.length === 0) {
          teamSelect.innerHTML += '<option disabled>No teams available</option>';
        } else {
          teams.forEach(team => {
            const option = document.createElement('option');
            option.value = team.id;
            option.textContent = team.name;
            teamSelect.appendChild(option);
          });
        }

        // Switch to add training view
        document.getElementById('trainingListView').style.display = 'none';
        document.getElementById('addTrainingView').style.display = 'block';
      });
    }

    // Back button from add training session
    const backToTrainingListBtn = document.getElementById('backToTrainingListBtn');
    if (backToTrainingListBtn) {
      backToTrainingListBtn.addEventListener('click', () => {
        document.getElementById('trainingListView').style.display = 'block';
        document.getElementById('addTrainingView').style.display = 'none';
      });
    }

    // Cancel button
    const cancelSessionBtn = document.getElementById('cancelSessionBtn');
    if (cancelSessionBtn) {
      cancelSessionBtn.addEventListener('click', () => {
        document.getElementById('trainingListView').style.display = 'block';
        document.getElementById('addTrainingView').style.display = 'none';
      });
    }

    // Save training session
    const saveSessionBtn = document.getElementById('saveSessionBtn');
    if (saveSessionBtn) {
      saveSessionBtn.addEventListener('click', async () => {
        const sessionName = document.getElementById('sessionNameInput').value.trim();
        const sessionDate = document.getElementById('sessionDateInput').value;
        const sessionTime = document.getElementById('sessionTimeInput').value;
        const duration = document.getElementById('sessionDurationInput').value;
        const location = document.getElementById('sessionLocationInput').value.trim();
        const description = document.getElementById('sessionDescriptionInput').value.trim();
        const teamId = document.getElementById('sessionTeamSelect').value;

        if (!sessionName || !sessionDate || !sessionTime || !teamId) {
          alert('Please fill in all required fields (Name, Date, Time, Team)');
          return;
        }

        try {
          const selectedTeam = teams.find(t => t.id === teamId);
          const locationLat = document.getElementById('sessionLocationLat')?.value;
          const locationLng = document.getElementById('sessionLocationLng')?.value;
          
          const sessionData = {
            coachId: currentUser.uid,
            sessionName,
            date: sessionDate,
            time: sessionTime,
            duration: parseInt(duration) || 60,
            location,
            locationLat: locationLat || null,
            locationLng: locationLng || null,
            description,
            teamId,
            teamName: selectedTeam?.name || '',
            createdAt: new Date()
          };

          if (window.isEditingSession && window.currentEditingSessionId) {
            // Update existing session
            await updateDoc(doc(db, 'trainingSessions', window.currentEditingSessionId), sessionData);
            
            // Update local array
            const index = trainingSessions.findIndex(s => s.id === window.currentEditingSessionId);
            if (index !== -1) {
              trainingSessions[index] = {
                id: window.currentEditingSessionId,
                ...sessionData
              };
            }
            
            alert('Training session updated successfully!');
          } else {
            // Create new session using addDoc
            const newSessionRef = await addDoc(collection(db, 'trainingSessions'), sessionData);
            trainingSessions.push({
              id: newSessionRef.id,
              ...sessionData
            });
            
            alert('Training session created successfully!');
          }

          // Reset form and switch back to list
          renderTrainingSessions();
          document.getElementById('trainingListView').style.display = 'block';
          document.getElementById('addTrainingView').style.display = 'none';
          window.currentEditingSessionId = null;
          window.isEditingSession = false;
        } catch (error) {
          console.error('Error saving training session:', error);
          alert('Failed to save training session: ' + error.message);
        }
      });
    }

    // ========== MAP INTEGRATION (LEAFLET/OPENSTREETMAP) ==========
    let map;
    let marker;
    let selectedLocation = null;

    // Initialize map when modal opens
    function initMap() {
      const defaultLocation = [40.7128, -74.0060]; // Default to New York [lat, lng]
      
      // Create map
      map = L.map('map').setView(defaultLocation, 13);

      // Add OpenStreetMap tiles
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 19
      }).addTo(map);

      // Add draggable marker
      marker = L.marker(defaultLocation, { draggable: true }).addTo(map);

      // Update location when marker is dragged
      marker.on('dragend', () => {
        const position = marker.getLatLng();
        selectedLocation = {
          lat: position.lat,
          lng: position.lng
        };
        reverseGeocode(position.lat, position.lng);
      });

      // Add click listener to map
      map.on('click', (e) => {
        marker.setLatLng(e.latlng);
        selectedLocation = {
          lat: e.latlng.lat,
          lng: e.latlng.lng
        };
        reverseGeocode(e.latlng.lat, e.latlng.lng);
      });

      // Request user's current location immediately
      if (navigator.geolocation) {
        // Show loading message
        const mapSearchInput = document.getElementById('mapSearchInput');
        mapSearchInput.placeholder = 'Getting your location...';
        
        navigator.geolocation.getCurrentPosition(
          (position) => {
            // Success - center on user's location
            const userLocation = [position.coords.latitude, position.coords.longitude];
            map.setView(userLocation, 15);
            marker.setLatLng(userLocation);
            selectedLocation = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };
            reverseGeocode(position.coords.latitude, position.coords.longitude);
            mapSearchInput.placeholder = 'Search for a location...';
          },
          (error) => {
            // Error or denied - use default location
            console.error('Location error:', error);
            mapSearchInput.placeholder = 'Location access denied. Search for a location...';
            alert('Please allow location access to use your current position, or search for a location manually.');
          },
          {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 0
          }
        );
      } else {
        alert('Geolocation is not supported by your browser. Please search for a location manually.');
      }
    }

    // Search for location using Nominatim (OpenStreetMap's geocoding service)
    async function searchLocation(query) {
      try {
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
        const results = await response.json();
        
        if (results.length > 0) {
          const result = results[0];
          const lat = parseFloat(result.lat);
          const lng = parseFloat(result.lon);
          
          map.setView([lat, lng], 15);
          marker.setLatLng([lat, lng]);
          selectedLocation = { lat, lng };
          document.getElementById('sessionLocationInput').value = result.display_name;
        } else {
          alert('Location not found. Try a different search term.');
        }
      } catch (error) {
        console.error('Search error:', error);
        alert('Error searching for location.');
      }
    }

    // Reverse geocode to get address from coordinates
    async function reverseGeocode(lat, lng) {
      try {
        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
        const result = await response.json();
        
        if (result.display_name) {
          document.getElementById('sessionLocationInput').value = result.display_name;
        }
      } catch (error) {
        console.error('Reverse geocode error:', error);
      }
    }

    // Open map modal
    document.getElementById('openMapBtn')?.addEventListener('click', () => {
      const mapModal = document.getElementById('mapModal');
      mapModal.style.display = 'flex';
      
      // Initialize map if not already done
      setTimeout(() => {
        if (!map) {
          initMap();
        } else {
          map.invalidateSize();
        }
      }, 100);
    });

    // Search button handler
    document.getElementById('mapSearchInput')?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        const query = e.target.value.trim();
        if (query) {
          searchLocation(query);
        }
      }
    });

    // Close map modal
    document.getElementById('closeMapBtn')?.addEventListener('click', () => {
      document.getElementById('mapModal').style.display = 'none';
    });

    document.getElementById('cancelMapBtn')?.addEventListener('click', () => {
      document.getElementById('mapModal').style.display = 'none';
    });

    // Confirm location
    document.getElementById('confirmLocationBtn')?.addEventListener('click', () => {
      if (selectedLocation) {
        document.getElementById('sessionLocationLat').value = selectedLocation.lat;
        document.getElementById('sessionLocationLng').value = selectedLocation.lng;
      }
      document.getElementById('mapModal').style.display = 'none';
    });

    // Load training sessions when training section is active
    document.querySelector('[data-section="training"]')?.addEventListener('click', () => {
      loadTrainingSessions();
    });

    // Search functionality for training sessions
    const sessionSearchInput = document.getElementById('sessionSearchInput');
    if (sessionSearchInput) {
      sessionSearchInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const sessionCards = document.querySelectorAll('#trainingSessionsList > div');
        
        sessionCards.forEach(card => {
          const sessionName = card.textContent.toLowerCase();
          if (sessionName.includes(searchTerm)) {
            card.style.display = 'flex';
          } else {
            card.style.display = 'none';
          }
        });
      });
    }

    // ========== COMPETITION SECTION ==========
    let competitions = [];
    let currentCompetitionFilter = 'all';

    // Load competitions from Firebase
    async function loadCompetitions() {
      if (!currentUser) return;
      
      try {
        const competitionsRef = collection(db, 'competitions');
        const q = query(competitionsRef, where('coachId', '==', currentUser.uid));
        const querySnapshot = await getDocs(q);
        
        competitions = [];
        querySnapshot.forEach((doc) => {
          competitions.push({
            id: doc.id,
            ...doc.data()
          });
        });
        
        renderCompetitions();
      } catch (error) {
        console.error('Error loading competitions:', error);
      }
    }

    // Render competitions list
    function renderCompetitions() {
      const competitionsList = document.getElementById('competitionsList');
      if (!competitionsList) return;
      
      competitionsList.innerHTML = '';
      
      if (competitions.length === 0) {
        competitionsList.innerHTML = '<p style="text-align:center; color:#666; padding:40px;">No competitions yet. Click "ADD COMPETITION" to create one.</p>';
        return;
      }

      // Filter competitions
      const now = new Date();
      const filteredCompetitions = competitions.filter(comp => {
        if (currentCompetitionFilter === 'all') return true;
        
        const compDate = new Date(comp.date);
        if (currentCompetitionFilter === 'upcoming') {
          return compDate >= now;
        } else if (currentCompetitionFilter === 'completed') {
          return compDate < now;
        }
        return true;
      });

      // Sort by date
      filteredCompetitions.sort((a, b) => new Date(a.date) - new Date(b.date));

      filteredCompetitions.forEach(comp => {
        const compDate = new Date(comp.date);
        const formattedDate = compDate.toLocaleDateString('en-GB', { 
          day: 'numeric',
          month: 'long',
          year: 'numeric'
        });
        
        const compCard = document.createElement('div');
        compCard.className = 'competition-card';
        compCard.innerHTML = `
          <div class="competition-actions">
            <button class="competition-action-btn edit-comp-btn" data-comp-id="${comp.id}">‚úé</button>
            <button class="competition-action-btn delete-comp-btn" data-comp-id="${comp.id}">üóë</button>
          </div>
          
          <div class="competition-team">
            <div class="competition-team-avatar">${comp.team1Name.charAt(0).toUpperCase()}</div>
            <div class="competition-team-name">${comp.team1Name}</div>
          </div>
          
          <div class="competition-details">
            <div class="competition-name">${comp.name}</div>
            <div class="competition-info">${formattedDate.toUpperCase()}</div>
            <div class="competition-info">${comp.time}</div>
            <div class="competition-info">${comp.location}</div>
          </div>
          
          <div class="competition-team">
            <div class="competition-team-avatar">${comp.opponentName.charAt(0).toUpperCase()}</div>
            <div class="competition-team-name">${comp.opponentName}</div>
          </div>
        `;
        
        competitionsList.appendChild(compCard);
      });

      // Add event listeners for edit and delete buttons
      document.querySelectorAll('.edit-comp-btn').forEach(btn => {
        btn.addEventListener('click', () => editCompetition(btn.dataset.compId));
      });

      document.querySelectorAll('.delete-comp-btn').forEach(btn => {
        btn.addEventListener('click', () => deleteCompetition(btn.dataset.compId));
      });
    }

    // Show add competition form
    const addCompetitionBtn = document.getElementById('addCompetitionBtn');
    if (addCompetitionBtn) {
      addCompetitionBtn.addEventListener('click', () => {
        // Populate Team 1 dropdown with coach's teams
        const team1Select = document.getElementById('compTeam1Input');
        team1Select.innerHTML = '<option value="">Select your team...</option>';
        teams.forEach(team => {
          const option = document.createElement('option');
          option.value = team.id;
          option.textContent = team.name;
          team1Select.appendChild(option);
        });

        // Reset form
        document.getElementById('compNameInput').value = '';
        document.getElementById('compDateInput').value = '';
        document.getElementById('compTimeInput').value = '';
        document.getElementById('compLocationInput').value = '';
        document.getElementById('compTeam1Input').value = '';
        document.getElementById('compTeam2Input').value = '';

        // Clear editing state
        window.currentEditingCompId = null;

        // Switch to add competition view
        document.getElementById('competitionListView').style.display = 'none';
        document.getElementById('addCompetitionView').style.display = 'block';
      });
    }

    // Back button from add competition
    const backToCompetitionListBtn = document.getElementById('backToCompetitionListBtn');
    if (backToCompetitionListBtn) {
      backToCompetitionListBtn.addEventListener('click', () => {
        document.getElementById('competitionListView').style.display = 'block';
        document.getElementById('addCompetitionView').style.display = 'none';
      });
    }

    // Cancel button
    const cancelCompetitionBtn = document.getElementById('cancelCompetitionBtn');
    if (cancelCompetitionBtn) {
      cancelCompetitionBtn.addEventListener('click', () => {
        document.getElementById('competitionListView').style.display = 'block';
        document.getElementById('addCompetitionView').style.display = 'none';
      });
    }

    // Save competition
    const saveCompetitionBtn = document.getElementById('saveCompetitionBtn');
    if (saveCompetitionBtn) {
      saveCompetitionBtn.addEventListener('click', async () => {
        const name = document.getElementById('compNameInput').value;
        const date = document.getElementById('compDateInput').value;
        const time = document.getElementById('compTimeInput').value;
        const location = document.getElementById('compLocationInput').value;
        const team1Id = document.getElementById('compTeam1Input').value;
        const team2 = document.getElementById('compTeam2Input').value;

        if (!name || !date || !time || !location || !team1Id || !team2) {
          alert('Please fill in all fields');
          return;
        }

        try {
          // Get the team name from the selected team ID
          const selectedTeam = teams.find(t => t.id === team1Id);
          const team1Name = selectedTeam ? selectedTeam.name : 'Unknown Team';

          const competitionData = {
            competitionName: name,
            date,
            time,
            location,
            team1Id: team1Id,
            team1Name: team1Name,
            opponentName: team2,
            coachId: currentUser.uid,
            createdAt: new Date().toISOString()
          };

          if (window.currentEditingCompId) {
            // Update existing competition
            const compRef = doc(db, 'competitions', window.currentEditingCompId);
            await updateDoc(compRef, competitionData);
            
            // Update local array
            const index = competitions.findIndex(c => c.id === window.currentEditingCompId);
            if (index !== -1) {
              competitions[index] = {
                id: window.currentEditingCompId,
                ...competitionData
              };
            }
            
            alert('Competition updated successfully!');
          } else {
            // Create new competition
            const newCompRef = await addDoc(collection(db, 'competitions'), competitionData);
            competitions.push({
              id: newCompRef.id,
              ...competitionData
            });
            
            alert('Competition created successfully!');
          }

          // Reset form and switch back to list
          renderCompetitions();
          document.getElementById('competitionListView').style.display = 'block';
          document.getElementById('addCompetitionView').style.display = 'none';
          window.currentEditingCompId = null;
        } catch (error) {
          console.error('Error saving competition:', error);
          alert('Failed to save competition: ' + error.message);
        }
      });
    }

    // Edit competition
    async function editCompetition(compId) {
      const competition = competitions.find(c => c.id === compId);
      if (!competition) return;

      // Populate form
      document.getElementById('compNameInput').value = competition.name;
      document.getElementById('compDateInput').value = competition.date;
      document.getElementById('compTimeInput').value = competition.time;
      document.getElementById('compLocationInput').value = competition.location;
      document.getElementById('compTeam1Input').value = competition.team1;
      document.getElementById('compTeam2Input').value = competition.team2;

      // Set editing state
      window.currentEditingCompId = compId;

      // Switch to edit view
      document.getElementById('competitionListView').style.display = 'none';
      document.getElementById('addCompetitionView').style.display = 'block';
    }

    // Delete competition
    async function deleteCompetition(compId) {
      if (!confirm('Are you sure you want to delete this competition?')) return;

      try {
        await deleteDoc(doc(db, 'competitions', compId));
        competitions = competitions.filter(c => c.id !== compId);
        renderCompetitions();
        alert('Competition deleted successfully!');
      } catch (error) {
        console.error('Error deleting competition:', error);
        alert('Failed to delete competition: ' + error.message);
      }
    }

    // Competition filter buttons
    const competitionFilters = document.querySelectorAll('.competition-filter');
    competitionFilters.forEach(filter => {
      filter.addEventListener('click', () => {
        competitionFilters.forEach(f => f.classList.remove('active'));
        filter.classList.add('active');
        currentCompetitionFilter = filter.dataset.filter;
        renderCompetitions();
      });
    });

    // Load competitions when competition section is active
    document.querySelector('[data-section="competition"]')?.addEventListener('click', () => {
      loadCompetitions();
    });

    // Statistics Functionality - Enhanced
    let statisticsData = {
      teams: [],
      athletes: [],
      currentView: 'teams-overview',
      currentTeam: null,
      currentPlayer: null
    };

    // Initialize statistics when section is accessed
    async function initializeStatistics() {
      try {
        await loadStatisticsData();
        showTeamsOverview();
      } catch (error) {
        console.error('Error initializing statistics:', error);
      }
    }

    // Load teams and athletes data
    async function loadStatisticsData() {
      try {
        await loadTeams();
        statisticsData.teams = teams;
        
        // Ensure athletes are loaded
        if (!athletes || athletes.length === 0) {
          await fetchAthletes();
        }
        statisticsData.athletes = athletes || [];
        
        console.log('Statistics data loaded:', {
          teams: statisticsData.teams.length,
          athletes: statisticsData.athletes.length
        });
      } catch (error) {
        console.error('Error loading statistics data:', error);
        statisticsData.teams = teams || [];
        statisticsData.athletes = athletes || [];
      }
    }

    // Show teams overview
    function showTeamsOverview() {
      statisticsData.currentView = 'teams-overview';
      document.getElementById('teams-overview-view').style.display = 'block';
      document.getElementById('team-stats-detail-view').style.display = 'none';
      document.getElementById('player-stats-detail-view').style.display = 'none';
      renderSimpleTeamsList();
    }

    // Show team detail view
    function showTeamDetail(teamId) {
      const team = statisticsData.teams.find(t => t.id === teamId);
      if (!team) return;

      statisticsData.currentTeam = team;
      statisticsData.currentView = 'team-detail';
      
      document.getElementById('teams-overview-view').style.display = 'none';
      document.getElementById('team-stats-detail-view').style.display = 'block';
      document.getElementById('player-stats-detail-view').style.display = 'none';
      
      renderTeamDetail(team);
    }

    // Show player detail view
    function showPlayerDetail(playerId) {
      const player = statisticsData.athletes.find(a => a.id === playerId);
      if (!player) return;

      statisticsData.currentPlayer = player;
      statisticsData.currentView = 'player-detail';
      
      document.getElementById('teams-overview-view').style.display = 'none';
      document.getElementById('team-stats-detail-view').style.display = 'none';
      document.getElementById('player-stats-detail-view').style.display = 'block';
      
      renderPlayerDetail(player);
    }

    // Navigation functions
    function backToTeamsOverview() {
      showTeamsOverview();
    }

    function backToTeamDetail() {
      if (statisticsData.currentTeam) {
        showTeamDetail(statisticsData.currentTeam.id);
      } else {
        showTeamsOverview();
      }
    }

    // Render simple teams list with click functionality
    function renderSimpleTeamsList() {
      const container = document.getElementById('simpleTeamsList');
      if (!container) return;

      container.innerHTML = '';

      if (statisticsData.teams.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: #666; padding: 40px;">No teams created yet</div>';
        return;
      }

      statisticsData.teams.forEach(team => {
        // Use memberIds array length instead of members array
        const totalMembers = team.memberIds ? team.memberIds.length : 0;
        
        const teamItem = document.createElement('div');
        teamItem.className = 'simple-team-item';
        teamItem.onclick = () => showTeamDetail(team.id);
        
        // Create team avatar
        const avatarHtml = team.image && team.image !== 'assets/coach.png' ? 
          `<div class="simple-team-avatar"><img src="${team.image}" alt="${team.name}" /></div>` :
          `<div class="simple-team-avatar no-image">${team.name.substring(0, 2).toUpperCase()}</div>`;
        
        teamItem.innerHTML = `
          ${avatarHtml}
          <div class="simple-team-info">
            <div class="simple-team-name">${team.name}</div>
            <div class="simple-team-members">${totalMembers} Members</div>
          </div>
        `;

        container.appendChild(teamItem);
      });
    }

    // Render team detail view
    function renderTeamDetail(team) {
      document.getElementById('teamDetailTitle').textContent = team.name;
      
      // Hide charts and show placeholders since no training data exists
      const charts = ['avgPointsChart', 'teamTrendChart'];
      const placeholders = ['avgPointsPlaceholder', 'teamTrendPlaceholder'];
      
      charts.forEach(chartId => {
        const chart = document.getElementById(chartId);
        if (chart) chart.style.display = 'none';
      });
      
      placeholders.forEach(placeholderId => {
        const placeholder = document.getElementById(placeholderId);
        if (placeholder) placeholder.style.display = 'flex';
      });
      
      // Render team members list
      renderTeamMembersList(team);
    }

    // Render team members list
    function renderTeamMembersList(team) {
      const container = document.getElementById('teamMembersStatsList');
      if (!container) return;

      container.innerHTML = '';

      if (!team.memberIds || team.memberIds.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px; grid-column: 1/-1;">No members assigned to this team</div>';
        return;
      }

      // Ensure we have athletes data
      if (!statisticsData.athletes || statisticsData.athletes.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px; grid-column: 1/-1;">Loading team members...</div>';
        // Try to reload athletes
        fetchAthletes().then(() => {
          statisticsData.athletes = athletes || [];
          renderTeamMembersList(team); // Re-render after loading
        });
        return;
      }

      console.log('Team memberIds:', team.memberIds);
      console.log('Available athletes:', statisticsData.athletes);

      // Get member details from athletes array
      const teamMembers = team.memberIds.map(memberId => {
        const member = statisticsData.athletes.find(athlete => athlete.id === memberId);
        if (!member) {
          console.warn(`Member with ID ${memberId} not found in athletes list`);
        }
        return member;
      }).filter(member => member); // Remove any undefined members

      console.log('Found team members:', teamMembers);

      if (teamMembers.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px; grid-column: 1/-1;">Team members not found in athlete database</div>';
        return;
      }

      teamMembers.forEach(member => {
        const memberRow = document.createElement('div');
        memberRow.className = 'member-stats-row';
        memberRow.onclick = () => showPlayerDetail(member.id);
        
        memberRow.innerHTML = `
          <div class="member-col">${member.name || 'Unknown'}</div>
          <div class="member-col">${member.studentId || member.email || 'N/A'}</div>
          <div class="member-col">${member.position || member.sport || 'N/A'}</div>
          <div class="member-col">
            <button class="view-btn" onclick="event.stopPropagation(); showPlayerDetail('${member.id}')">View</button>
          </div>
        `;

        container.appendChild(memberRow);
      });
    }

    // Render player detail view
    function renderPlayerDetail(player) {
      document.getElementById('playerDetailTitle').textContent = player.name || 'Unknown Player';
      
      // Render basic info
      const basicInfo = document.getElementById('playerBasicInfo');
      if (basicInfo) {
        basicInfo.innerHTML = `
          <span>Email: ${player.email || 'N/A'}</span>
          <span>Sport: ${player.sport || 'N/A'}</span>
          <span>Student ID: ${player.studentId || player.email || 'N/A'}</span>
        `;
      }
      
      // Hide charts and show placeholders since no training data exists
      const charts = ['playerPointsChart', 'playerAvgChart'];
      const placeholders = ['playerPointsPlaceholder', 'playerAvgPlaceholder'];
      
      charts.forEach(chartId => {
        const chart = document.getElementById(chartId);
        if (chart) chart.style.display = 'none';
      });
      
      placeholders.forEach(placeholderId => {
        const placeholder = document.getElementById(placeholderId);
        if (placeholder) placeholder.style.display = 'flex';
      });
      
      // Render empty stats table
      renderPlayerStatsTable(player);
    }

    // Render player stats table
    function renderPlayerStatsTable(player) {
      const container = document.getElementById('playerStatsTableBody');
      if (!container) return;

      container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px; grid-column: 1/-1;">No training sessions recorded yet</div>';
    }

    // Global navigation functions
    window.showTeamsOverview = showTeamsOverview;
    window.showTeamDetail = showTeamDetail;
    window.showPlayerDetail = showPlayerDetail;
    window.backToTeamsOverview = backToTeamsOverview;
    window.backToTeamDetail = backToTeamDetail;

    // Load statistics when statistics section is accessed
    document.querySelector('[data-section="statistics"]')?.addEventListener('click', () => {
      initializeStatistics();
    });

    // Session members back button functionality
    document.addEventListener('DOMContentLoaded', function() {
      const backBtn = document.getElementById('backToSessionsBtn');
      
      if (backBtn) {
        backBtn.addEventListener('click', () => {
          document.getElementById('sessionMembersSection').style.display = 'none';
          document.getElementById('trainingListView').style.display = 'block';
        });
      }
    });
  </script>
</body>
</html>

